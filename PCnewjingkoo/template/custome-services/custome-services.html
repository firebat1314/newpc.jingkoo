<div class="custome-services">
   <div class="aio" id="webim_demo">

      <div class="sesspart">
         <div class="titlebar">
            <img id="p_my_face">
            <p id="t_my_name"></p>
            <!-- <ul id="t_my_menu">
                  <li>菜单
                     <ul>
                        <li>最近联系人
                           <ul>
                              <li id="getRecentContactListMenu" onclick="getRecentContactList()">最近联系人</li>
                           </ul>
                        </li>
                        <li>好友申请
                           <ul>
                              <li id="getPendencyMenu" onclick="getPendency(false)">查看好友申请</li>
                           </ul>
                        </li>
                        <li>好友
                           <ul>
                              <li id="searchProfileByUserIdMenu" onclick="searchProfileByUserIdClick()">搜索用户</li>
                              <li id="getAllFriendMenu" onclick="getMyFriend()">我的好友</li>
                           </ul>
                        </li>
                        <li>黑名单
                           <ul>
                              <li id="getBlackListMenu" onclick="getBlackList()">我的黑名单</li>
                           </ul>
                        </li>
                        <li>群组申请
                           <ul>
                              <li id="getApplyJoinGroupPendencyMenu" onclick="getApplyJoinGroupPendency()">查看加群申请</li>
                           </ul>
                        </li>
                        <li>群组
                           <ul>
                              <li id="searchGroupByNameMenu" onclick="searchGroupByNameMenuClick()">搜索群组(按名称)</li>
                              <li id="searchGroupMenu" onclick="searchGroupMenuClick()">搜索群组(按ID)</li>
                              <li id="createGroupMenu" onclick="createGroupMenuClick()">创建群组</li>
                              <li id="getMyGroupMenu" onclick="getMyGroup()">我的群组</li>
                              <li id="sendCustomGroupNofifyMenu" onclick="showSendCustomGroupNotifyDialog()">发送群自定义通知</li>
                           </ul>
                        </li>
                        <li>系统消息
                           <ul>
                              <li id="getMyGroupSystemsMenu" onclick="getMyGroupSystemMsgs()">我的群组系统消息</li>
                              <li id="getMyFriendSystemsMenu" onclick="getMyFriendSystemMsgs()">我的好友系统消息</li>
                              <li id="getMyProfileSystemsMenu" onclick="getMyProfileSystemMsgs()">我的资料系统消息</li>
                           </ul>
                        </li>
                        <li>图片
                           <ul>
                              <li id="uploadPicByBase64Menu" onclick="uploadPicByBase64()">上传图片(Base64)</li>
                           </ul>
                        </li>
                        <li>设置
                           <ul>
                              <li id="setProfilePortraitMenu" onclick="setProfilePortraitClick()">个人资料</li>
                              <li id="quitMenu" onclick="quitClick()">退出</li>
                           </ul>
                        </li>
                     </ul>
                  </li>
               </ul> -->
         </div>
         <div class="accordion" id="accordionContact">
            <div class="accordion-group">
               <!-- <div class="accordion-heading">
                  <a class="accordion-toggle" data-parent="#accordionContact" data-toggle="collapse" href="#collapseRecentSession">
                     最近联系人
                  </a>
               </div> -->
               <div class="accordion-body collapse in" id="collapseRecentSession">
                  <div class="sesslist"></div>
               </div>
            </div>
            <!-- <div class="accordion-group">
               <div class="accordion-heading">
                  <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordionContact" href="#collapseFriend">
                     我的好友
                  </a>
               </div>
               <div id="collapseFriend" class="accordion-body collapse">
                  <div class="sesslist">
                  </div>
               </div>
            </div>
            <div class="accordion-group">
               <div class="accordion-heading">
                  <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordionContact" href="#collapseGroup">
                     我的群组
                  </a>
               </div>
               <div id="collapseGroup" class="accordion-body collapse">
                  <div class="sesslist-group">
                  </div>
               </div>
            </div> -->
         </div>
      </div>
      <div class="chatpart">
         <div class="chatpart-head">
            <img id="p_friend_face">
            <div id="p_friend_name"></div>
         </div>
         <div class="chatpart-body">
            <div class="chatpart-body-l">
               <div class="msgflow"></div>
               <span id="msg_end" style="overflow:hidden"></span>
               <div class="editbar">
                  <a class="chat02_title_btn ctb01" onclick="showEmotionDialog()" title="选择表情">
                     <i class="iconfont icon-biaoqing"></i>
                  </a>
                  <a class="chat02_title_btn ctb03" href="javascript:;" onclick="selectPicClick()" title="选择图片">
                     <i class="iconfont icon-tupian"></i>
                  </a>
                  <a class="chat02_title_btn ctb05" href="javascript:;" onclick="selectFileClick()" title="选择文件">
                     <i class="iconfont icon-wenjian1"></i>
                  </a>
                  <!-- <a class="chat02_title_btn ctb04" href="javascript:;" onclick="showEditCustomMsgDialog()" title="发送自定义消息">
                     <i class="iconfont icon-pinglun"></i>
                  </a> -->
                  <div class="wl_faces_box" id="wl_faces_box">
                     <div class="wl_faces_content">
                        <div class="title">
                           <ul>
                              <li class="title_name">常用表情</li>
                              <li class="wl_faces_close">
                                 <span onclick='turnoffFaces_box()'>&nbsp;</span>
                              </li>
                           </ul>
                        </div>
                        <div class="wl_faces_main" id="wl_faces_main">
                           <ul id="emotionUL"></ul>
                        </div>
                     </div>
                     <div class="wlf_icon"></div>
                  </div>
               </div>
               <textarea class="msgedit" cols="82" id="send_msg_text" onkeydown="onTextareaKeyDown(event)" rows="5"></textarea>
               <div class="sendbar">
                  <button class="sendbtn" onclick="onSendMsg()" type="button">发送</button>
                  <button class="closebtn" onclick="onClose()" type="button">关闭</button>
               </div>
            </div>
            <div class="chatpart-body-r">
               <div class="supplier-info">
                  <!-- <div class="looking"></div>
                        <div class="order"></div>
                        <div class="supplier"></div> -->
                  <div class="tab1">
                     <ul class="tab">
                        <li class="looking cur">正在查询</li>
                        <!-- <li class="order">我的订单</li> -->
                        <li class="supplier">店铺信息</li>
                     </ul>
                     <div class="box looking-box on">
                        <div class="goods_head">
                           <div class="img"><img src="{{goodsData.data.goods_thumb}}" alt=""></div>
                           <div class="name">{{goodsData.data.goods_name}}</div>
                        </div>
                        <div class="item">
                           <span class="key">商品价格：</span>
                           <span class="value price">{{goodsData.data.market_price_formated}}</span>
                        </div>
                        <!-- <div class="item">
                           <span class="key">促销信息：</span>
                           <span class="value"></span>
                        </div>
                        <div class="item">
                           <span class="key">服　　务：</span>
                           <span class="value"></span>
                        </div> -->
                     </div>
                     <!-- <div class="box order-box">

                     </div> -->
                     <div class="box supplier-box">

                        <div class="item">
                           <span class="key">店铺名称：</span>
                           <span class="value">{{supplierData.data.name || '暂无信息'}}</span>
                        </div>
                        <!-- <div class="item">
                           <span class="key">店铺评分：</span>
                           <span class="value">{{supplierData.data.region || '暂无信息'}}</span>
                        </div> -->
                        <div class="item">
                           <span class="key">联系电话：</span>
                           <span class="value">{{'暂无信息'}}</span>
                        </div>
                     </div>
                  </div>
                  <div class="tab2">
                     <ul class="tab">
                        <li class="history cur">最近浏览</li>
                        <li class="recommend">店铺推荐</li>
                     </ul>
                     <div class="box history-box on">
                        <div class="goods_list">
                           <div class="goods" ng-repeat="item in historyData.data">
                              <div class="img"><img src="{{item.goods_thumb}}" alt=""></div>
                              <div class="info">
                                 <div class="name">{{item.goods_name}}</div>
                                 <div class="pp">
                                    <div class="price">{{item.format_shop_price}}</div>
                                    <button class="sendbtn" ng-click="sendgoods(item.goods_id)">发送</button>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                     <div class="box recommend-box">
                        <div class="goods_list">
                           <div class="goods" ng-repeat="item in recommendData.data">
                              <div class="img"><img src="{{item.thumb}}" alt=""></div>
                              <div class="info">
                                 <div class="name">{{item.goods_name}}</div>
                                 <div class="pp">
                                    <div class="price">{{item.format_shop_price}}</div>
                                    <button class="sendbtn" ng-click="sendgoods(item.goods_id)">发送</button>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="bottom"></div>
   </div>
   <div aria-hidden="true" aria-labelledby="search_profile_dialog_label" class="modal fade" data-backdrop="static" id="search_profile_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="search_profile_dialog_label">搜索用户</h4>
            </div>
            <div class="modal-body">
               <form class="form-inline" id="sp_form" name="sp_form" role="form">
                  <div class="form-group">
                     <label class="sr-only" for="sp_to_account">帐号</label>
                     <input class="form-control" id="sp_to_account" maxlength="50" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入用户ID" type="text">
                  </div>
                  <button class="btn btn-default" onclick="searchProfileByUserId()" type="button">搜索</button>
               </form>
               <table id="search_profile_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="add_friend_dialog_label" class="modal fade" data-backdrop="static" id="add_friend_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="add_friend_dialog_label">申请加好友</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" role="form">
                  <input id="af_allow_type" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="af_to_account">对方帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="af_to_account" placeholder="请输入对方帐号" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="af_add_wording">附言</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="af_add_wording" rows="3">你好，我想和你成为朋友~~</textarea>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="applyAddFriend()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_my_friend_dialog_label" class="modal fade" data-backdrop="static" id="get_my_friend_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_my_friend_dialog_label">我的好友</h4>
            </div>
            <div class="modal-body">
               <table id="get_my_friend_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="delete_friend_dialog_label" class="modal fade" data-backdrop="static" id="delete_friend_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="delete_friend_dialog_label">删除好友</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="df_sel_row_index" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="df_to_account">对方帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="df_to_account" placeholder="请输入对方帐号" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="df_type_radio">操作</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input checked id="df_type_both_radio" name="df_type_radio" type="radio" value="Delete_Type_Both"> 双向删除</label>
                        <label class="radio-inline">
                           <input id="df_type_single_radio" name="df_type_radio" type="radio" value="Delete_Type_Single"> 单向删除</label>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="deleteFriend()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_black_list_dialog_label" class="modal fade" data-backdrop="static" id="get_black_list_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_black_list_dialog_label">我的黑名单</h4>
            </div>
            <div class="modal-body">
               <table id="get_black_list_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_recent_contact_list_dialog_label" class="modal fade" data-backdrop="static" id="get_recent_contact_list_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_recent_contact_list_dialog_label">我的最近联系人</h4>
            </div>
            <div class="modal-body">
               <table id="get_recent_contact_list_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="set_profile_portrait_label" class="modal fade" data-backdrop="static" id="set_profile_portrait_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="set_profile_portrait_label">设置个人资料</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="spp_form" name="spp_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="spp_image">头像URL</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="spp_image" maxlength="100" placeholder="请输入头像URL" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="spp_nick">昵称</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="spp_nick" maxlength="20" placeholder="请输入昵称" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="spp_gender_radio">性别</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input id="spp_gender_male_radio" name="spp_gender_radio" type="radio" value="Gender_Type_Male"> 男</label>
                        <label class="radio-inline">
                           <input id="spp_gender_female_radio" name="spp_gender_radio" type="radio" value="Gender_Type_Female"> 女</label>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="spp_allow_type_radio">加好友设置</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input id="spp_allow_type_need_confirm_radio" name="spp_allow_type_radio" type="radio" value="AllowType_Type_NeedConfirm"> 需要确认</label>
                        <label class="radio-inline">
                           <input id="spp_allow_type_allow_any_radio" name="spp_allow_type_radio" type="radio" value="AllowType_Type_AllowAny"> 允许任何人</label>
                        <label class="radio-inline">
                           <input id="spp_allow_type_deny_any_radio" name="spp_allow_type_radio" type="radio" value="AllowType_Type_DenyAny"> 拒绝任何人</label>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="setProfilePortrait()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_pendency_dialog_label" class="modal fade" data-backdrop="static" id="get_pendency_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_pendency_dialog_label">我的好友申请</h4>
            </div>
            <div class="modal-body">
               <table id="get_pendency_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <!-- 模态框（Modal） -->
   <div aria-hidden="true" aria-labelledby="response_friend_dialog_label" class="modal fade" data-backdrop="static" id="response_friend_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="response_friend_dialog_label">处理好友申请</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="rf_to_account">对方帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="rf_to_account" placeholder="请输入对方帐号" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="rf_action_radio">操作</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input checked id="rf_action_agree_and_add_radio" name="rf_action_radio" type="radio" value="Response_Action_AgreeAndAdd"> 同意并添加对方为好友</label>
                        <label class="radio-inline">
                           <input id="rf_action_agree_radio" name="rf_action_radio" type="radio" value="Response_Action_Agree"> 同意</label>
                        <label class="radio-inline">
                           <input id="rf_action_reject_radio" name="rf_action_radio" type="radio" value="Response_Action_Reject"> 拒绝</label>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="responseFriend()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="create_group_dialog_label" class="modal fade" data-backdrop="static" id="create_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="create_group_dialog_label">创建一个群</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="cg_form" name="cg_form" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label">已选好友</label>
                     <div class="col-sm-8">
                        <!--<input type="text" class="form-control" id="select_friends" value=""
                                     placeholder="已选好友列表" readonly="readonly">-->
                        <textarea class="form-control" id="select_friends" readonly="readonly" rows="3"></textarea>
                     </div>
                     <div class="col-sm-2">
                        <button class="btn btn-primary" onclick="selectMyFriendGroup()" type="button">选择(选填)</button>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_id">自定义ID</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="cg_id" maxlength="30" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入自定义群ID" type="text" value="">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_type_radio">类型</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input checked id="cg_type_chat_room_radio" name="cg_type_radio" type="radio" value="ChatRoom"> 聊天室</label>
                        <label class="radio-inline">
                           <input id="cg_type_public_radio" name="cg_type_radio" type="radio" value="Public"> 公开群</label>
                        <label class="radio-inline">
                           <input id="cg_type_private_radio" name="cg_type_radio" type="radio" value="Private"> 私有群
                           <!--私有群即讨论组-->
                        </label>
                        <label class="radio-inline">
                           <input id="cg_type_avchatroom_radio" name="cg_type_radio" type="radio" value="AVChatRoom"> 直播聊天室</label>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_ajp_type_radio">加群方式</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input checked id="cg_ajp_type_fa_radio" name="cg_ajp_type_radio" type="radio" value="FreeAccess"> 自由加入</label>
                        <label class="radio-inline">
                           <input checked id="cg_ajp_type_np_radio" name="cg_ajp_type_radio" type="radio" value="NeedPermission"> 需要验证</label>
                        <label class="radio-inline">
                           <input id="cg_ajp_type_da_radio" name="cg_ajp_type_radio" type="radio" value="DisableApply"> 禁止加群</label>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_faceurl">群头像URL</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="cg_faceurl" maxlength="100" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入群头像URL" type="text" value="">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_name">名称</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="cg_name" maxlength="30" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入群名称" type="text" value="">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_notification">公告</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="cg_notification" rows="3"></textarea>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="cg_introduction">简介</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="cg_introduction" rows="3"></textarea>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="createGroup()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="select_my_friend_group_dialog_label" class="modal fade" data-backdrop="static" id="select_my_friend_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="select_my_friend_group_dialog_label">选择好友建群</h4>
            </div>
            <div class="modal-body">
               <table id="select_my_friend_group_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="search_group_dialog_label" class="modal fade" data-backdrop="static" id="search_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-full">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="search_group_dialog_label">搜索群(按ID)</h4>
            </div>
            <div class="modal-body">
               <form class="form-inline" id="sg_form" name="sg_form" role="form">
                  <div class="form-group">
                     <label class="sr-only" for="sg_group_id">群ID</label>
                     <input class="form-control" id="sg_group_id" maxlength="20" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入群ID" type="text" value="">
                  </div>
                  <button class="btn btn-default" onclick="getGroupPublicInfo()" type="button">搜索</button>
               </form>
               <table id="search_group_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="search_group_by_name_dialog_label" class="modal fade" data-backdrop="static" id="search_group_by_name_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-full">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="search_group_by_name_dialog_label">搜索群(按名称)</h4>
            </div>
            <div class="modal-body">
               <form class="form-inline" id="sgbn_form" name="sgbn_form" role="form">
                  <div class="form-group">
                     <label class="sr-only" for="sgbn_group_name">群名称</label>
                     <input class="form-control" id="sgbn_group_name" maxlength="50" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入群名称(完全匹配)" type="text" value="">
                  </div>
                  <button class="btn btn-default" onclick="searchGroupByName()" type="button">搜索</button>
               </form>
               <table id="search_group_by_name_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="apply_join_group_dialog_label" class="modal fade" data-backdrop="static" id="apply_join_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="apply_join_group_dialog_label">申请加群</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="ajg_form" name="ajg_form" role="form">
                  <input id="ajg_group_id" type="hidden">
                  <input id="ajg_group_type" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="ajg_group_name">群名称</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="ajg_group_name" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="ajg_apply_msg">附言</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="ajg_apply_msg" maxlength="50" placeholder="请输入附言" type="text" value="你好，我想加入贵群~">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="applyJoinGroup()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_my_group_dialog_label" class="modal fade" data-backdrop="static" id="get_my_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_my_group_dialog_label">我的群组</h4>
            </div>
            <div class="modal-body">
               <table id="get_my_group_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="modify_group_msg_flag_dialog_label" class="modal fade" data-backdrop="static" id="modify_group_msg_flag_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="modify_group_msg_flag_dialog_label">修改群消息提示</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="mgmf_form" name="mgmf_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="mgmf_sel_row_index" type="hidden">
                  <input id="mgmf_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="mgmf_msg_flag_radio">群消息提示类型</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input id="mgmf_mf_aan_radio" name="mgmf_msg_flag_radio" type="radio" value="AcceptAndNotify"> 接收并提示</label>
                        <label class="radio-inline">
                           <input id="mgmf_mf_ann_radio" name="mgmf_msg_flag_radio" type="radio" value="AcceptNotNotify"> 接收不提示</label>
                        <label class="radio-inline">
                           <input id="mgmf_mf_d_radio" name="mgmf_msg_flag_radio" type="radio" value="Discard"> 屏蔽</label>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="modifyGroupMsgFlag()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_group_member_dialog_label" class="modal fade" data-backdrop="static" id="get_group_member_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_group_member_dialog_label">群组成员</h4>
            </div>
            <div class="modal-body">
               <input id="ggm_group_id" type="hidden">
               <input id="ggm_my_role" type="hidden">
               <input id="ggm_group_type" type="hidden">
               <table id="get_group_member_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="modify_group_member_dialog_label" class="modal fade" data-backdrop="static" id="modify_group_member_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="modify_group_member_dialog_label">修改群成员角色</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="mgm_form" name="mgm_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="mgm_sel_row_index" type="hidden">
                  <input id="mgm_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="mgm_account">成员帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="mgm_account" placeholder="请输入要修改的成员帐号" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group" id="mgm_role_div">
                     <label class="col-sm-2 control-label" for="mgm_role_radio">群角色</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input id="mgm_role_admin_radio" name="mgm_role_radio" type="radio" value="Admin"> 管理员</label>
                        <label class="radio-inline">
                           <input id="mgm_role_member_radio" name="mgm_role_radio" type="radio" value="Member"> 成员</label>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="modifyGroupMemberRole()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="delete_group_member_dialog_label" class="modal fade" data-backdrop="static" id="delete_group_member_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="delete_group_member_dialog_label">删除群成员</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="dgm_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="dgm_account">成员帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="dgm_account" placeholder="请输入要删除成员帐号" readonly="readonly" type="text">
                     </div>
                  </div>
                  <!--<div class="form-group">
                          <label for="dgm_silence_radio" class="col-sm-2 control-label">是否静默删除</label>
                          <div class="col-sm-10">
  
                              <label class="radio-inline">
                                  <input type="radio" name="dgm_silence_radio" id="dgm_silence_yes_radio"
                                         value="1" checked> 是
                              </label>
                              <label class="radio-inline">
                                  <input type="radio" name="dgm_silence_radio" id="dgm_silence_no_radio"
                                         value="0"> 否
                              </label>
  
                          </div>
                      </div>-->
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="deleteGroupMember()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <!-- 模态框（Modal） -->
   <div aria-hidden="true" aria-labelledby="handle_invite_join_group_request_label" class="modal fade" data-backdrop="static" id="handle_invite_join_group_request" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="handle_invite_join_group_request_label">处理被邀请进群申请</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="hijg_authentication" type="hidden">
                  <input id="hijg_msg_key" type="hidden">
                  <input id="hijg_user_defined_field" type="hidden">
                  <input id="hijg_from_account" type="hidden">
                  <input id="hijg_msg_seq" type="hidden">
                  <input id="hijg_msg_random" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hijg_group_id">群ID</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="hijg_group_id" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hijg_to_account">邀请人</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="hijg_to_account" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hijg_action_radio">操作</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input checked id="hijg_action_agree_radio" name="hijg_action_radio" type="radio" value="Agree"> 同意</label>
                        <label class="radio-inline">
                           <input id="hijg_action_reject_radio" name="hijg_action_radio" type="radio" value="Reject"> 拒绝</label>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hijg_approval_msg">附言</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="hijg_approval_msg" rows="3"></textarea>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="handleInviteJoinGroupRequest()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="modify_group_dialog_label" class="modal fade" data-backdrop="static" id="modify_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="modify_group_dialog_label">修改群基本资料</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="mg_form" name="mg_form" role="form">
                  <input id="mg_sel_row_index" type="hidden">
                  <input id="mg_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="mg_faceurl">群头像URL</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="mg_faceurl" maxlength="100" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入群头像URL" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="mg_name">名称</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="mg_name" maxlength="30" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入群名称" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="mg_notification">公告</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="mg_notification" rows="3"></textarea>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="mg_introduction">简介</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="mg_introduction" rows="3"></textarea>
                     </div>
                  </div>
                  <div class="form-group" id="shut_up_all_role_div">
                     <label class="col-sm-2 control-label" for="shut_up_all">群全局禁言</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input id="shut_up_all_member_On" name="mgm_up_all_radio" type="radio" value="On"> 全局禁言</label>
                        <label class="radio-inline">
                           <input id="shut_up_all_member_Off" name="mgm_up_all_radio" type="radio" value="Off"> 取消禁言</label>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="modifyGroup()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="change_group_owner_dialog_label" class="modal fade" data-backdrop="static" id="change_group_owner_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="change_group_owner_dialog_label">转让群组</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="cgo_form" name="cgo_form" role="form">
                  <input id="cgo_sel_row_index" type="hidden">
                  <input id="cgo_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-4 control-label" for="cgo_new_owner">新群主账号</label>
                     <div class="col-sm-8">
                        <input class="form-control" id="cgo_new_owner" maxlength="50" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入新群主ID" type="text">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="changeGroupOwner()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_my_friend_group_dialog_label" class="modal fade" data-backdrop="static" id="get_my_friend_group_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_my_friend_group_dialog_label">我的好友</h4>
            </div>
            <div class="modal-body">
               <input id="gmfg_group_id" type="hidden">
               <table id="get_my_friend_group_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="add_group_member_dialog_label" class="modal fade" data-backdrop="static" id="add_group_member_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="add_group_member_dialog_label">邀请群成员</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="agm_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="agm_account">成员帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="agm_account" placeholder="请输入要邀请成员帐号" readonly="readonly" type="text">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="addGroupMember()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="forbid_send_msg_dialog_label" class="modal fade" data-backdrop="static" id="forbid_send_msg_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="forbid_send_msg_dialog_label">设置成员禁言时间</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="fsm_form" name="fsm_form" role="form">
                  <input id="fsm_sel_row_index" type="hidden">
                  <input id="fsm_group_id" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="fsm_account">成员帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="fsm_account" placeholder="请输入要修改的成员帐号" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="fsm_shut_up_time">禁言时间(s)</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="fsm_shut_up_time" maxlength="8" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入禁言时间" type="text">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="forbidSendMsg()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="send_c2c_msg_dialog_label" class="modal fade" data-backdrop="static" id="send_c2c_msg_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="send_c2c_msg_dialog_label">发C2C消息</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="scm_form" name="scm_form" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="scm_to_account">好友账号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="scm_to_account" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="scm_content">内容</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="scm_content" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入消息内容" type="text">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="sendC2cMsg()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="send_group_msg_dialog_label" class="modal fade" data-backdrop="static" id="send_group_msg_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="send_group_msg_dialog_label">发群消息</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="sgm_form" name="sgm_form" role="form">
                  <input id="sgm_to_group_name" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="sgm_to_groupid">群ID</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="sgm_to_groupid" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="sgm_content">内容</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="sgm_content" onkeydown="if(event.keyCode==13)return false;" placeholder="请输入消息内容" type="text">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="sendGroupMsg()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="select_app_dialog_label" class="modal" data-backdrop="static" id="select_app_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <h4 class="modal-title" id="select_app_dialog_label">腾讯开放IM Web Demo(V1.7)</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <div class="col-sm-5">
                        <label class="radio-inline">
                           <input checked id="at_demo_radio" name="app_type_radio" onclick="changeAppType(this)" type="radio" value="1">测试应用</label>
                     </div>
                     <div class="col-sm-5">
                        <label class="radio-inline">
                           <input id="at_myself_radio" name="app_type_radio" onclick="changeAppType(this)" type="radio" value="0"> 自建应用</label>
                     </div>
                  </div>
                  <div class="form-group">
                     <div class="col-sm-9">
                        <label id="demo_type_desc">无需注册腾讯云帐号直接使用，适合只需快速体验开放IM的用户</label>
                        <label id="myself_type_desc">需注册腾讯云官帐号，并创建应用获取SdkAppId，适合需在Demo基础上进行修改调试的用户。
                           <a href="http://console.qcloud.com/avc/" id="qcloudLink" target="_blank">现在创建&gt;&gt;</a>
                        </label>
                     </div>
                  </div>
                  <div class="form-group" id="sdkAppIdDiv">
                     <label class="col-sm-2 control-label" for="sdk_app_id">SdkAppId:</label>
                     <div class="col-sm-6">
                        <input class="form-control" id="sdk_app_id" placeholder="请输入SdkAppId" type="text" value="">
                     </div>
                  </div>
                  <div class="form-group" id="accountTypeDiv">
                     <label class="col-sm-2 control-label" for="account_type">AccountType:</label>
                     <div class="col-sm-6">
                        <input class="form-control" id="account_type" placeholder="请输入AccountType" type="text" value="">
                     </div>
                  </div>
                  <div class="form-group" id="accountModeDiv" style="display:none">
                     <label class="col-sm-2 control-label" for="account_type">集成模式:</label>
                     <div class="col-sm-6" style="padding-top:5px">
                        <input name="accountMode" type="radio" value="0">独立模式
                        <input checked name="accountMode" type="radio" value="1">托管模式
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-primary" onclick="selectApp()" type="button">确认</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="login_dialog_label" class="modal fade" data-backdrop="static" id="login_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="login_dialog_label">登录</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="login_account">identifier</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="login_account" maxlength="100" placeholder="请输入identifier" type="text" value="">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="login_pwd">UserSig</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="login_pwd" placeholder="请输入UserSig" type="password" value="">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="independentModeLogin()" type="button">确定</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="upload_pic_low_ie_dialog_label" class="modal fade" data-backdrop="static" id="upload_pic_low_ie_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="upload_pic_low_ie_dialog_label">发送图片</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" enctype="multipart/form-data" id="updli_form" name="updli_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="File">选择</label>
                     <div class="col-sm-10">
                        <input id="updli_file" type="file">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="uploadPicLowIE()" type="button">发送</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="upload_file_low_ie_dialog_label" class="modal fade" data-backdrop="static" id="upload_file_low_ie_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="upload_file_low_ie_dialog_label">发送文件</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" enctype="multipart/form-data" id="updli_file_form" name="updli_file_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="File">选择</label>
                     <div class="col-sm-10">
                        <input id="upload_low_ie_file" type="file">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="uploadFileLowIE()" type="button">发送</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="upload_pic_dialog_label" class="modal fade" data-backdrop="static" id="upload_pic_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="upload_pic_dialog_label">发送图片</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="upd_form" name="upd_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="File">选择</label>
                     <div class="col-sm-10">
                        <input id="upd_pic" onchange="fileOnChange(this)" type="file">
                        <!--<input type="button" value="停止" id="upd_abort" />-->
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="File">预览</label>
                     <div class="col-sm-10">
                        <div id="previewPicDiv"></div>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="upd_progress">进度</label>
                     <div class="col-sm-10">
                        <progress id="upd_progress" max="100" value="0"></progress>
                        <!--<input type="text" id="upd_progress" value="0" name="upd_progress" />-->
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="uploadPic()" type="button">发送</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="upload_file_dialog_label" class="modal fade" data-backdrop="static" id="upload_file_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="upload_file_dialog_label">发送文件</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="upd_file_form" name="upd_file_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="File">选择</label>
                     <div class="col-sm-10">
                        <input id="upd_file" type="file">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="upd_file_progress">进度</label>
                     <div class="col-sm-10">
                        <progress id="upd_file_progress" max="100" value="0"></progress>
                        <!--<input type="text" id="upd_progress" value="0" name="upd_progress" />-->
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="uploadFile()" type="button">发送</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="click_pic_dialog_label" class="modal fade" data-backdrop="static" id="click_pic_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="click_pic_dialog_label">查看图片</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" role="form">
                  <div class="form-group">
                     <div class="col-sm-12">
                        <div id="bigPicDiv"></div>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <!--<button type="button" class="btn btn-primary" id="viewOriPicBt">
                      查看原图
                  </button>-->
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_apply_join_group_pendency_dialog_label" class="modal fade" data-backdrop="static" id="get_apply_join_group_pendency_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_apply_join_group_pendency_dialog_label">我的加群申请</h4>
            </div>
            <div class="modal-body">
               <table id="get_apply_join_group_pendency_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <!-- 模态框（Modal） -->
   <div aria-hidden="true" aria-labelledby="handle_ajg_dialog_label" class="modal fade" data-backdrop="static" id="handle_ajg_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="handle_ajg_dialog_label">处理加群申请</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <input id="hajg_authentication" type="hidden">
                  <input id="hajg_msg_key" type="hidden">
                  <input id="hajg_user_defined_field" type="hidden">
                  <input id="hajg_from_account" type="hidden">
                  <input id="hajg_msg_seq" type="hidden">
                  <input id="hajg_msg_random" type="hidden">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hajg_group_id">群ID</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="hajg_group_id" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hajg_to_account">对方帐号</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="hajg_to_account" placeholder="" readonly="readonly" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hajg_action_radio">操作</label>
                     <div class="col-sm-10">
                        <label class="radio-inline">
                           <input checked id="hajg_action_agree_radio" name="hajg_action_radio" type="radio" value="Agree"> 同意</label>
                        <label class="radio-inline">
                           <input id="hajg_action_reject_radio" name="hajg_action_radio" type="radio" value="Reject"> 拒绝</label>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="hajg_approval_msg">附言</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="hajg_approval_msg" rows="3"></textarea>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="handleApplyJoinGroupPendency()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_my_group_system_msgs_dialog_label" class="modal fade" data-backdrop="static" id="get_my_group_system_msgs_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_my_group_system_msgs_dialog_label">我的群组系统消息</h4>
            </div>
            <div class="modal-body">
               <table id="get_my_group_system_msgs_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="edit_custom_msg_label" class="modal fade" data-backdrop="static" id="edit_custom_msg_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="edit_custom_msg_label">发送自定义消息</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="ecm_form" name="ecm_form" onkeydown="if(event.keyCode==13)return false;" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="ecm_data">数据</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="ecm_data" rows="3"></textarea>
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="ecm_desc">描述</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="ecm_desc" maxlength="50" placeholder="请输入描述" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="ecm_ext">扩展</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="ecm_ext" maxlength="50" placeholder="请输入扩展" type="text">
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="sendCustomMsg()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="send_group_system_msg_dialog_label" class="modal fade" data-backdrop="static" id="send_group_system_msg_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="send_group_system_msg_dialog_label">发送自定义群系统通知</h4>
            </div>
            <div class="modal-body">
               <form class="form-horizontal" id="sgsm_form" name="sgsm_form" role="form">
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="sgsm_group_id">群组ID</label>
                     <div class="col-sm-10">
                        <input class="form-control" id="sgsm_group_id" maxlength="30" placeholder="请输入群组ID" type="text">
                     </div>
                  </div>
                  <div class="form-group">
                     <label class="col-sm-2 control-label" for="sgsm_content">内容</label>
                     <div class="col-sm-10">
                        <textarea class="form-control" id="sgsm_content" rows="3"></textarea>
                     </div>
                  </div>
               </form>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
               <button class="btn btn-primary" onclick="sendCustomGroupNotify()" type="button">提交</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_my_friend_system_msgs_dialog_label" class="modal fade" data-backdrop="static" id="get_my_friend_system_msgs_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_my_friend_system_msgs_dialog_label">我的好友系统通知</h4>
            </div>
            <div class="modal-body">
               <table id="get_my_friend_system_msgs_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
   <div aria-hidden="true" aria-labelledby="get_my_friend_profile_msgs_dialog_label" class="modal fade" data-backdrop="static" id="get_my_profile_system_msgs_dialog" role="dialog" tabindex="-1">
      <div class="modal-dialog-wide">
         <div class="modal-content">
            <div class="modal-header">
               <button aria-hidden="true" class="close" data-dismiss="modal" type="button">×</button>
               <h4 class="modal-title" id="get_my_friend_profile_msgs_dialog_label">我的资料系统通知</h4>
            </div>
            <div class="modal-body">
               <table id="get_my_profile_system_msgs_table"></table>
            </div>
            <div class="modal-footer">
               <button class="btn btn-default" data-dismiss="modal" type="button">关闭</button>
            </div>
         </div>
         <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
   </div>
   <!-- /.modal -->
</div>
<script>
   //表情标识字符和索引映射关系对象，用户可以自定义
   webim.EmotionDataIndexs = {
      "[):]": 0,
      "[:D]": 1,
      "[;)]": 2,
      "[:-o]": 3,
      "[:p]": 4,
      "[(H)]": 5,
      "[:@]": 6,
      "[:s]": 7,
      "[:$]": 8,
      "[:(]": 9,
      "[:'(]": 10,
      "[:|]": 11,
      "[(a)]": 12,
      "[8o|]": 13,
      "[8-|]": 14,
      "[+o(]": 15,
      "[<o)]": 16,
      "[|-)]": 17,
      "[*-)]": 18,
      "[:-#]": 19,
      "[:-*]": 20,
      "[^o)]": 21,
      "[8-)]": 22,
      "[(|)]": 23,
      "[(u)]": 24,
      "[(S)]": 25,
      "[(*)]": 26,
      "[(#)]": 27,
      "[(R)]": 28,
      "[({)]": 29,
      "[(})]": 30,
      "[(k)]": 31,
      "[(F)]": 32,
      "[(W)]": 33,
      "[(D)]": 34
   };

   //表情对象，用户可以自定义
   webim.Emotions = {
      "0": ["[):]", './img//emotions/ee_1.png'],
      "1": ["[:D]", './img//emotions/ee_2.png'],
      "2": ["[;)]", './img//emotions/ee_3.png'],
      "3": ["[:-o]", './img//emotions/ee_4.png'],
      "4": ["[:p]", './img//emotions/ee_5.png'],
      "5": ["[(H)]", './img//emotions/ee_6.png'],
      "6": ["[:@]", './img//emotions/ee_7.png'],
      "7": ["[:s]", './img//emotions/ee_8.png'],
      "8": ["[:$]", './img//emotions/ee_9.png'],
      "9": ["[:(]", './img//emotions/ee_10.png'],
      "10": ["[:'(]", './img//emotions/ee_11.png'],
      "11": ["[:|]", './img//emotions/ee_18.png'],
      "12": ["[(a)]", './img//emotions/ee_13.png'],
      "13": ["[8o|]", './img//emotions/ee_14.png'],
      "14": ["[8-|]", './img//emotions/ee_15.png'],
      "15": ["[+o(]", './img//emotions/ee_16.png'],
      "16": ["[<o)]", './img//emotions/ee_12.png'],
      "17": ["[|-)]", './img//emotions/ee_17.png'],
      "18": ["[*-)]", './img//emotions/ee_19.png'],
      "19": ["[:-#]", './img//emotions/ee_20.png'],
      "20": ["[:-*]", './img//emotions/ee_22.png'],
      "21": ["[^o)]", './img//emotions/ee_21.png'],
      "22": ["[8-)]", './img//emotions/ee_23.png'],
      "23": ["[(|)]", './img//emotions/ee_24.png'],
      "24": ["[(u)]", './img//emotions/ee_25.png'],
      "25": ["[(S)]", './img//emotions/ee_26.png'],
      "26": ["[(*)]", './img//emotions/ee_27.png'],
      "27": ["[(#)]", './img//emotions/ee_28.png'],
      "28": ["[(R)]", './img//emotions/ee_29.png'],
      "29": ["[({)]", './img//emotions/ee_30.png'],
      "30": ["[(})]", './img//emotions/ee_31.png'],
      "31": ["[(k)]", './img//emotions/ee_32.png'],
      "32": ["[(F)]", './img//emotions/ee_33.png'],
      "33": ["[(W)]", './img//emotions/ee_34.png'],
      "34": ["[(D)]", './img//emotions/ee_35.png']
   };
   //帐号模式，0-表示独立模式，1-表示托管模式
   var accountMode = 0;

   //官方 demo appid,需要开发者自己修改（托管模式）
   // var sdkAppID = 1400104136;
   var sdkAppID = 1400158766;
   var accountType = 29887;

   //当前用户身份
   var loginInfo = {
      'sdkAppID': sdkAppID, //用户所属应用id,必填
      'identifier': "webim_test_userid", //当前用户ID,必须是否字符串类型，必填
      // 'identifier': "user_b", //当前用户ID,必须是否字符串类型，必填
      'accountType': accountType, //用户所属应用帐号类型，必填
      'userSig': "eJxlkMtOg0AYRvc8BWFbY2eGu0kXVEUbaLBCNXYzoZ0Bfw2XMoNQTd*9Sk0kcX1O8l2*FFVVtSSML9PdrmpLSeWh5pp6pWpIu-iDdQ2MppLqDfsHeV9Dw2maSd4MkJguQWisAOOlhAx*hY5voaCSC0lbwRtgI1WwdzrEDSY2EMKmY1vWWIF8gMvb1fXiLhZR7ET*MsunOcsWQegEyXM-DZ-iT0-v15jthYwYs5J7D*Ybt6uSlz2J9a09OcyLR-Kart4eJo6erIMI*0br1RFxbzZ*N5uNIiUU51ewaRDLQbo9LvTBGwFVeR7-3Rdj7KKfB5SjcgJv2mDF",
      //当前用户身份凭证，必须是字符串类型，必填
      'identifierNick': null, //当前用户昵称，不用填写，登录接口会返回用户的昵称，如果没有设置，则返回用户的id
      'headurl': 'img/custome/me.jpg' //当前用户默认头像，选填，如果设置过头像，则可以通过拉取个人资料接口来得到头像信息
   };

   var AdminAcount = 'qwe101';
   var selType = webim.SESSION_TYPE.C2C; //当前聊天类型
   var selToID = null; //当前选中聊天id（当聊天类型为私聊时，该值为好友帐号，否则为群号）
   var selSess = null; //当前聊天会话对象
   var recentSessMap = {}; //保存最近会话列表
   var reqRecentSessCount = 50; //每次请求的最近会话条数，业务可以自定义

   var isPeerRead = 1; //是否需要支持APP端已读回执的功能,默认为0。是：1，否：0。

   //默认好友头像
   var friendHeadUrl = 'img/custome/friend.jpg'; //仅demo使用，用于没有设置过头像的好友
   //默认群头像
   var groupHeadUrl = 'img/custome/group.jpg'; //仅demo使用，用于没有设置过群头像的情况


   //存放c2c或者群信息（c2c用户：c2c用户id，昵称，头像；群：群id，群名称，群头像）
   var infoMap = {}; //初始化时，可以先拉取我的好友和我的群组信息


   var maxNameLen = 12; //我的好友或群组列表中名称显示最大长度，仅demo用得到
   var reqMsgCount = 15; //每次请求的历史消息(c2c获取群)条数，仅demo用得到

   var pageSize = 15; //表格的每页条数，bootstrap table 分页时用到
   var totalCount = 200; //每次接口请求的条数，bootstrap table 分页时用到

   var emotionFlag = false; //是否打开过表情选择框

   var curPlayAudio = null; //当前正在播放的audio对象

   var getPrePageC2CHistroyMsgInfoMap = {}; //保留下一次拉取好友历史消息的信息
   var getPrePageGroupHistroyMsgInfoMap = {}; //保留下一次拉取群历史消息的信息

   var defaultSelGroupId = null; //登录默认选中的群id，选填，仅demo用得到


   //监听（多终端同步）群系统消息方法，方法都定义在receive_group_system_msg.js文件中
   //注意每个数字代表的含义，比如，
   //1表示监听申请加群消息，2表示监听申请加群被同意消息，3表示监听申请加群被拒绝消息
   var onGroupSystemNotifys = {
      "1": onApplyJoinGroupRequestNotify, //申请加群请求（只有管理员会收到）
      "2": onApplyJoinGroupAcceptNotify, //申请加群被同意（只有申请人能够收到）
      "3": onApplyJoinGroupRefuseNotify, //申请加群被拒绝（只有申请人能够收到）
      "4": onKickedGroupNotify, //被管理员踢出群(只有被踢者接收到)
      "5": onDestoryGroupNotify, //群被解散(全员接收)
      "6": onCreateGroupNotify, //创建群(创建者接收)
      "7": onInvitedJoinGroupNotify, //邀请加群(被邀请者接收)
      "8": onQuitGroupNotify, //主动退群(主动退出者接收)
      "9": onSetedGroupAdminNotify, //设置管理员(被设置者接收)
      "10": onCanceledGroupAdminNotify, //取消管理员(被取消者接收)
      "11": onRevokeGroupNotify, //群已被回收(全员接收)
      "15": onReadedSyncGroupNotify, //群消息已读同步通知
      "255": onCustomGroupNotify, //用户自定义通知(默认全员接收)
      "12": onInvitedJoinGroupNotifyRequest //邀请加群(被邀请者接收,接收者需要同意)
   };

   //监听好友系统通知函数对象，方法都定义在receive_friend_system_msg.js文件中
   var onFriendSystemNotifys = {
      "1": onFriendAddNotify, //好友表增加
      "2": onFriendDeleteNotify, //好友表删除
      "3": onPendencyAddNotify, //未决增加
      "4": onPendencyDeleteNotify, //未决删除
      "5": onBlackListAddNotify, //黑名单增加
      "6": onBlackListDeleteNotify //黑名单删除
   };

   var onC2cEventNotifys = {
      "92": onMsgReadedNotify, //消息已读通知,
      "96": onMultipleDeviceKickedOut
   };

   //监听资料系统通知函数对象，方法都定义在receive_profile_system_msg.js文件中
   var onProfileSystemNotifys = {
      "1": onProfileModifyNotify //资料修改
   };

   //监听连接状态回调变化事件
   var onConnNotify = function(resp) {
      var info;
      switch (resp.ErrorCode) {
         case webim.CONNECTION_STATUS.ON:
            webim.Log.warn('建立连接成功: ' + resp.ErrorInfo);
            break;
         case webim.CONNECTION_STATUS.OFF:
            info = '连接已断开，无法收到新消息，请检查下你的网络是否正常: ' + resp.ErrorInfo;
            // alert(info);
            webim.Log.warn(info);
            break;
         case webim.CONNECTION_STATUS.RECONNECT:
            info = '连接状态恢复正常: ' + resp.ErrorInfo;
            // alert(info);
            webim.Log.warn(info);
            break;
         default:
            webim.Log.error('未知连接状态: =' + resp.ErrorInfo);
            break;
      }
   };

   //IE9(含)以下浏览器用到的jsonp回调函数
   function jsonpCallback(rspData) {
      webim.setJsonpLastRspData(rspData);
   }

   //监听事件
   var listeners = {
      "onConnNotify": onConnNotify //监听连接状态回调变化事件,必填
         ,
      "jsonpCallback": jsonpCallback //IE9(含)以下浏览器用到的jsonp回调函数，
         ,
      "onMsgNotify": onMsgNotify //监听新消息(私聊，普通群(非直播聊天室)消息，全员推送消息)事件，必填
         ,
      "onBigGroupMsgNotify": onBigGroupMsgNotify //监听新消息(直播聊天室)事件，直播场景下必填
         ,
      "onGroupSystemNotifys": onGroupSystemNotifys //监听（多终端同步）群系统消息事件，如果不需要监听，可不填
         ,
      "onGroupInfoChangeNotify": onGroupInfoChangeNotify //监听群资料变化事件，选填
         ,
      "onFriendSystemNotifys": onFriendSystemNotifys //监听好友系统通知事件，选填
         ,
      "onProfileSystemNotifys": onProfileSystemNotifys //监听资料系统（自己或好友）通知事件，选填
         ,
      "onKickedEventCall": onKickedEventCall //被其他登录实例踢下线
         ,
      "onC2cEventNotifys": onC2cEventNotifys //监听C2C系统消息通道
         ,
      "onAppliedDownloadUrl": onAppliedDownloadUrl //申请文件/音频下载地址的回调
         ,
      "onLongPullingNotify": function(data) {
         console.debug('onLongPullingNotify', data)
      }
   };

   var isAccessFormalEnv = true; //是否访问正式环境



   var isLogOn = false; //是否开启sdk在控制台打印日志

   //初始化时，其他对象，选填
   var options = {
      'isAccessFormalEnv': isAccessFormalEnv, //是否访问正式环境，默认访问正式，选填
      'isLogOn': isLogOn //是否开启控制台打印日志,默认开启，选填
   }



   var msgflow = document.getElementsByClassName("msgflow")[0];
   var bindScrollHistoryEvent = {
      init: function() {
         msgflow.onscroll = function() {
            if (msgflow.scrollTop == 0) {
               msgflow.scrollTop = 10;
               if (selType == webim.SESSION_TYPE.C2C) {
                  getPrePageC2CHistoryMsgs();
               } else {
                  getPrePageGroupHistoryMsgs();
               }

            }
         }
      },
      reset: function() {
         msgflow.onscroll = null;
      }
   };

   //解决IE8之下document不支持getElementsByClassName方法
   if (!document.getElementsByClassName) {
      document.getElementsByClassName = function(className, element) {
         var children = (element || document).getElementsByTagName('*');
         var elements = new Array();
         for (var i = 0; i < children.length; i++) {
            var child = children[i];
            var classNames = child.className.split(' ');
            for (var j = 0; j < classNames.length; j++) {
               if (classNames[j] == className) {
                  elements.push(child);
                  break;
               }
            }
         }
         return elements;
      };
   }

   //切换应用类型单选按钮事件

   function changeAppType(item) {
      var appType = item.value;
      if (appType == 1) { //测试应用
         $('#myself_type_desc').hide();
         $('#demo_type_desc').show();
         $('#sdkAppIdDiv').hide();
         $('#accountTypeDiv').hide();
         $('#accountModeDiv').hide();
      } else if (appType == 0) { //自建应用
         $('#demo_type_desc').hide();
         $('#myself_type_desc').show();
         $('#sdkAppIdDiv').show();
         $('#accountTypeDiv').show();
         $('#accountModeDiv').show();
      }
   }
   $("input[name=accountMode]").change(function() {
      accountMode = $("input[name=accountMode]:checked").val();
      console.debug(accountMode);
   });
   //选择应用类型

   function selectApp() {
      var appType = $('input[name="app_type_radio"]:checked').val();
      if (appType == 1) { //测试应用
         loginInfo.sdkAppID = loginInfo.appIDAt3rd = sdkAppID;
         loginInfo.accountType = accountType;
      } else if (appType == 0) { //自建应用
         if ($("#sdk_app_id").val().length == 0) {
            alert('请输入sdkAppId');
            return;
         }
         if (!validNumber($("#sdk_app_id").val())) {
            alert('sdkAppId非法,只能输入数字');
            return;
         }
         if ($("#account_type").val().length == 0) {
            alert('请输入accountType');
            return;
         }
         if (!validNumber($("#account_type").val())) {
            alert('accountType非法,只能输入数字');
            return;
         }
         loginInfo.sdkAppID = loginInfo.appIDAt3rd = $('#sdk_app_id').val();
         loginInfo.accountType = $('#account_type').val();
      }
      //将account_type保存到cookie中,有效期是1天
      webim.Tool.setCookie('accountType', loginInfo.accountType, 3600 * 24);
      $('#select_app_dialog').modal('hide');

      if (accountMode == 1) {
         //调用tls登录服务
         tlsLogin();
      } else {
         $('#login_dialog').modal('show');
      }
   }

   //弹出登录框

   function showLoginDialog() {
      $('#select_app_dialog').modal('hide');
      //显示登录窗体
      $('#login_dialog').modal('show');
      $("#login_account").focus();
   }

   //点击登录按钮(独立模式)

   function independentModeLogin() {
      if ($("#login_account").val().length == 0) {
         alert('请输入帐号');
         return;
      }
      if ($("#login_pwd").val().length == 0) {
         alert('请输入UserSig');
         return;
      }
      loginInfo.identifier = $('#login_account').val();
      loginInfo.userSig = $('#login_pwd').val();
      $('#login_dialog').modal('hide');
      $('#select_app_dialog').modal('hide');
      webimLogin();
   }

   //初始化demo

   function initDemoApp() {
      $("body").css("background-color", '#2f2f2f');
      document.getElementById("webim_demo").style.display = "block"; //展开聊天界面
      document.getElementById("p_my_face").src = loginInfo.headurl;
      if (loginInfo.identifierNick) {
         document.getElementById("t_my_name").innerHTML = webim.Tool.formatText2Html(loginInfo.identifierNick);
      } else {
         document.getElementById("t_my_name").innerHTML = webim.Tool.formatText2Html(loginInfo.identifier);
      }

      //菜单
      $("#t_my_menu").menu();

      $("#send_msg_text").focus();
      //初始化我的加群申请表格
      initGetApplyJoinGroupPendency([]);
      //初始化我的群组系统消息表格
      initGetMyGroupSystemMsgs([]);
      //初始化我的好友系统消息表格
      initGetMyFriendSystemMsgs([]);
      //初始化我的资料系统消息表格
      initGetMyProfileSystemMsgs([]);

      //初始化好友和群信息
      initInfoMap(initInfoMapCallbackOK);

   }

   function initInfoMap(cbOk) {
      //读取我的好友列表
      initInfoMapByMyFriends(
         //读取我的群组列表
         initInfoMapByMyGroups(
            cbOk
         )
      );
   }

   function initInfoMapCallbackOK() {
      initRecentContactList(initRecentContactListCallbackOK);
   }

   //初始化我的最近会话列表框回调函数

   function initRecentContactListCallbackOK() {
      onSelSess(selType, selToID);

   }

   //判断str是否只包含数字

   function validNumber(str) {
      if (!str) {
         str = str.toString();
         return str.match(/(^\d+$)/g);
      } else {
         return str;
      }
   }



   function onAppliedDownloadUrl(data) {
      console.debug(data);
   }

   //聊天页面增加一条消息

   function addMsg(msg, prepend) {
      var isSelfSend, fromAccount, fromAccountNick, fromAccountImage, sessType, subType;


      //获取会话类型，目前只支持群聊
      //webim.SESSION_TYPE.GROUP-群聊，
      //webim.SESSION_TYPE.C2C-私聊，
      sessType = msg.getSession().type();

      isSelfSend = msg.getIsSend(); //消息是否为自己发的

      fromAccount = msg.getFromAccount();
      if (!fromAccount) {
         return;
      }
      if (isSelfSend) { //如果是自己发的消息
         if (loginInfo.identifierNick) {
            fromAccountNick = loginInfo.identifierNick;
         } else {
            fromAccountNick = fromAccount;
         }
         //获取头像
         if (loginInfo.headurl) {
            fromAccountImage = loginInfo.headurl;
         } else {
            fromAccountImage = friendHeadUrl;
         }
      } else { //如果别人发的消息
         var key = webim.SESSION_TYPE.C2C + "_" + fromAccount;
         var info = infoMap[key];
         if (info && info.name) {
            fromAccountNick = info.name;
         } else if (msg.getFromAccountNick()) {
            fromAccountNick = msg.getFromAccountNick();
         } else {
            fromAccountNick = fromAccount;
         }
         //获取头像
         if (info && info.image) {
            fromAccountImage = info.image;
         } else if (msg.fromAccountHeadurl) {
            fromAccountImage = msg.fromAccountHeadurl;
         } else {
            fromAccountImage = friendHeadUrl;
         }
      }

      var onemsg = document.createElement("div");

      var msgbody = document.createElement("p");
      msgbody.className = "msgbody";
      if (msg.sending) {
         onemsg.id = "id_" + msg.random;
         //发送中
         var spinner = document.createElement("div");
         spinner.className = "spinner";
         spinner.innerHTML = '<div class="bounce1"></div> <div class="bounce2"></div> <div class="bounce3"></div>';
         msgbody.appendChild(spinner);
      } else {
         $("#id_" + msg.random).remove();
      }

      onemsg.className = "onemsg";
      var msghead = document.createElement("p");
      var msgavatar = document.createElement("div");
      msgavatar.className = 'avatar'
      var msgBox = document.createElement("div");
      msgBox.className = 'msg-main'
      var msgPre = document.createElement("div");
      msgPre.className = 'content'
      msghead.className = "msghead";


      //如果是发给自己的消息
      if (isSelfSend) {
         onemsg.classList.add("my");
      }

      //昵称  消息时间
      msghead.innerHTML = webim.Tool.formatText2Html(fromAccountNick + "&nbsp;&nbsp;" + webim.Tool.formatTimeStamp(msg.getTime()));
      //用户头像
      msgavatar.innerHTML = "<img class='headurlClass' src='" + fromAccountImage + "' />"


      //解析消息

      //获取消息子类型
      //会话类型为群聊时，子类型为：webim.GROUP_MSG_SUB_TYPE
      //会话类型为私聊时，子类型为：webim.C2C_MSG_SUB_TYPE
      subType = msg.getSubType();


      switch (subType) {

         case webim.GROUP_MSG_SUB_TYPE.COMMON: //群普通消息
            msgPre.innerHTML = convertMsgtoHtml(msg);
            break;
         case webim.GROUP_MSG_SUB_TYPE.REDPACKET: //群红包消息
            msgPre.innerHTML = "[群红包消息]" + convertMsgtoHtml(msg);
            break;
         case webim.GROUP_MSG_SUB_TYPE.LOVEMSG: //群点赞消息
            //业务自己可以增加逻辑，比如展示点赞动画效果
            msgPre.innerHTML = "[群点赞消息]" + convertMsgtoHtml(msg);
            //展示点赞动画
            //showLoveMsgAnimation();
            break;
         case webim.GROUP_MSG_SUB_TYPE.TIP: //群提示消息
            msgPre.innerHTML = "[群提示消息]" + convertMsgtoHtml(msg);
            break;
      }
      msgBox.appendChild(msgPre);
      msgbody.appendChild(msgavatar);
      msgbody.appendChild(msgBox);
      onemsg.appendChild(msghead);
      onemsg.appendChild(msgbody);

      //消息列表
      var msgflow = document.getElementsByClassName("msgflow")[0];
      if (prepend) {
         //300ms后,等待图片加载完，滚动条自动滚动到底部
         msgflow.insertBefore(onemsg, msgflow.firstChild);
         if (msgflow.scrollTop == 0) {
            setTimeout(function() {
               msgflow.scrollTop = 0;
            }, 300);
         }
      } else {
         msgflow.appendChild(onemsg);
         //300ms后,等待图片加载完，滚动条自动滚动到底部
         setTimeout(function() {
            msgflow.scrollTop = msgflow.scrollHeight;
         }, 300);
      }


   }
   //把消息转换成Html

   function convertMsgtoHtml(msg) {
      var html = "",
         elems, elem, type, content;
      elems = msg.getElems(); //获取消息包含的元素数组
      var count = elems.length;
      for (var i = 0; i < count; i++) {
         elem = elems[i];
         type = elem.getType(); //获取元素类型
         content = elem.getContent(); //获取元素对象
         switch (type) {
            case webim.MSG_ELEMENT_TYPE.TEXT:
               var eleHtml = convertTextMsgToHtml(content);
               //转义，防XSS
               html += webim.Tool.formatText2Html(eleHtml);
               break;
            case webim.MSG_ELEMENT_TYPE.FACE:
               html += convertFaceMsgToHtml(content);
               break;
            case webim.MSG_ELEMENT_TYPE.IMAGE:
               if (i <= count - 2) {
                  var customMsgElem = elems[i + 1]; //获取保存图片名称的自定义消息elem
                  var imgName = customMsgElem.getContent().getData(); //业务可以自定义保存字段，demo中采用data字段保存图片文件名
                  html += convertImageMsgToHtml(content, imgName);
                  i++; //下标向后移一位
               } else {
                  html += convertImageMsgToHtml(content);
               }
               break;
            case webim.MSG_ELEMENT_TYPE.SOUND:
               html += convertSoundMsgToHtml(content);
               break;
            case webim.MSG_ELEMENT_TYPE.FILE:
               html += convertFileMsgToHtml(content);
               break;
            case webim.MSG_ELEMENT_TYPE.LOCATION:
               html += convertLocationMsgToHtml(content);
               break;
            case webim.MSG_ELEMENT_TYPE.CUSTOM:
               var eleHtml = convertCustomMsgToHtml(content);
               //转义，防XSS
               html += (eleHtml);
               break;
            case webim.MSG_ELEMENT_TYPE.GROUP_TIP:
               var eleHtml = convertGroupTipMsgToHtml(content);
               //转义，防XSS
               html += webim.Tool.formatText2Html(eleHtml);
               break;
            default:
               webim.Log.error('未知消息元素类型: elemType=' + type);
               break;
         }
      }
      return html;
   }

   //解析文本消息元素

   function convertTextMsgToHtml(content) {
      return content.getText();
   }
   //解析表情消息元素

   function convertFaceMsgToHtml(content) {
      var faceUrl = null;
      var data = content.getData();
      var index = webim.EmotionDataIndexs[data];

      var emotion = webim.Emotions[index];
      if (emotion && emotion[1]) {
         faceUrl = emotion[1];
      }
      if (faceUrl) {
         return "<img src='" + faceUrl + "'/>";
      } else {
         return data;
      }
   }
   //解析图片消息元素

   function convertImageMsgToHtml(content, imageName) {
      var smallImage = content.getImage(webim.IMAGE_TYPE.SMALL); //小图
      var bigImage = content.getImage(webim.IMAGE_TYPE.LARGE); //大图
      var oriImage = content.getImage(webim.IMAGE_TYPE.ORIGIN); //原图
      if (!bigImage) {
         bigImage = smallImage;
      }
      if (!oriImage) {
         oriImage = smallImage;
      }
      return "<img name='" + imageName + "' src='" + smallImage.getUrl() + "#" + bigImage.getUrl() + "#" + oriImage.getUrl() + "' style='cursor: pointer' id='" + content.getImageId() + "' bigImgUrl='" + bigImage.getUrl() + "' onclick='imageClick(this)' />";
   }
   //解析语音消息元素

   function convertSoundMsgToHtml(content) {
      var second = content.getSecond(); //获取语音时长
      var downUrl = content.getDownUrl();
      if (webim.BROWSER_INFO.type == 'ie' && parseInt(webim.BROWSER_INFO.ver) <= 8) {
         return '[这是一条语音消息]demo暂不支持ie8(含)以下浏览器播放语音,语音URL:' + downUrl;
      }
      return '<audio id="uuid_' + content.uuid + '" src="' + downUrl + '" controls="controls" onplay="onChangePlayAudio(this)" preload="none"></audio>';
   }
   //解析文件消息元素

   function convertFileMsgToHtml(content) {
      var fileSize, unitStr;
      fileSize = content.getSize();
      unitStr = "Byte";
      if (fileSize >= 1024) {
         fileSize = Math.round(fileSize / 1024);
         unitStr = "KB";
      }
      // return '<a href="' + content.getDownUrl() + '" title="点击下载文件" ><i class="glyphicon glyphicon-file">&nbsp;' + content.getName() + '(' + fileSize + unitStr + ')</i></a>';

      return '<a href="javascript:;" onclick=\'webim.onDownFile("' + content.uuid + '")\' title="点击下载文件" ><i class="glyphicon glyphicon-file">&nbsp;' + content.name + '(' + fileSize + unitStr + ')</i></a>';
   }
   //解析位置消息元素

   function convertLocationMsgToHtml(content) {
      return '经度=' + content.getLongitude() + ',纬度=' + content.getLatitude() + ',描述=' + content.getDesc();
   }
   //解析自定义消息元素

   function convertCustomMsgToHtml(content) {
      var data = content.getData(); //自定义数据
      var desc = content.getDesc(); //描述信息
      var ext = content.getExt(); //扩展信息
      console.log(ext)
      var strs = ext.split("&");
      var param = {}
      for (var i = 0; i < strs.length; i++) {
         var result = strs[i].split("=");
         var key = result[0];
         var value = result[1];
         param[key] = value;
      }

      return "<a target='_blank' href='#/shop-detail/"+param.goods_id+"/1' class='goods'><img src='"+param.img+"' /><div class='name'>"+param.goods_name+"</div></a>";
   }
   //解析群提示消息元素

   function convertGroupTipMsgToHtml(content) {
      var WEB_IM_GROUP_TIP_MAX_USER_COUNT = 10;
      var text = "";
      var maxIndex = WEB_IM_GROUP_TIP_MAX_USER_COUNT - 1;
      var opType, opUserId, userIdList;
      var groupMemberNum;
      opType = content.getOpType(); //群提示消息类型（操作类型）
      opUserId = content.getOpUserId(); //操作人id
      switch (opType) {
         case webim.GROUP_TIP_TYPE.JOIN: //加入群
            userIdList = content.getUserIdList();
            //text += opUserId + "邀请了";
            for (var m in userIdList) {
               text += userIdList[m] + ",";
               if (userIdList.length > WEB_IM_GROUP_TIP_MAX_USER_COUNT && m == maxIndex) {
                  text += "等" + userIdList.length + "人";
                  break;
               }
            }
            text = text.substring(0, text.length - 1);
            text += "加入该群，当前群成员数：" + content.getGroupMemberNum();
            break;
         case webim.GROUP_TIP_TYPE.QUIT: //退出群
            text += opUserId + "离开该群，当前群成员数：" + content.getGroupMemberNum();
            break;
         case webim.GROUP_TIP_TYPE.KICK: //踢出群
            text += opUserId + "将";
            userIdList = content.getUserIdList();
            for (var m in userIdList) {
               text += userIdList[m] + ",";
               if (userIdList.length > WEB_IM_GROUP_TIP_MAX_USER_COUNT && m == maxIndex) {
                  text += "等" + userIdList.length + "人";
                  break;
               }
            }
            text += "踢出该群";
            break;
         case webim.GROUP_TIP_TYPE.SET_ADMIN: //设置管理员
            text += opUserId + "将";
            userIdList = content.getUserIdList();
            for (var m in userIdList) {
               text += userIdList[m] + ",";
               if (userIdList.length > WEB_IM_GROUP_TIP_MAX_USER_COUNT && m == maxIndex) {
                  text += "等" + userIdList.length + "人";
                  break;
               }
            }
            text += "设为管理员";
            break;
         case webim.GROUP_TIP_TYPE.CANCEL_ADMIN: //取消管理员
            text += opUserId + "取消";
            userIdList = content.getUserIdList();
            for (var m in userIdList) {
               text += userIdList[m] + ",";
               if (userIdList.length > WEB_IM_GROUP_TIP_MAX_USER_COUNT && m == maxIndex) {
                  text += "等" + userIdList.length + "人";
                  break;
               }
            }
            text += "的管理员资格";
            break;

         case webim.GROUP_TIP_TYPE.MODIFY_GROUP_INFO: //群资料变更
            text += opUserId + "修改了群资料：";
            var groupInfoList = content.getGroupInfoList();
            var type, value;
            for (var m in groupInfoList) {
               type = groupInfoList[m].getType();
               value = groupInfoList[m].getValue();
               switch (type) {
                  case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.FACE_URL:
                     text += "群头像为" + value + "; ";
                     break;
                  case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.NAME:
                     text += "群名称为" + value + "; ";
                     break;
                  case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.OWNER:
                     text += "群主为" + value + "; ";
                     break;
                  case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.NOTIFICATION:
                     text += "群公告为" + value + "; ";
                     break;
                  case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.INTRODUCTION:
                     text += "群简介为" + value + "; ";
                     break;
                  default:
                     text += "未知信息为:type=" + type + ",value=" + value + "; ";
                     break;
               }
            }
            break;

         case webim.GROUP_TIP_TYPE.MODIFY_MEMBER_INFO: //群成员资料变更(禁言时间)
            text += opUserId + "修改了群成员资料:";
            var memberInfoList = content.getMemberInfoList();
            var userId, shutupTime;
            for (var m in memberInfoList) {
               userId = memberInfoList[m].getUserId();
               shutupTime = memberInfoList[m].getShutupTime();
               text += userId + ": ";
               if (shutupTime != null && shutupTime !== undefined) {
                  if (shutupTime == 0) {
                     text += "取消禁言; ";
                  } else {
                     text += "禁言" + shutupTime + "秒; ";
                  }
               } else {
                  text += " shutupTime为空";
               }
               if (memberInfoList.length > WEB_IM_GROUP_TIP_MAX_USER_COUNT && m == maxIndex) {
                  text += "等" + memberInfoList.length + "人";
                  break;
               }
            }
            break;
         default:
            text += "未知群提示消息类型：type=" + opType;
            break;
      }
      return text;
   }
   //定义我的黑名单表格每行的操作按钮
   function gblOperateFormatter(value, row, index) {
      return [
         '<a class="remove ml10" href="javascript:void(0)" title="删除">',
         '<i class="glyphicon glyphicon-remove"></i>',
         '</a>'

      ].join('');
   }
   //定义我的黑名单表格每行的操作按钮点击事件
   window.gblOperateEvents = {
      'click .remove': function(e, value, row, index) {
         if (confirm("确定将该联系人从黑名单删除吗？")) {
            deleteBlackList(row.To_Account);
         }
      }
   };
   //初始化我的黑名单表格
   function initGetBlackListTable(data) {
      $('#get_black_list_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
               field: "To_Account",
               title: "账号",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "AddBlackTimeStamp",
               title: "操作时间",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "operate",
               title: "操作",
               align: "center",
               valign: "middle",
               formatter: "gblOperateFormatter",
               events: "gblOperateEvents"
            }
         ],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }
   //添加黑名单
   var addBlackList = function(add_account) {

      var to_account = [];
      if (add_account) {
         to_account = [add_account];
      }
      if (0 == to_account.length) {
         alert('需要拉黑的帐号为空');
         return;
      }
      var options = {
         'From_Account': loginInfo.identifier,
         'To_Account': to_account
      };

      webim.addBlackList(
         options,
         function(resp) {

            //在表格中删除对应的行
            $('#get_my_friend_table').bootstrapTable('remove', {
               field: 'Info_Account',
               values: [add_account]
            });
            //重新加载好友列表
            //getAllFriend(getAllFriendsCallbackOK);
            deleteSessDiv(webim.SESSION_TYPE.C2C, add_account); //在最近联系人列表中删除对应拉黑的好友(如果存在的话)
            alert('添加黑名单成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //删除黑名单
   var deleteBlackList = function(del_account) {

      var to_account = [
         del_account
      ];
      var options = {
         'From_Account': loginInfo.identifier,
         'To_Account': to_account
      };

      webim.deleteBlackList(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_black_list_table').bootstrapTable('remove', {
               field: 'To_Account',
               values: to_account
            });

            alert('删除黑名单成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //我的黑名单
   var getBlackList = function(cbOK, cbErr) {
      initGetBlackListTable([]);
      var options = {
         'From_Account': loginInfo.identifier,
         'StartIndex': 0,
         'MaxLimited': totalCount,
         'LastSequence': 0
      };

      webim.getBlackList(
         options,
         function(resp) {
            var data = [];
            if (resp.BlackListItem && resp.BlackListItem.length > 0) {

               for (var i in resp.BlackListItem) {
                  var add_time = webim.Tool.formatTimeStamp(resp.BlackListItem[i].AddBlackTimeStamp);
                  data.push({
                     To_Account: webim.Tool.formatText2Html(resp.BlackListItem[i].To_Account),
                     AddBlackTimeStamp: add_time
                  });
               }
            }
            $('#get_black_list_table').bootstrapTable('load', data);
            $('#get_black_list_dialog').modal('show');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //定义我的好友表格每行的操作按钮
   function gmfOperateFormatter(value, row, index) {
      return [
         '<a class="envelope" href="javascript:void(0)" title="发消息">',
         '<i class="glyphicon glyphicon-envelope"></i>',
         '</a>',
         '<a class="ban-circle" href="javascript:void(0)" title="拉黑">',
         '<i class="glyphicon glyphicon-ban-circle"></i>',
         '</a>',
         '<a class="remove ml10" href="javascript:void(0)" title="删除">',
         '<i class="glyphicon glyphicon-remove"></i>',
         '</a>'

      ].join('');
   }
   //我的好友表格每行的操作按钮点击事件
   window.gmfOperateEvents = {
      'click .envelope': function(e, value, row, index) {
         $('#scm_to_account').val(row.Info_Account);
         $('#send_c2c_msg_dialog').modal('show');
      },
      'click .ban-circle': function(e, value, row, index) {
         if (confirm("确定将该好友拉黑吗？")) {
            addBlackList(row.Info_Account);
         }
      },
      'click .remove': function(e, value, row, index) {
         $('#df_to_account').val(row.Info_Account);
         $('#delete_friend_dialog').modal('show');
      }
   };
   //初始化我的好友表格
   function initGetMyFriendTable(data) {
      $('#get_my_friend_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         sidePagination: 'client',
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
               field: "Info_Account",
               title: "账号",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "Nick",
               title: "昵称",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "Gender",
               title: "性别",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "gmfOperate",
               title: "操作",
               align: "center",
               valign: "middle",
               formatter: "gmfOperateFormatter",
               events: "gmfOperateEvents"
            }
         ],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }
   //申请加好友
   var applyAddFriend = function() {

      var len = webim.Tool.getStrBytes($("#af_add_wording").val());
      if (len > 120) {
         alert('您输入的附言超过字数限制(最长40个汉字)');
         return;
      }
      var add_friend_item = [{
         'To_Account': $("#af_to_account").val(),
         "AddSource": "AddSource_Type_Unknow",
         "AddWording": $("#af_add_wording").val() //加好友附言，可为空
      }];
      var options = {
         'From_Account': loginInfo.identifier,
         'AddFriendItem': add_friend_item
      };

      webim.applyAddFriend(
         options,
         function(resp) {
            if (resp.Fail_Account && resp.Fail_Account.length > 0) {
               for (var i in resp.ResultItem) {
                  alert(resp.ResultItem[i].ResultInfo);
                  break;
               }
            } else {

               if ($('#af_allow_type').val() == '允许任何人') {
                  //重新加载好友列表
                  //getAllFriend(getAllFriendsCallbackOK);
                  alert('添加好友成功');
               } else {
                  $('#add_friend_dialog').modal('hide');
                  alert('申请添加好友成功');
               }

            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //删除好友
   var deleteFriend = function() {

      if (!confirm("确定删除该好友吗？")) {
         return;
      }

      var to_account = [];

      to_account = [
         $("#df_to_account").val()
      ];

      if (to_account.length <= 0) {
         return;
      }
      var options = {
         'From_Account': loginInfo.identifier,
         'To_Account': to_account,
         //Delete_Type_Both'//单向删除："Delete_Type_Single", 双向删除："Delete_Type_Both".
         'DeleteType': $('input[name="df_type_radio"]:checked').val()
      };

      webim.deleteFriend(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_my_friend_table').bootstrapTable('remove', {
               field: 'Info_Account',
               values: [$("#df_to_account").val()]
            });
            //重新加载好友列表
            //getAllFriend(getAllFriendsCallbackOK);
            deleteSessDiv(webim.SESSION_TYPE.C2C, $("#df_to_account").val()); //在最近联系人列表中删除好友(如果存在的话)
            $('#delete_friend_dialog').modal('hide');
            alert('删除好友成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );

   };
   //获取我的好友
   var getMyFriend = function() {

      //清空
      initGetMyFriendTable([]);

      var options = {
         'From_Account': loginInfo.identifier,
         'TimeStamp': 0,
         'StartIndex': 0,
         'GetCount': totalCount,
         'LastStandardSequence': 0,
         "TagList": [
            "Tag_Profile_IM_Nick",
            "Tag_SNS_IM_Remark",
            "Tag_Profile_IM_Gender"
         ]
      };

      webim.getAllFriend(
         options,
         function(resp) {

            if (resp.FriendNum > 0) {

               var table_friends_data = [];
               var friends = resp.InfoItem;
               if (!friends || friends.length == 0) {
                  alert('你目前还没有好友');
                  return;
               }

               var count = friends.length;

               for (var i = 0; i < count; i++) {
                  var friend_name = friends[i].Info_Account;
                  var gender = "未知";
                  if (friends[i].SnsProfileItem) {
                     for (var j in friends[i].SnsProfileItem) {
                        switch (friends[i].SnsProfileItem[j].Tag) {
                           case 'Tag_Profile_IM_Nick':
                              friend_name = friends[i].SnsProfileItem[j].Value;
                              break;
                           case 'Tag_Profile_IM_Gender':
                              switch (friends[i].SnsProfileItem[j].Value) {
                                 case 'Gender_Type_Male':
                                    gender = '男';
                                    break;
                                 case 'Gender_Type_Female':
                                    gender = '女';
                                    break;
                                 case 'Gender_Type_Unknown':
                                    gender = '未知';
                                    break;
                              }
                              break;
                        }
                     }
                  }
                  table_friends_data.push({
                     'Info_Account': friends[i].Info_Account,
                     'Nick': webim.Tool.formatText2Html(friend_name),
                     'Gender': gender
                  });
               }

               //打开我的好友列表对话框
               $('#get_my_friend_table').bootstrapTable('load', table_friends_data);
               $('#get_my_friend_dialog').modal('show');
            } else {
               alert('您目前还没有好友');
            }

         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //从我的好友列表中给好友发消息
   function sendC2cMsg() {

      toAccount = $("#scm_to_account").val();
      msgtosend = $("#scm_content").val();

      var msgLen = webim.Tool.getStrBytes(msgtosend);

      var maxLen, errInfo;

      maxLen = webim.MSG_MAX_LENGTH.C2C;
      errInfo = "消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)";

      if (msgtosend.length < 1) {
         alert("发送的消息不能为空!");
         $("#send_msg_text").val('');
         return;
      }

      if (msgLen > maxLen) {
         alert(errInfo);
         return;
      }

      var sess = webim.MsgStore.sessByTypeId(webim.SESSION_TYPE.C2C, toAccount);
      if (!sess) {
         sess = new webim.Session(webim.SESSION_TYPE.C2C, toAccount, toAccount, friendHeadUrl, Math.round(new Date().getTime() / 1000));
      }
      var isSend = true; //是否为自己发送
      var seq = -1; //消息序列，-1表示sdk自动生成，用于去重
      var random = Math.round(Math.random() * 4294967296); //消息随机数，用于去重
      var msgTime = Math.round(new Date().getTime() / 1000); //消息时间戳
      var subType; //消息子类型

      subType = webim.C2C_MSG_SUB_TYPE.COMMON;

      var msg = new webim.Msg(sess, isSend, seq, random, msgTime, loginInfo.identifier, subType, loginInfo.identifierNick);

      var text_obj;

      text_obj = new webim.Msg.Elem.Text(msgtosend);
      msg.addText(text_obj);

      webim.sendMsg(msg, function(resp) {


         if (!selToID) { //没有聊天会话
            selType = webim.SESSION_TYPE.C2C;
            selToID = toAccount;
            selSess = sess;
            addSess(selType, toAccount, toAccount, friendHeadUrl, 0, 'sesslist');
            setSelSessStyleOn(toAccount);
            //私聊时，在聊天窗口手动添加一条发的消息，群聊时，长轮询接口会返回自己发的消息
            addMsg(msg);
         } else { //有聊天会话
            if (selToID == toAccount) { //聊天对象不变
               addMsg(msg);
            } else { //聊天对象发生改变
               var tempSessDiv = document.getElementById("sessDiv_" + toAccount);
               if (!tempSessDiv) { //不存在这个会话
                  addSess(webim.SESSION_TYPE.C2C, toAccount, toAccount, friendHeadUrl, 0, 'sesslist'); //增加一个会话
               }

               onSelSess(webim.SESSION_TYPE.C2C, toAccount); //再进行切换
            }
         }
         webim.Tool.setCookie("tmpmsg_" + toAccount, '', 0);
         $("#scm_content").val('');
         $('#send_c2c_msg_dialog').modal('hide');
         $('#get_my_friend_dialog').modal('hide');

      }, function(err) {
         alert(err.ErrorInfo);
         $("#scm_content").val('');
      });
   }

   //将我的好友资料（昵称和头像）保存在infoMap
   var initInfoMapByMyFriends = function(cbOK) {

      var options = {
         'From_Account': loginInfo.identifier,
         'TimeStamp': 0,
         'StartIndex': 0,
         'GetCount': totalCount,
         'LastStandardSequence': 0,
         "TagList": [
            "Tag_Profile_IM_Nick",
            "Tag_Profile_IM_Image"
         ]
      };

      webim.getAllFriend(
         options,
         function(resp) {
            if (resp.FriendNum > 0) {

               var friends = resp.InfoItem;
               if (!friends || friends.length == 0) {
                  if (cbOK)
                     cbOK();
                  return;
               }
               var count = friends.length;

               for (var i = 0; i < count; i++) {
                  var friend = friends[i];
                  var friend_account = friend.Info_Account;
                  var friend_name = friend_image = '';
                  for (var j in friend.SnsProfileItem) {
                     switch (friend.SnsProfileItem[j].Tag) {
                        case 'Tag_Profile_IM_Nick':
                           friend_name = friend.SnsProfileItem[j].Value;
                           break;
                        case 'Tag_Profile_IM_Image':
                           friend_image = friend.SnsProfileItem[j].Value;
                           break;
                     }
                  }
                  var key = webim.SESSION_TYPE.C2C + "_" + friend_account;
                  infoMap[key] = {
                     'name': friend_name,
                     'image': friend_image
                  };
               }
               if (cbOK)
                  cbOK();
            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };


   //定义我的好友申请表格每行按钮
   function gpOperateFormatter(value, row, index) {
      return [
         '<a class="edit" href="javascript:void(0)" title="处理">',
         '<i class="glyphicon glyphicon-edit"></i>',
         '</a>',
         '<a class="remove ml10" href="javascript:void(0)" title="删除">',
         '<i class="glyphicon glyphicon-remove"></i>',
         '</a>'

      ].join('');
   }
   //我的好友申请表格每行的按钮点击事件
   window.gpOperateEvents = {
      'click .edit': function(e, value, row, index) {

         $("#rf_to_account").val(row.To_Account);
         $('#response_friend_dialog').modal('show');

      },
      'click .remove': function(e, value, row, index) {
         if (confirm("确定删除这条记录吗？")) {
            deletePendency(row.To_Account);
         }

      }
   };
   //初始化我的好友申请表格
   function initGetPendencyTable(data) {
      $('#get_pendency_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
               field: "To_Account",
               title: "对方账号",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "Nick",
               title: "对方昵称",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "AddWording",
               title: "附言",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "AddSource",
               title: "来源",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "AddTime",
               title: "申请时间",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "gpOperate",
               title: "操作",
               align: "center",
               valign: "middle",
               formatter: "gpOperateFormatter",
               events: "gpOperateEvents"
            }
         ],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }
   //读取好友申请列表
   //notifyFlag： true表示来自好友系统通知触发，false表示用户主动点击【获取好友申请】菜单
   var getPendency = function(notifyFlag) {
      initGetPendencyTable([]);
      var options = {
         //请求发起方的帐号，一般情况下为用户本人帐号，在管理员代替用户发起请求的情况下，这里应该填写被代替的用户的帐号
         'From_Account': loginInfo.identifier,
         //Pendency_Type_ComeIn: 别人发给我的; Pendency_Type_SendOut: 我发给别人的
         'PendencyType': 'Pendency_Type_ComeIn',
         //好友申请的起始时间
         'StartTime': 0,
         //分页大小，如果取值为30 则表示客户端要求服务器端每页最多返回30个好友申请
         'MaxLimited': totalCount,
         //好友申请数据的版本号，用户每收到或删除一条好友申请，服务器端就自增一次好友申请数据版本号，一般传0，表示拉取最新的数据
         'LastSequence': 0
      };

      webim.getPendency(
         options,
         function(resp) {
            var data = [];
            if (resp.UnreadPendencyCount > 0) { //存在未读未决
               for (var i in resp.PendencyItem) {
                  var apply_time = webim.Tool.formatTimeStamp(resp.PendencyItem[i].AddTime);
                  var nick = webim.Tool.formatText2Html(resp.PendencyItem[i].Nick);
                  if (nick == '') {
                     nick = resp.PendencyItem[i].To_Account;
                  }
                  var addWording = webim.Tool.formatText2Html(resp.PendencyItem[i].AddWording);
                  data.push({
                     To_Account: webim.Tool.formatText2Html(resp.PendencyItem[i].To_Account),
                     Nick: nick,
                     AddWording: addWording,
                     AddSource: resp.PendencyItem[i].AddSource,
                     AddTime: apply_time
                  });
               }
               $('#get_pendency_table').bootstrapTable('load', data);
               $('#get_pendency_dialog').modal('show');
            } else {
               if (!notifyFlag) {
                  alert('没有加好友申请');
               }
            }

         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //删除申请列表
   var deletePendency = function(del_account) {

      var options = {
         'From_Account': loginInfo.identifier,
         'PendencyType': 'Pendency_Type_ComeIn',
         'To_Account': [del_account]

      };

      webim.deletePendency(
         options,
         function(resp) {

            //在表格中删除对应的行
            $('#get_pendency_table').bootstrapTable('remove', {
               field: 'To_Account',
               values: [del_account]
            });
            alert('删除好友申请成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //处理好友申请
   var responseFriend = function() {

      var response_friend_item = [{
         'To_Account': $("#rf_to_account").val(),
         "ResponseAction": $('input[name="rf_action_radio"]:checked').val() //类型：Response_Action_Agree 或者 Response_Action_AgreeAndAdd
      }];
      var options = {
         'From_Account': loginInfo.identifier,
         'ResponseFriendItem': response_friend_item
      };

      webim.responseFriend(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_pendency_table').bootstrapTable('remove', {
               field: 'To_Account',
               values: [$("#rf_to_account").val()]
            });
            $('#response_friend_dialog').modal('hide');

            if (response_friend_item[0].ResponseAction == 'Response_Action_AgreeAndAdd') {
               //getAllFriend(getAllFriendsCallbackOK);
            }

            alert('处理好友申请成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );

   };

   //创建群菜单点击事件

   function createGroupMenuClick() {
      //重置表单
      $('#cg_form')[0].reset();

      var sessList = document.getElementsByClassName("sesslist-group")[0];
      var num = 1;
      if (sessList && sessList.childNodes) {
         num = sessList.childNodes.length + 1;
      }
      $("#cg_name").val('群' + num);

      $('#create_group_dialog').modal('show');
   }
   //搜索群(按ID)菜单单击事件

   function searchGroupMenuClick() {

      $("#sg_form")[0].reset();
      initSearchGroupTable([]);
      $('#search_group_table').bootstrapTable('load', []);
      $('#search_group_dialog').modal('show');
   }
   //搜索群(按名称)菜单单击事件

   function searchGroupByNameMenuClick() {

      $("#sgbn_form")[0].reset();
      initSearchGroupByNameTable([]);
      $('#search_group_by_name_table').bootstrapTable('load', []);
      $('#search_group_by_name_dialog').modal('show');
   }
   //定义搜索群(按ID)结果表格每行的操作按钮

   function sgOperateFormatter(value, row, index) {
      return [
         '<a class="plus" href="javascript:void(0)" title="申请加入">',
         '<i class="glyphicon glyphicon-plus"></i>',
         '</a>'

      ].join('');
   }
   //搜索群(按ID)结果表格按钮事件
   window.sgOperateEvents = {
      'click .plus': function(e, value, row, index) {

         $("#ajg_group_id").val(row.GId);
         $("#ajg_group_type").val(row.Type);
         $("#ajg_group_name").val(row.Name);

         if (row.Type == 'ChatRoom') { //聊天室直接申请加入
            applyJoinGroup();
         } else {
            $("#ajg_apply_msg").val('你好，我想加入贵群~');
            $('#apply_join_group_dialog').modal('show');
         }
      }
   };
   //初始化搜索群(按ID)结果表格

   function initSearchGroupTable(data) {
      $('#search_group_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "GroupId",
            title: "ID",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "TypeZh",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Type",
            title: "类型(英文)",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Name",
            title: "名称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Owner_Account",
            title: "群主",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "CreateTime",
            title: "创建时间",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MemberNum",
            title: "群成员数",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "sgOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "sgOperateFormatter",
            events: "sgOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }


   //定义搜索群（按名称）结果表格每行的操作按钮

   function sgbnOperateFormatter(value, row, index) {
      return [
         '<a class="plus" href="javascript:void(0)" title="申请加入">',
         '<i class="glyphicon glyphicon-plus"></i>',
         '</a>'

      ].join('');
   }
   //搜索群（按名称）结果表格按钮事件
   window.sgbnOperateEvents = {
      'click .plus': function(e, value, row, index) {

         $("#ajg_group_id").val(row.GId);
         $("#ajg_group_type").val(row.Type);
         $("#ajg_group_name").val(row.Name);

         if (row.Type == 'ChatRoom') { //聊天室直接申请加入
            applyJoinGroup();
         } else {
            $("#ajg_apply_msg").val('你好，我想加入贵群~');
            $('#apply_join_group_dialog').modal('show');
         }
      }
   };
   //初始化搜索群（按名称）结果表格

   function initSearchGroupByNameTable(data) {
      $('#search_group_by_name_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "GroupId",
            title: "ID",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "TypeZh",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Type",
            title: "类型(英文)",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Name",
            title: "名称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "FaceUrl",
            title: "群头像",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Owner_Account",
            title: "群主",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "CreateTime",
            title: "创建时间",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MemberNum",
            title: "群成员数",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "sgbnOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "sgbnOperateFormatter",
            events: "sgbnOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }


   //定义我的群组表格每行的操作按钮

   function gmgOperateFormatter(value, row, index) {
      return [
         '<a class="plus ml10" href="javascript:void(0)" title="邀请成员">',
         '<i class="glyphicon glyphicon-plus"></i>',
         '</a>',
         '<a class="user ml10" href="javascript:void(0)" title="查看群成员">',
         '<i class="glyphicon glyphicon-user"></i>',
         '</a>',
         '<a class="bell ml10" href="javascript:void(0)" title="设置群消息提示">',
         '<i class="glyphicon glyphicon-bell"></i>',
         '</a>',
         '<a class="logout ml10" href="javascript:void(0)" title="退出该群">',
         '<i class="glyphicon glyphicon-log-out"></i>',
         '</a>',
         '<a class="pencil ml10" href="javascript:void(0)" title="修改群资料">',
         '<i class="glyphicon glyphicon-pencil"></i>',
         '</a>',
         '<a class="share ml10" href="javascript:void(0)" title="转让该群">',
         '<i class="glyphicon glyphicon-share"></i>',
         '</a>',
         '<a class="trash ml10" href="javascript:void(0)" title="解散该群">',
         '<i class="glyphicon glyphicon-trash"></i>',
         '</a>',
         '<a class="envelope ml10" href="javascript:void(0)" title="发消息">',
         '<i class="glyphicon glyphicon-envelope"></i>',
         '</a>'

      ].join('');
   }
   //我的群组表格每行的操作按钮点击事件
   window.gmgOperateEvents = {
      'click .plus': function(e, value, row, index) {
         // if (row.TypeEn != 'Private') {
         //    alert('公开群或聊天室不支持直接拉人操作');
         //     return;
         // }
         $('#gmfg_group_id').val(row.GId);
         getMyFriendGroup();
      },
      'click .user': function(e, value, row, index) {
         $('#ggm_group_id').val(row.GId);
         $('#ggm_my_role').val(row.Role);
         $('#ggm_group_type').val(row.TypeEn);

         getGroupMemberInfo(row.GId);
      },
      'click .bell': function(e, value, row, index) {
         $('#mgmf_sel_row_index').val(index);
         $('#mgmf_group_id').val(row.GId);
         //设置群消息提示类型
         //var msg_flag = webim.Tool.groupRoleCh2En(row.Role);
         var msg_flag = row.MsgFlagEn;
         //$("input[type=radio][name='mgmf_msg_flag_radio'][value=" + msg_flag + "]").attr("checked", 'checked');//此方法存在问题，当修改单选按钮值，并且关闭对话框，再打开对话时，无法选中真正的值
         var mgmf_msg_flag_radio = document.mgmf_form.mgmf_msg_flag_radio;
         for (var i = 0; i < mgmf_msg_flag_radio.length; i++) {
            if (mgmf_msg_flag_radio[i].value == msg_flag) {
               mgmf_msg_flag_radio[i].checked = true;
               break;
            }
         }
         $('#modify_group_msg_flag_dialog').modal('show');

      },
      'click .logout': function(e, value, row, index) {
         if (row.Role == '群主' && row.TypeEn != 'Private') {
            alert('您是群主，不能从公开群或聊天室退出');
            return;
         }
         if (confirm("确定退出该群吗？")) {
            quitGroup(row.GId);
         }
      },
      'click .pencil': function(e, value, row, index) {

         //成员可以修改私有群的基本资料
         if (row.Role == '成员' && row.Type != 'Private') {
            alert('你不是群主或管理员，无法进行此操作');
            return;
         }
         $('#mg_sel_row_index').val(index);
         $('#mg_group_id').val(row.GId);
         $('#mg_faceurl').val(row.FaceUrl);
         $('#mg_name').val(webim.Tool.formatHtml2Text(row.Name));
         $('#mg_introduction').val(webim.Tool.formatHtml2Text(row.Introduction));
         $('#mg_notification').val(webim.Tool.formatHtml2Text(row.Notification));
         $('#modify_group_dialog').modal('show');
         var shut_up_all = document.mg_form.mgm_up_all_radio;
         for (var i = 0; i < shut_up_all.length; i++) {
            if (shut_up_all[i].value == row.ShutUpAllMember) {
               shut_up_all[i].checked = true;
               break;
            }
         }
         //  $('#shut_up_all_member').val(row.ShutUpAllMember);
      },
      'click .share': function(e, value, row, index) {
         if (row.Role != '群主') {
            alert('你不是群主，无法进行此操作');
         } else {
            if (row.TypeEn == 'AVChatRoom') {
               alert('直播聊天室不能进行转让');
               return;
            }
            $("#cgo_form")[0].reset(); //清空原来表单的值
            $('#cgo_sel_row_index').val(index);
            $('#cgo_group_id').val(row.GId);
            $('#change_group_owner_dialog').modal('show');
         }
      },
      'click .trash': function(e, value, row, index) {
         if (row.Role != '群主') {
            alert('你不是群主，无法进行此操作');
         } else {
            if (row.TypeEn == 'Private') {
               alert('您是群主，不能解散私有群');
               return;
            }
            if (confirm("确定解散该群组吗？")) {
               destroyGroup(row.GId);
            }
         }
      },
      'click .envelope': function(e, value, row, index) {
         $('#sgm_to_groupid').val(row.GId);
         $('#sgm_to_group_name').val(row.Name);

         $('#send_group_msg_dialog').modal('show');
      }
   };
   //初始化我的群组表格

   function initGetMyGroupTable(data) {
      $('#get_my_group_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "GroupId",
            title: "ID",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Type",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "TypeEn",
            title: "类型(英文)",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "FaceUrl",
            title: "群头像",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Name",
            title: "名称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "RoleEn",
            title: "角色(英文)",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Role",
            title: "角色",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MsgFlagEn",
            title: "消息提示类型(英文)",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "MsgFlag",
            title: "消息提示类型",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "JoinTime",
            title: "加入时间",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MemberNum",
            title: "成员数",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Notification",
            title: "公告",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Introduction",
            title: "简介",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "ShutUpAllMember",
            title: "全局禁言",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "gmgOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "gmgOperateFormatter",
            events: "gmgOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }
   //定义邀请好友加群表格每行的操作按钮

   function gmfgOperateFormatter(value, row, index) {
      return [
         '<a class="plus" href="javascript:void(0)" title="邀请加入">',
         '<i class="glyphicon glyphicon-plus"></i>',
         '</a>'

      ].join('');
   }
   //邀请好友加群表格每行按钮单击事件
   window.gmfgOperateEvents = {
      'click .plus': function(e, value, row, index) {
         $('#agm_group_id').val($('#gmfg_group_id').val());
         $('#agm_account').val(row.Info_Account);
         $('#add_group_member_dialog').modal('show');
      }
   };
   //初始化邀请好友加群表格

   function initGetMyFriendGroupTable(data) {
      $('#get_my_friend_group_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "Info_Account",
            title: "账号",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Nick",
            title: "昵称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "gmfgOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "gmfgOperateFormatter",
            events: "gmfgOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //读取群组公开资料-高级接口（可用于搜索群，按ID）
   var getGroupPublicInfo = function() {
      if ($("#sg_group_id").val().length == 0) {
         alert('请输入群组ID');
         return;
      }
      if (webim.Tool.trimStr($("#sg_group_id").val()).length == 0) {
         alert('您输入的群组ID全是空格,请重新输入');
         return;
      }
      var options = {
         'GroupIdList': [
            $("#sg_group_id").val()
         ],
         'GroupBasePublicInfoFilter': [
            'Type',
            'Name',
            'Introduction',
            'Notification',
            'FaceUrl',
            'CreateTime',
            'Owner_Account',
            'LastInfoTime',
            'LastMsgTime',
            'NextMsgSeq',
            'MemberNum',
            'MaxMemberNum',
            'ApplyJoinOption'
         ]
      };
      webim.getGroupPublicInfo(
         options,
         function(resp) {
            var data = [];
            if (resp.GroupInfo && resp.GroupInfo.length > 0) {
               for (var i in resp.GroupInfo) {
                  if (resp.GroupInfo[i].ErrorCode > 0) {
                     alert(resp.GroupInfo[i].ErrorInfo);
                     return;
                  }
                  var group_id = resp.GroupInfo[i].GroupId;
                  var name = webim.Tool.formatText2Html(resp.GroupInfo[i].Name);
                  var type_zh = webim.Tool.groupTypeEn2Ch(resp.GroupInfo[i].Type);
                  var type = resp.GroupInfo[i].Type;
                  var owner_account = resp.GroupInfo[i].Owner_Account;
                  var create_time = webim.Tool.formatTimeStamp(resp.GroupInfo[i].CreateTime);
                  var member_num = resp.GroupInfo[i].MemberNum;
                  var notification = webim.Tool.formatText2Html(resp.GroupInfo[i].Notification);
                  var introduction = webim.Tool.formatText2Html(resp.GroupInfo[i].Introduction);
                  data.push({
                     'GId': group_id,
                     'GroupId': webim.Tool.formatText2Html(group_id),
                     'Name': name,
                     'TypeZh': type_zh,
                     'Type': type,
                     'Owner_Account': owner_account,
                     'MemberNum': member_num,
                     'Notification': notification,
                     'Introduction': introduction,
                     'CreateTime': create_time
                  });
               }
            }
            $('#search_group_table').bootstrapTable('load', data);
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //搜索群（按名称）
   var searchGroupByName = function() {
      if ($("#sgbn_group_name").val().length == 0) {
         alert('请输入群名称');
         return;
      }
      if (webim.Tool.trimStr($("#sgbn_group_name").val()).length == 0) {
         alert('您输入的群名称都是空格,请重新输入');
         return;
      }
      var options = {
         'Content': $("#sgbn_group_name").val(), //群名称
         "PageNum": 0, //0表示从第1页开始拉取
         "GroupPerPage": 20, //每页拉取20条
         'ResponseFilter': {
            "GroupBasePublicInfoFilter": [ //基础信息过滤器，可以通过它设置需要拉取的公开的基础信息
               'Type', //群组类型
               'Name', //群名称
               "FaceUrl", //群头像
               "Introduction", //群简介
               'CreateTime', //群创建时间
               'Owner_Account', //群创建者
               'MemberNum', //成员个数
               'MaxMemberNum', //群成员最大个数
               'ApplyJoinOption' //申请加群选项
            ]
         }
      };
      webim.searchGroupByName(
         options,
         function(resp) {
            var data = [];
            if (resp.GroupInfo && resp.GroupInfo.length > 0) {
               for (var i in resp.GroupInfo) {
                  if (resp.GroupInfo[i].ErrorCode > 0) {
                     alert(resp.GroupInfo[i].ErrorInfo);
                     return;
                  }
                  var group_id = resp.GroupInfo[i].GroupId;
                  var name = webim.Tool.formatText2Html(resp.GroupInfo[i].Name);
                  var type_zh = webim.Tool.groupTypeEn2Ch(resp.GroupInfo[i].Type);
                  var type = resp.GroupInfo[i].Type;
                  var owner_account = resp.GroupInfo[i].Owner_Account;
                  var create_time = webim.Tool.formatTimeStamp(resp.GroupInfo[i].CreateTime);
                  var member_num = resp.GroupInfo[i].MemberNum;
                  var faceUrl = resp.GroupInfo[i].FaceUrl;
                  var introduction = webim.Tool.formatText2Html(resp.GroupInfo[i].Introduction);
                  //var maxMemberNum = resp.GroupInfo[i].MaxMemberNum;
                  //var applyJoinOption = resp.GroupInfo[i].ApplyJoinOption;
                  data.push({
                     'GId': group_id,
                     'GroupId': webim.Tool.formatText2Html(group_id),
                     'Name': name,
                     'TypeZh': type_zh,
                     'Type': type,
                     'Owner_Account': owner_account,
                     'MemberNum': member_num,
                     'FaceUrl': faceUrl,
                     'Introduction': introduction,
                     'CreateTime': create_time
                  });
               }
            }
            $('#search_group_by_name_table').bootstrapTable('load', data);
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //创建群组
   var createGroup = function() {
      var sel_friends = $('#select_friends').val();

      var member_list = [];
      var members = sel_friends.split(";"); //字符分割
      for (var i = 0; i < members.length; i++) {
         if (members[i] && members[i].length > 0) {
            member_list.push(members[i]);
         }
      }
      var faceurl = $("#cg_faceurl").val();
      var cg_id = $("#cg_id").val().trim();
      if (cg_id && !/^[A-Za-z0-9_]+$/gi.test(cg_id)) {
         alert('群组ID只能是数字、字母或下划线');
         return
      }
      if ($("#cg_name").val().length == 0) {
         alert('请输入群组名称');
         return;
      }
      if ($("#cg_name").val().length == 0) {
         alert('请输入群组名称');
         return;
      }
      if (webim.Tool.trimStr($("#cg_name").val()).length == 0) {
         alert('您输入的群组名称全是空格,请重新输入');
         return;
      }
      if (webim.Tool.getStrBytes($("#cg_name").val()) > 30) {
         alert('您输入的群组名称超出限制(最长10个汉字)');
         return;
      }
      if (webim.Tool.getStrBytes($("#cg_notification").val()) > 150) {
         alert('您输入的群组公告超出限制(最长50个汉字)');
         return;
      }
      if (webim.Tool.getStrBytes($("#cg_introduction").val()) > 120) {
         alert('您输入的群组简介超出限制(最长40个汉字)');
         return;
      }
      var groupType = $('input[name="cg_type_radio"]:checked').val();
      var options = {
         'GroupId': cg_id,
         'Owner_Account': loginInfo.identifier,
         'Type': groupType, //Private/Public/ChatRoom/AVChatRoom
         'Name': $("#cg_name").val(),
         'Notification': $("#cg_notification").val(),
         'Introduction': $('#cg_introduction').val(),
         'MemberList': member_list
      };
      if (faceurl) {
         options.FaceUrl = faceurl;
      }
      if (groupType != 'Private') { //非私有群才支持ApplyJoinOption属性
         options.ApplyJoinOption = $('input[name="cg_ajp_type_radio"]:checked').val();
      }
      webim.createGroup(
         options,
         function(resp) {
            $('#create_group_dialog').modal('hide');
            alert('创建群成功');
            //读取我的群组列表
            //getJoinedGroupListHigh(getGroupsCallbackOK);
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //修改群资料
   var modifyGroup = function() {
      var faceurl = $("#mg_faceurl").val();
      if ($("#mg_name").val().length == 0) {
         alert('请输入群组名称');
         return;
      }
      if (webim.Tool.trimStr($("#mg_name").val()).length == 0) {
         alert('您输入的群组名称全是空格,请重新输入');
         return;
      }
      if (webim.Tool.getStrBytes($("#fsm_name").val()) > 30) {
         alert('您输入的群组名称超出限制(最长10个汉字)');
         return;
      }
      if (webim.Tool.getStrBytes($("#fsm_notification").val()) > 150) {
         alert('您输入的群组公告超出限制(最长50个汉字)');
         return;
      }
      if (webim.Tool.getStrBytes($("#fsm_introduction").val()) > 120) {
         alert('您输入的群组简介超出限制(最长40个汉字)');
         return;
      }
      var up_all = $('input[name="mgm_up_all_radio"]:checked').val();
      var options = {
         'GroupId': $('#mg_group_id').val(),
         'Name': $('#mg_name').val(),
         'Notification': $('#mg_notification').val(),
         'Introduction': $('#mg_introduction').val(),
         'ShutUpAllMember': up_all
      };
      if (faceurl) {
         options.FaceUrl = faceurl;
      }
      webim.modifyGroupBaseInfo(
         options,
         function(resp) {
            //在表格中修改对应的行
            $('#get_my_group_table').bootstrapTable('updateRow', {
               index: $('#mg_sel_row_index').val(),
               row: {
                  Type: $('input[name="mg_type_radio"]:checked').val(),
                  Name: webim.Tool.formatText2Html($('#mg_name').val()),
                  Introduction: webim.Tool.formatText2Html($('#mg_introduction').val()),
                  Notification: webim.Tool.formatText2Html($('#mg_notification').val())
               }
            });
            $('#modify_group_dialog').modal('hide');
            alert('修改群资料成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //转让群组
   var changeGroupOwner = function() {
      var newOwer = $("#cgo_new_owner").val();
      if (newOwer.length == 0) {
         alert('请输入新的群主账号');
         return;
      }
      if (webim.Tool.trimStr(newOwer).length == 0) {
         alert('您输入的新群主账号全是空格,请重新输入');
         return;
      }
      if (newOwer == loginInfo.identifier) {
         alert('不能给自己转让群组');
         return;
      }

      var options = {
         'GroupId': $('#cgo_group_id').val(),
         'NewOwner_Account': newOwer
      };
      webim.changeGroupOwner(
         options,
         function(resp) {
            //在表格中修改对应的行
            $('#get_my_group_table').bootstrapTable('updateRow', {
               index: $('#cgo_sel_row_index').val(),
               row: {
                  RoleEn: "Member",
                  Role: "成员"
               }
            });
            $('#change_group_owner_dialog').modal('hide');
            alert('转让群组成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //申请加群
   var applyJoinGroup = function() {
      if (webim.Tool.getStrBytes($("#ajg_apply_msg").val()) > 300) {
         alert('您输入的附言超出限制(最长100个汉字)');
         return;
      }
      var options = {
         'GroupId': $("#ajg_group_id").val(),
         'ApplyMsg': $("#ajg_apply_msg").val(),
         'UserDefinedField': ''
      };
      webim.applyJoinGroup(
         options,
         function(resp) {
            $('#apply_join_group_dialog').modal('hide');
            var joinedStatus = resp.JoinedStatus; //JoinedSuccess--成功加入，WaitAdminApproval--等待管理员审核
            if (joinedStatus == "JoinedSuccess") {
               //刷新我的群组列表
               //getJoinedGroupListHigh(getGroupsCallbackOK);
               alert('成功加入该群');
            } else {
               alert('申请成功，请等待群主审核');
            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //获取我的群组
   var getMyGroup = function() {
      initGetMyGroupTable([]);
      var options = {
         'Member_Account': loginInfo.identifier,
         'Limit': totalCount,
         'Offset': 0,
         //'GroupType':'',
         'GroupBaseInfoFilter': [
            'Type',
            'Name',
            'Introduction',
            'Notification',
            'FaceUrl',
            'CreateTime',
            'Owner_Account',
            'LastInfoTime',
            'LastMsgTime',
            'NextMsgSeq',
            'MemberNum',
            'MaxMemberNum',
            'ApplyJoinOption',
            'ShutUpAllMember'
         ],
         'SelfInfoFilter': [
            'Role',
            'JoinTime',
            'MsgFlag',
            'UnreadMsgNum'
         ]
      };
      webim.getJoinedGroupListHigh(
         options,
         function(resp) {
            if (!resp.GroupIdList || resp.GroupIdList.length == 0) {
               alert('你目前还没有加入任何群组');
               return;
            }
            var data = [];
            for (var i = 0; i < resp.GroupIdList.length; i++) {

               var group_id = resp.GroupIdList[i].GroupId;
               var name = webim.Tool.formatText2Html(resp.GroupIdList[i].Name);
               var faceUrl = resp.GroupIdList[i].FaceUrl;
               var type_en = resp.GroupIdList[i].Type;
               var type = webim.Tool.groupTypeEn2Ch(resp.GroupIdList[i].Type);
               var role_en = resp.GroupIdList[i].SelfInfo.Role;
               var role = webim.Tool.groupRoleEn2Ch(resp.GroupIdList[i].SelfInfo.Role);
               var msg_flag = webim.Tool.groupMsgFlagEn2Ch(resp.GroupIdList[i].SelfInfo.MsgFlag);
               var msg_flag_en = resp.GroupIdList[i].SelfInfo.MsgFlag;
               var join_time = webim.Tool.formatTimeStamp(resp.GroupIdList[i].SelfInfo.JoinTime);
               var member_num = resp.GroupIdList[i].MemberNum;
               var notification = webim.Tool.formatText2Html(resp.GroupIdList[i].Notification);
               var introduction = webim.Tool.formatText2Html(resp.GroupIdList[i].Introduction);
               var ShutUpAllMember = resp.GroupIdList[i].ShutUpAllMember; //== 'On' ? resp.GroupIdList[i].ShutUpAllMember = '开启' : resp.GroupIdList[i].ShutUpAllMember = '关闭';
               data.push({
                  'GId': group_id,
                  'GroupId': webim.Tool.formatText2Html(group_id),
                  'Name': name,
                  'FaceUrl': faceUrl,
                  'TypeEn': type_en,
                  'Type': type,
                  'RoleEn': role_en,
                  'Role': role,
                  'MsgFlagEn': msg_flag_en,
                  'MsgFlag': msg_flag,
                  'MemberNum': member_num,
                  'Notification': notification,
                  'Introduction': introduction,
                  'JoinTime': join_time,
                  'ShutUpAllMember': ShutUpAllMember
               });
            }
            //打开我的群组列表对话框
            $('#get_my_group_table').bootstrapTable('load', data);
            $('#get_my_group_dialog').modal('show');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //退群
   var quitGroup = function(group_id) {
      var options = null;
      if (group_id) {
         options = {
            'GroupId': group_id
         };
      }
      if (options == null) {
         alert('退群时，群组ID非法');
         return;
      }
      webim.quitGroup(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_my_group_table').bootstrapTable('remove', {
               field: 'GroupId',
               values: [group_id]
            });
            //刷新我的群组列表
            //getJoinedGroupListHigh(getGroupsCallbackOK);
            deleteSessDiv(webim.SESSION_TYPE.GROUP, group_id); //在最近的联系人列表删除可能存在的群会话
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //读取群组基本资料-高级接口
   var getGroupInfo = function(group_id, cbOK, cbErr) {
      var options = {
         'GroupIdList': [
            group_id
         ],
         'GroupBaseInfoFilter': [
            'Type',
            'Name',
            'Introduction',
            'Notification',
            'FaceUrl',
            'CreateTime',
            'Owner_Account',
            'LastInfoTime',
            'LastMsgTime',
            'NextMsgSeq',
            'MemberNum',
            'MaxMemberNum',
            'ApplyJoinOption',
            'ShutUpAllMember'
         ],
         'MemberInfoFilter': [
            'Account',
            'Role',
            'JoinTime',
            'LastSendMsgTime',
            'ShutUpUntil'
         ]
      };
      webim.getGroupInfo(
         options,
         function(resp) {
            if (resp.GroupInfo[0].ShutUpAllMember == 'On') {
               alert('该群组已开启全局禁言');
            }
            if (cbOK) {
               cbOK(resp);
            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //解散群组
   var destroyGroup = function(group_id) {
      var options = null;
      if (group_id) {
         options = {
            'GroupId': group_id
         };
      }
      if (options == null) {
         alert('解散群时，群组ID非法');
         return;
      }
      webim.destroyGroup(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_my_group_table').bootstrapTable('remove', {
               field: 'GroupId',
               values: [group_id]
            });
            //读取我的群组列表
            //getJoinedGroupListHigh(getGroupsCallbackOK);
            deleteSessDiv(webim.SESSION_TYPE.GROUP, group_id); //在最近的联系人列表删除可能存在的群会话
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //获取我的好友，然后邀请加群
   var getMyFriendGroup = function() {

      initGetMyFriendGroupTable([]);
      var options = {
         'From_Account': loginInfo.identifier,
         'TimeStamp': 0,
         'StartIndex': 0,
         'GetCount': totalCount,
         'LastStandardSequence': 0,
         "TagList": [
            "Tag_Profile_IM_Nick",
            "Tag_SNS_IM_Remark"
         ]
      };

      webim.getAllFriend(
         options,
         function(resp) {

            if (resp.FriendNum > 0) {
               var table_friends_data = [];
               var friends = resp.InfoItem;
               if (!friends || friends.length == 0) {
                  alert('你目前还没有好友，无法邀请好友加入该群');
                  return;
               }
               var count = friends.length;

               for (var i = 0; i < count; i++) {
                  var friend_name = friends[i].Info_Account;
                  if (friends[i].SnsProfileItem && friends[i].SnsProfileItem[0] && friends[i].SnsProfileItem[0].Tag) {
                     friend_name = friends[i].SnsProfileItem[0].Value;
                  }

                  table_friends_data.push({
                     'Info_Account': webim.Tool.formatText2Html(friends[i].Info_Account),
                     'Nick': webim.Tool.formatText2Html(friend_name)
                  });
               }
               //打开我的好友列表对话框
               $('#get_my_friend_group_table').bootstrapTable('load', table_friends_data);
               $('#get_my_friend_group_dialog').modal('show');

            } else {
               alert('你目前还没有好友，无法邀请好友加入该群');
            }

         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };


   //选择我的好友
   var selectMyFriendGroup = function() {

      initSelectMyFriendGroupTable([]);
      var options = {
         'From_Account': loginInfo.identifier,
         'TimeStamp': 0,
         'StartIndex': 0,
         'GetCount': totalCount,
         'LastStandardSequence': 0,
         "TagList": [
            "Tag_Profile_IM_Nick",
            "Tag_SNS_IM_Remark"
         ]
      };

      webim.getAllFriend(
         options,
         function(resp) {

            if (resp.FriendNum > 0) {
               var table_friends_data = [];
               var friends = resp.InfoItem;
               if (!friends || friends.length == 0) {
                  alert('你目前还没有好友，无法建群');
                  return;
               }
               var count = friends.length;

               for (var i = 0; i < count; i++) {
                  var friend_name = friends[i].Info_Account;
                  if (friends[i].SnsProfileItem && friends[i].SnsProfileItem[0] && friends[i].SnsProfileItem[0].Tag) {
                     friend_name = friends[i].SnsProfileItem[0].Value;
                  }

                  table_friends_data.push({
                     'Info_Account': webim.Tool.formatText2Html(friends[i].Info_Account),
                     'Nick': webim.Tool.formatText2Html(friend_name)
                  });
               }
               //打开选择我的好友列表对话框
               $('#select_my_friend_group_table').bootstrapTable('load', table_friends_data);
               $('#select_my_friend_group_dialog').modal('show');

            } else {
               alert('你目前还没有好友，无法建群');
            }

         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //定义（创建群之前）选择好友表格每行按钮

   function smfgOperateFormatter(value, row, index) {
      return [
         '<a class="plus" href="javascript:void(0)" title="选中">',
         '<i class="glyphicon glyphicon-plus"></i>',
         '</a>',
         '<a class="minus" href="javascript:void(0)" title="取消">',
         '<i class="glyphicon glyphicon-minus"></i>',
         '</a>',
      ].join('');
   }
   //（创建群之前）选择好友表格每行按钮单击事件
   window.smfgOperateEvents = {
      'click .plus': function(e, value, row, index) {

         var sel_friends = $('#select_friends').val();
         var account = row.Info_Account;
         //先判断是否已选择
         if (sel_friends && sel_friends != '') {
            var pos = sel_friends.indexOf(";" + account + ";");
            if (pos >= 0) {
               alert('已选择该好友，请选择其他好友');
               return;
            }
         } else {
            sel_friends = ';';
         }
         sel_friends += row.Info_Account + ";";
         $('#select_friends').val(sel_friends);
         alert('选择成功');

      },
      'click .minus': function(e, value, row, index) {
         var sel_friends = $('#select_friends').val();
         var account = row.Info_Account;
         //先判断是否已选择
         if (!sel_friends || sel_friends == '') {

            alert('还未选择好友，不能进行此操作');
            return;


         } else {
            var pos = sel_friends.indexOf(";" + account + ";");
            var strlen = (account + ";").length;
            if (pos >= 0) {
               var begin = sel_friends.substr(0, pos);
               var end = sel_friends.substr(pos + strlen);
               var new_sel_friends = begin + end;
            } else {
               alert('未选择该好友，不能进行此操作');
               return;
            }

         }
         if (new_sel_friends == ';') {
            new_sel_friends = '';
         }
         $('#select_friends').val(new_sel_friends);
         alert('取消成功');
      }
   };
   //初始化（创建群之前）选择好友表格

   function initSelectMyFriendGroupTable(data) {
      $('#select_my_friend_group_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "Info_Account",
            title: "账号",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Nick",
            title: "昵称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "smfgOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "smfgOperateFormatter",
            events: "smfgOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //从我的群组列表中发群消息

   function sendGroupMsg() {

      toAccount = $("#sgm_to_groupid").val();
      toName = $("#sgm_to_group_name").val();
      msgtosend = $("#sgm_content").val();

      var msgLen = webim.Tool.getStrBytes(msgtosend);

      var maxLen, errInfo;

      maxLen = webim.MSG_MAX_LENGTH.GROUP;
      errInfo = "消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)";

      if (msgtosend.length < 1) {
         alert("发送的消息不能为空!");
         return;
      }

      if (msgLen > maxLen) {
         alert(errInfo);
         return;
      }

      var sess = webim.MsgStore.sessByTypeId(webim.SESSION_TYPE.GROUP, toAccount);
      if (!sess) {
         sess = new webim.Session(webim.SESSION_TYPE.GROUP, toAccount, toName, groupHeadUrl, Math.round(new Date().getTime() / 1000));
      }
      var isSend = true; //是否为自己发送
      var seq = -1; //消息序列，-1表示sdk自动生成，用于去重
      var random = Math.round(Math.random() * 4294967296); //消息随机数，用于去重
      var msgTime = Math.round(new Date().getTime() / 1000); //消息时间戳
      var subType; //消息子类型

      subType = webim.GROUP_MSG_SUB_TYPE.COMMON;

      var msg = new webim.Msg(sess, isSend, seq, random, msgTime, loginInfo.identifier, subType, loginInfo.identifierNick);

      var text_obj;

      text_obj = new webim.Msg.Elem.Text(msgtosend);
      msg.addText(text_obj);

      webim.sendMsg(msg, function(resp) {

         if (!selToID) { //没有聊天会话
            selType = webim.SESSION_TYPE.GROUP;
            selToID = toAccount;
            selSess = sess;
            addSess(selType, toAccount, toName, groupHeadUrl, 0, 'sesslist');
            setSelSessStyleOn(toAccount);
            //群聊时，长轮询接口会返回自己发的消息
            //addMsg(msg);
         } else { //有聊天会话
            if (selToID == toAccount) { //聊天对象不变
               //不做任何操作
            } else { //聊天对象发生改变
               var tempSessDiv = document.getElementById("sessDiv_" + toAccount);
               if (!tempSessDiv) { //不存在这个会话
                  addSess(webim.SESSION_TYPE.GROUP, toAccount, toName, groupHeadUrl, 0, 'sesslist'); //增加一个会话
               }
               onSelSess(webim.SESSION_TYPE.GROUP, toAccount); //再进行切换
            }
         }
         webim.Tool.setCookie("tmpmsg_" + toAccount, '', 0);
         $("#sgm_content").val('');
         $('#send_group_msg_dialog').modal('hide');
         $('#get_my_group_dialog').modal('hide');

      }, function(err) {
         alert(err.ErrorInfo);
         $("#sgm_content").val('');
      });
   }

   //将我的群组资料（群名称和群头像）保存在infoMap
   var initInfoMapByMyGroups = function(cbOK) {

      var options = {
         'Member_Account': loginInfo.identifier,
         'Limit': totalCount,
         'Offset': 0,
         'GroupBaseInfoFilter': [
            'Name',
            'FaceUrl'
         ]
      };
      webim.getJoinedGroupListHigh(
         options,
         function(resp) {
            if (resp.GroupIdList && resp.GroupIdList.length) {
               for (var i = 0; i < resp.GroupIdList.length; i++) {
                  var group_name = resp.GroupIdList[i].Name;
                  var group_image = resp.GroupIdList[i].FaceUrl;
                  var key = webim.SESSION_TYPE.GROUP + "_" + resp.GroupIdList[i].GroupId;
                  infoMap[key] = {
                     'name': group_name,
                     'image': group_image
                  }
               }
            }
            if (cbOK) {
               cbOK();
            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //定义群组成员表格每行的按钮

   function ggmOperateFormatter(value, row, index) {
      return [
         '<a class="pencil ml10" href="javascript:void(0)" title="修改群成员角色">',
         '<i class="glyphicon glyphicon-pencil"></i>',
         '</a>',
         '<a class="time ml10" href="javascript:void(0)" title="设置禁言时间">',
         '<i class="glyphicon glyphicon-time"></i>',
         '</a>',
         '<a class="remove ml10" href="javascript:void(0)" title="移除该成员">',
         '<i class="glyphicon glyphicon-remove"></i>',
         '</a>'

      ].join('');
   }
   //定义群组成员表格每行的按钮单击事件
   window.ggmOperateEvents = {
      'click .remove': function(e, value, row, index) {
         switch ($('#ggm_my_role').val()) {
            case '成员':
               alert('你不是管理员，无法进行此操作');
               break;
            case '管理员':
               if (row.Role == '成员') {
                  $('#dgm_group_id').val($('#ggm_group_id').val());
                  $('#dgm_account').val(row.Member_Account);
                  $('#delete_group_member_dialog').modal('show');
               } else {
                  alert('你不能移除群主或管理员');
               }
               break;
            case '群主':
               if (row.Role == '群主') {
                  alert('你不能移除自己');
               } else {
                  $('#dgm_group_id').val($('#ggm_group_id').val());
                  $('#dgm_account').val(row.Member_Account);
                  $('#delete_group_member_dialog').modal('show');
               }
               break;
         }
      },
      'click .pencil': function(e, value, row, index) {


         switch ($('#ggm_my_role').val()) {
            case '成员':
               alert('你不是群主，无法进行此操作');
               break;
            case '管理员':
               alert('你不是群主，无法进行此操作');
               break;
            case '群主':
               if ($('#ggm_group_type').val() == 'Private') {
                  alert('私有群不支持设置群成员角色操作');
                  return;
               }
               if (row.Role == '群主') {
                  alert('你不能设置自己的群角色');
               } else {
                  $('#mgm_sel_row_index').val(index);
                  $('#mgm_group_id').val($('#ggm_group_id').val());
                  $('#mgm_account').val(row.Member_Account);
                  //设置群身份
                  var role_en = webim.Tool.groupRoleCh2En(row.Role);
                  //$("input[type=radio][name='mgm_role_radio'][value=" + role_en + "]").attr("checked", 'checked');
                  var mgm_role_radio = document.mgm_form.mgm_role_radio;
                  for (var i = 0; i < mgm_role_radio.length; i++) {
                     if (mgm_role_radio[i].value == role_en) {
                        mgm_role_radio[i].checked = true;
                        break;
                     }
                  }
                  $('#modify_group_member_dialog').modal('show');
               }
               break;
         }
      },
      'click .time': function(e, value, row, index) {
         switch ($('#ggm_my_role').val()) {
            case '成员':
               alert('你不是管理员，无法进行此操作');
               break;
            case '管理员':
               if (row.Role == '成员') {
                  $('#fsm_sel_row_index').val(index);
                  $('#fsm_group_id').val($('#ggm_group_id').val());
                  $('#fsm_account').val(row.Member_Account);

                  var shutup_time = 0;
                  if (row.ShutUpUntil != '-') {

                     var shutup_until_time = new Date(row.ShutUpUntil).getTime();
                     var now_time = new Date().getTime();
                     shutup_time = shutup_until_time - now_time;
                     if (shutup_time > 0) {
                        shutup_time = Math.round(shutup_time / 1000);
                     } else {
                        shutup_time = 0;
                     }
                  }
                  $('#fsm_shut_up_time').val(shutup_time);
                  $('#forbid_send_msg_dialog').modal('show');
               } else {
                  alert('你不能设置群主或管理禁言时间');
               }
               break;
            case '群主':
               if (row.Role == '群主') {
                  alert('你不能对自己设置禁言时间');
               } else {

                  $('#fsm_sel_row_index').val(index);
                  $('#fsm_group_id').val($('#ggm_group_id').val());
                  $('#fsm_account').val(row.Member_Account);

                  var shutup_time = 0;

                  if (row.ShutUpUntil != '-') {

                     var shutup_until_time = new Date(row.ShutUpUntil).getTime();
                     var now_time = new Date().getTime();
                     shutup_time = shutup_until_time - now_time;
                     if (shutup_time > 0) {
                        shutup_time = Math.round(shutup_time / 1000);
                     } else {
                        shutup_time = 0;
                     }
                  }
                  $('#fsm_shut_up_time').val(shutup_time);
                  $('#forbid_send_msg_dialog').modal('show');
               }
               break;
         }
      }
   };
   //初始化群组成员表格

   function initGetGroupMemberTable(data) {
      $('#get_group_member_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "GroupId",
            title: "群ID",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Member_Account",
            title: "帐号",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Role",
            title: "角色",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "JoinTime",
            title: "入群时间",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "ShutUpUntil",
            title: "禁言截至时间",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "ggmOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "ggmOperateFormatter",
            events: "ggmOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //读取群组成员
   var getGroupMemberInfo = function(group_id) {
      initGetGroupMemberTable([]);
      var options = {
         'GroupId': group_id,
         'Offset': 0, //必须从0开始
         'Limit': totalCount,
         'MemberInfoFilter': [
            'Account',
            'Role',
            'JoinTime',
            'LastSendMsgTime',
            'ShutUpUntil'
         ]
      };
      webim.getGroupMemberInfo(
         options,
         function(resp) {
            if (resp.MemberNum <= 0) {
               alert('该群组目前没有成员');
               return;
            }
            var data = [];
            for (var i in resp.MemberList) {
               var account = resp.MemberList[i].Member_Account;
               var role = webim.Tool.groupRoleEn2Ch(resp.MemberList[i].Role);
               var join_time = webim.Tool.formatTimeStamp(resp.MemberList[i].JoinTime);
               var shut_up_until = webim.Tool.formatTimeStamp(resp.MemberList[i].ShutUpUntil);
               if (shut_up_until == 0) {
                  shut_up_until = '-';
               }
               data.push({
                  GId: group_id,
                  GroupId: webim.Tool.formatText2Html(group_id),
                  Member_Account: webim.Tool.formatText2Html(account),
                  Role: role,
                  JoinTime: join_time,
                  ShutUpUntil: shut_up_until
               });
            }
            $('#get_group_member_table').bootstrapTable('load', data);
            $('#get_group_member_dialog').modal('show');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //修改群组成员角色
   var modifyGroupMemberRole = function() {
      var role_en = $('input[name="mgm_role_radio"]:checked').val();
      var role_zh = webim.Tool.groupRoleEn2Ch(role_en);
      var options = {
         'GroupId': $('#mgm_group_id').val(),
         'Member_Account': $('#mgm_account').val(),
         'Role': role_en
      };
      webim.modifyGroupMember(
         options,
         function(resp) {
            //在表格中修改对应的行
            $('#get_group_member_table').bootstrapTable('updateRow', {
               index: $('#mgm_sel_row_index').val(),
               row: {
                  Role: role_zh
               }
            });
            $('#modify_group_member_dialog').modal('hide');
            alert('修改群成员角色成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //设置成员禁言时间
   var forbidSendMsg = function() {
      if (!webim.Tool.validNumber($('#fsm_shut_up_time').val())) {
         alert('您输入的禁言时间非法,只能是数字(0-31536000)');
         return;
      }
      var shut_up_time = parseInt($('#fsm_shut_up_time').val());
      if (shut_up_time > 31536000) {
         alert('您输入的禁言时间非法,只能是数字(0-31536000)');
         return;
      }
      var shut_up_until = '-';
      if (shut_up_time != 0) {
         //当前时间+禁言时间=禁言截至时间
         shut_up_until = webim.Tool.formatTimeStamp(Math.round(new Date().getTime() / 1000) + shut_up_time);
      }
      var options = {
         'GroupId': $('#fsm_group_id').val(), //群id
         'Members_Account': [$('#fsm_account').val()], //被禁言的成员帐号列表
         'ShutUpTime': shut_up_time //禁言时间，单位：秒
      };
      webim.forbidSendMsg(
         options,
         function(resp) {
            //在表格中修改对应的行
            $('#get_group_member_table').bootstrapTable('updateRow', {
               index: $('#fsm_sel_row_index').val(),
               row: {
                  ShutUpUntil: shut_up_until
               }
            });
            $('#forbid_send_msg_dialog').modal('hide');
            alert('设置成员禁言时间成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //修改群消息提示类型
   var modifyGroupMsgFlag = function() {
      var msg_flag_en = $('input[name="mgmf_msg_flag_radio"]:checked').val();
      var msg_flag_zh = webim.Tool.groupMsgFlagEn2Ch(msg_flag_en);
      var options = {
         'GroupId': $('#mgmf_group_id').val(),
         'Member_Account': loginInfo.identifier,
         'MsgFlag': msg_flag_en
      };
      webim.modifyGroupMember(
         options,
         function(resp) {
            //在表格中修改对应的行
            $('#get_my_group_table').bootstrapTable('updateRow', {
               index: $('#mgmf_sel_row_index').val(),
               row: {
                  MsgFlag: msg_flag_zh,
                  MsgFlagEn: msg_flag_en
               }
            });
            $('#modify_group_msg_flag_dialog').modal('hide');
            alert('设置群消息提示类型成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //删除群组成员
   var deleteGroupMember = function() {
      if (!confirm("确定移除该成员吗？")) {
         return;
      }
      var options = {
         'GroupId': $('#dgm_group_id').val(),
         //'Silence': $('input[name="dgm_silence_radio"]:checked').val(),//只有ROOT用户采用权限设置该字段（是否静默移除）
         'MemberToDel_Account': [$('#dgm_account').val()]
      };
      webim.deleteGroupMember(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_group_member_table').bootstrapTable('remove', {
               field: 'Member_Account',
               values: [$('#dgm_account').val()]
            });
            $('#delete_group_member_dialog').modal('hide');
            alert('移除群成员成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //邀请好友加群
   var addGroupMember = function() {
      var options = {
         'GroupId': $('#agm_group_id').val(),
         'MemberList': [{
               'Member_Account': $('#agm_account').val()
            }

         ]
      };
      webim.addGroupMember(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_my_friend_group_table').bootstrapTable('remove', {
               field: 'Info_Account',
               values: [$('#agm_account').val()]
            });
            $('#add_group_member_dialog').modal('hide');
            alert('邀请好友加群成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   }; //定义我的加群申请表格每行按钮
   function gajgpOperateFormatter(value, row, index) {
      return [
         '<a class="edit" href="javascript:void(0)" title="处理">',
         '<i class="glyphicon glyphicon-edit"></i>',
         '</a>'

      ].join('');
   }
   //我的加群申请表格每行的按钮点击事件
   window.gajgpOperateEvents = {
      'click .edit': function(e, value, row, index) {

         $("#hajg_group_id").val(row.GroupId);
         $("#hajg_to_account").val(row.Operator_Account);
         $("#hajg_msg_key").val(row.MsgKey);
         $("#hajg_authentication").val(row.Authentication);
         $("#hajg_user_defined_field").val(row.UserDefinedField);

         $("#hajg_from_account").val(row.From_Account);
         $("#hajg_msg_seq").val(row.MsgSeq);
         $("#hajg_msg_random").val(row.MsgRandom);

         $('#handle_ajg_dialog').modal('show');
      }
   };
   //初始化我的加群申请表格
   function initGetApplyJoinGroupPendency(data) {
      $('#get_apply_join_group_pendency_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
               field: "GroupId",
               title: "群ID",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "GroupName",
               title: "群名称",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "Operator_Account",
               title: "对方账号",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            //{field: "ApplyNick", title: "对方昵称", align: "center", valign: "middle", sortable: "true"},

            {
               field: "MsgTime",
               title: "申请时间",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "RemarkInfo",
               title: "附言",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "MsgKey",
               title: "MsgKey",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "Authentication",
               title: "Authentication",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "UserDefinedField",
               title: "UserDefinedField",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "From_Account",
               title: "发送者",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "MsgSeq",
               title: "消息序号",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "MsgRandom",
               title: "消息随机数",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "gajgpOperate",
               title: "操作",
               align: "center",
               valign: "middle",
               formatter: "gajgpOperateFormatter",
               events: "gajgpOperateEvents"
            }
         ],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }


   //查看未决加群申请
   var getApplyJoinGroupPendency = function() {
      $('#get_apply_join_group_pendency_dialog').modal('show');
   };

   //处理加群申请
   var handleApplyJoinGroupPendency = function() {

      var options = {
         'GroupId': $("#hajg_group_id").val(), //群id
         'Applicant_Account': $("#hajg_to_account").val(), //申请人id
         'HandleMsg': $('input[name="hajg_action_radio"]:checked').val(), //Agree-同意 Reject-拒绝
         'Authentication': $("#hajg_authentication").val(), //申请凭证
         'MsgKey': $("#hajg_msg_key").val(),
         'ApprovalMsg': $("#hajg_approval_msg").val(), //处理附言
         'UserDefinedField': $("#hajg_group_id").val() //用户自定义字段
      };

      //要删除的群未决消息
      var delApplyJoinGroupPendencys = {
         'DelMsgList': [{
            "From_Account": $("#hajg_from_account").val(),
            "MsgSeq": parseInt($("#hajg_msg_seq").val()),
            "MsgRandom": parseInt($("#hajg_msg_random").val())
         }]
      };


      webim.handleApplyJoinGroupPendency(
         options,
         function(resp) {
            //在表格中删除对应的行
            $('#get_apply_join_group_pendency_table').bootstrapTable('remove', {
               field: 'Authentication',
               values: [$("#hajg_authentication").val()]
            });
            $('#handle_ajg_dialog').modal('hide');

            //删除已处理的加群未决消息，否则下次登录的时候会重复收到加群未决消息
            deleteApplyJoinGroupPendency(delApplyJoinGroupPendencys);

            alert('处理加群申请成功');

         },
         function(err) {

            alert(err.ErrorInfo);
         }
      );
   };

   //删除已处理的加群未决消息
   var deleteApplyJoinGroupPendency = function(opts) {

      webim.deleteApplyJoinGroupPendency(opts,
         function(resp) {
            webim.Log.info('delete group pendency msg success');
         },
         function(err) {
            alert(err.ErrorInfo);
            webim.Log.error('delete group pendency msg failed');
         }
      );
      return;
   };

   //tls登录

   function tlsLogin() {
      //跳转到TLS登录页面
      TLSHelper.goLogin({
         sdkappid: loginInfo.sdkAppID,
         acctype: loginInfo.accountType,
         url: window.location.href
      });
   }
   //第三方应用需要实现这个函数，并在这里拿到UserSig

   function tlsGetUserSig(res) {
      //成功拿到凭证
      if (res.ErrorCode == webim.TLS_ERROR_CODE.OK) {
         //从当前URL中获取参数为identifier的值
         loginInfo.identifier = webim.Tool.getQueryString("identifier");
         //拿到正式身份凭证
         loginInfo.userSig = res.UserSig;
         //从当前URL中获取参数为sdkappid的值
         loginInfo.sdkAppID = loginInfo.appIDAt3rd = Number(webim.Tool.getQueryString("sdkappid"));
         //从cookie获取accountType
         var accountType = webim.Tool.getCookie('accountType');
         if (accountType) {
            loginInfo.accountType = accountType;
            //sdk登录
            webimLogin();
         } else {
            alert('accountType非法');
         }

      } else {
         //签名过期，需要重新登录
         if (res.ErrorCode == webim.TLS_ERROR_CODE.SIGNATURE_EXPIRATION) {
            tlsLogin();
         } else {
            alert("[" + res.ErrorCode + "]" + res.ErrorInfo);
         }
      }
   }

   //sdk登录

   function webimLogin() {
      webim.login(
         loginInfo, listeners, options,
         function(resp) {
            loginInfo.identifierNick = resp.identifierNick; //设置当前用户昵称
            loginInfo.headurl = resp.headurl; //设置当前用户头像
            initDemoApp();
            // webim.getPendencyGroup({
            //         StartTime: 0,
            //         Limit: 10
            //     },
            //     function() {

            //     })
            webim.syncGroupMsgs({}, function(data) {
               console.debug(data);
            }, function(data) {
               console.debug(data);
            });
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   }
   //退出
   function quitClick() {
      if (loginInfo.identifier) {
         //sdk登出
         webim.logout(
            function(resp) {
               loginInfo.identifier = null;
               loginInfo.userSig = null;
               document.getElementById("webim_demo").style.display = "none";
               var indexUrl = window.location.href;
               var pos = indexUrl.indexOf('?');
               if (pos >= 0) {
                  indexUrl = indexUrl.substring(0, pos);
               }
               window.location.href = indexUrl;
            }
         );
      } else {
         alert('未登录');
      }
   }

   //被新实例踢下线的回调处理
   function onKickedEventCall() {
      alert('其他地方登录，被T了')
      webim.Log.error("其他地方登录，被T了");
      document.getElementById("webim_demo").style.display = "none";
   }



   //多终端登录被T
   function onMultipleDeviceKickedOut() {
      alert('多终端登录，被T了')
      webim.Log.error("多终端登录，被T了");
      document.getElementById("webim_demo").style.display = "none";
   }

   //获取历史消息(c2c或者group)成功回调函数
   //msgList 为消息数组，结构为[Msg]

   function getHistoryMsgCallback(msgList, prepage) {
      var msg;
      prepage = prepage || false;

      //如果是加载前几页的消息，消息体需要prepend，所以先倒排一下
      if (prepage) {
         msgList.reverse();
      }

      for (var j in msgList) { //遍历新消息
         msg = msgList[j];
         if (msg.getSession().id() == selToID) { //为当前聊天对象的消息
            selSess = msg.getSession();
            //在聊天窗体中新增一条消息
            addMsg(msg, prepage);
         }
      }
      //消息已读上报，并将当前会话的消息设置成自动已读
      webim.setAutoRead(selSess, true, true);
   }

   //获取最新的c2c历史消息,用于切换好友聊天，重新拉取好友的聊天消息
   var getLastC2CHistoryMsgs = function(cbOk, cbError) {
      if (selType == webim.SESSION_TYPE.GROUP) {
         alert('当前的聊天类型为群聊天，不能进行拉取好友历史消息操作');
         return;
      }
      if (!selToID || selToID == '@TIM#SYSTEM') {
         alert('当前的聊天id非法，selToID=' + selToID);
         return;
      }
      var lastMsgTime = 0; //第一次拉取好友历史消息时，必须传0
      var msgKey = '';
      var options = {
         'Peer_Account': selToID, //好友帐号
         'MaxCnt': reqMsgCount, //拉取消息条数
         'LastMsgTime': lastMsgTime, //最近的消息时间，即从这个时间点向前拉取历史消息
         'MsgKey': msgKey
      };
      selSess = null;
      webim.MsgStore.delSessByTypeId(selType, selToID);


      webim.getC2CHistoryMsgs(
         options,
         function(resp) {
            var complete = resp.Complete; //是否还有历史消息可以拉取，1-表示没有，0-表示有

            if (resp.MsgList.length == 0) {
               webim.Log.warn("没有历史消息了:data=" + JSON.stringify(options));
               return;
            }
            getPrePageC2CHistroyMsgInfoMap[selToID] = { //保留服务器返回的最近消息时间和消息Key,用于下次向前拉取历史消息
               'LastMsgTime': resp.LastMsgTime,
               'MsgKey': resp.MsgKey
            };
            //清空聊天界面
            document.getElementsByClassName("msgflow")[0].innerHTML = "";
            if (cbOk)
               cbOk(resp.MsgList);
         },
         cbError
      );
   };

   //向上翻页，获取更早的好友历史消息
   var getPrePageC2CHistoryMsgs = function(cbOk, cbError) {
      if (selType == webim.SESSION_TYPE.GROUP) {
         alert('当前的聊天类型为群聊天，不能进行拉取好友历史消息操作');
         return;
      }
      var tempInfo = getPrePageC2CHistroyMsgInfoMap[selToID]; //获取下一次拉取的c2c消息时间和消息Key
      var lastMsgTime;
      var msgKey;
      if (tempInfo) {
         lastMsgTime = tempInfo.LastMsgTime;
         msgKey = tempInfo.MsgKey;
      } else {
         alert('获取下一次拉取的c2c消息时间和消息Key为空');
         return;
      }
      var options = {
         'Peer_Account': selToID, //好友帐号
         'MaxCnt': reqMsgCount, //拉取消息条数
         'LastMsgTime': lastMsgTime, //最近的消息时间，即从这个时间点向前拉取历史消息
         'MsgKey': msgKey
      };
      webim.getC2CHistoryMsgs(
         options,
         function(resp) {
            var complete = resp.Complete; //是否还有历史消息可以拉取，1-表示没有，0-表示有
            if (resp.MsgList.length == 0) {
               webim.Log.warn("没有历史消息了:data=" + JSON.stringify(options));
               return;
            }
            getPrePageC2CHistroyMsgInfoMap[selToID] = { //保留服务器返回的最近消息时间和消息Key,用于下次向前拉取历史消息
               'LastMsgTime': resp.LastMsgTime,
               'MsgKey': resp.MsgKey
            };
            if (cbOk) {
               cbOk(resp.MsgList);
            } else {
               getHistoryMsgCallback(resp.MsgList, true);
            }
         },
         cbError
      );
   };

   //获取最新的群历史消息,用于切换群组聊天时，重新拉取群组的聊天消息
   var getLastGroupHistoryMsgs = function(cbOk) {
      if (selType == webim.SESSION_TYPE.C2C) {
         alert('当前的聊天类型为好友聊天，不能进行拉取群历史消息操作');
         return;
      }
      getGroupInfo(selToID, function(resp) {
         //拉取最新的群历史消息
         var options = {
            'GroupId': selToID,
            'ReqMsgSeq': resp.GroupInfo[0].NextMsgSeq - 1,
            'ReqMsgNumber': reqMsgCount
         };
         if (options.ReqMsgSeq == null || options.ReqMsgSeq == undefined || options.ReqMsgSeq <= 0) {
            webim.Log.warn("该群还没有历史消息:options=" + JSON.stringify(options));
            return;
         }
         selSess = null;
         webim.MsgStore.delSessByTypeId(selType, selToID);
         // recentSessMap[webim.SESSION_TYPE.GROUP + "_" + selToID] = {};

         recentSessMap[webim.SESSION_TYPE.GROUP + "_" + selToID].MsgGroupReadedSeq = resp.GroupInfo && resp.GroupInfo[0] && resp.GroupInfo[0].MsgSeq;
         webim.syncGroupMsgs(
            options,
            function(msgList) {
               if (msgList.length == 0) {
                  webim.Log.warn("该群没有历史消息了:options=" + JSON.stringify(options));
                  return;
               }
               var msgSeq = msgList[0].seq - 1;
               getPrePageGroupHistroyMsgInfoMap[selToID] = {
                  "ReqMsgSeq": msgSeq
               };
               //清空聊天界面
               document.getElementsByClassName("msgflow")[0].innerHTML = "";
               if (cbOk)
                  cbOk(msgList);
            },
            function(err) {
               alert(err.ErrorInfo);
            }
         );
      });
   };

   //向上翻页，获取更早的群历史消息
   var getPrePageGroupHistoryMsgs = function(cbOk) {
      if (selType == webim.SESSION_TYPE.C2C) {
         alert('当前的聊天类型为好友聊天，不能进行拉取群历史消息操作');
         return;
      }
      var tempInfo = getPrePageGroupHistroyMsgInfoMap[selToID]; //获取下一次拉取的群消息seq
      var reqMsgSeq;
      if (tempInfo) {
         reqMsgSeq = tempInfo.ReqMsgSeq;
         if (reqMsgSeq <= 0) {
            webim.Log.warn('该群没有历史消息可拉取了');
            return;
         }
      } else {
         webim.Log.error('获取下一次拉取的群消息seq为空');
         return;
      }
      var options = {
         'GroupId': selToID,
         'ReqMsgSeq': reqMsgSeq,
         'ReqMsgNumber': reqMsgCount
      };

      webim.syncGroupMsgs(
         options,
         function(msgList) {
            if (msgList.length == 0) {
               webim.Log.warn("该群没有历史消息了:options=" + JSON.stringify(options));
               return;
            }
            var msgSeq = msgList[0].seq - 1;
            getPrePageGroupHistroyMsgInfoMap[selToID] = {
               "ReqMsgSeq": msgSeq
            };

            if (cbOk) {
               cbOk(msgList);
            } else {
               getHistoryMsgCallback(msgList, true);
            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //监听 好友表添加 系统通知
   /*notify对数示例：
    {
    'Type':1,//通知类型
    'Accounts':['jim','bob']//用户ID列表
    }
    */
   function onFriendAddNotify(notify) {
      webim.Log.info("执行 好友表添加 回调：" + JSON.stringify(notify));
      //好友表发生变化，需要重新加载好友列表或者单独添加notify.Accounts好友帐号
      //getAllFriend(getAllFriendsCallbackOK);
      var typeCh = "[好友表添加]";
      var content = "新增以下好友：" + notify.Accounts;
      addFriendSystemMsg(notify.Type, typeCh, content);
   }

   //监听 好友表删除 系统通知
   /*notify对数示例：
   {
   'Type':2,//通知类型
   'Accounts':['jim','bob']//用户ID列表
   }
   */
   function onFriendDeleteNotify(notify) {
      webim.Log.info("执行 好友表删除 回调：" + JSON.stringify(notify));
      //好友表发生变化，需要重新加载好友列表或者单独删除notify.Accounts好友帐号
      //getAllFriend(getAllFriendsCallbackOK);
      var typeCh = "[好友表删除]";
      var content = "减少以下好友：" + notify.Accounts;
      addFriendSystemMsg(notify.Type, typeCh, content);
   }

   //监听 未决添加 系统通知
   /*notify对象示例：
   {
   "Type":3,//通知类型
   "PendencyList":[
   {
   "PendencyAdd_Account": "peaker1",//对方帐号
   "ProfileImNic": "匹克1",//对方昵称
   "AddSource": "AddSource_Type_Unknow",//来源
   "AddWording": "你好"//申请附言
   },
   {
   "PendencyAdd_Account": "peaker2",//对方帐号
   "ProfileImNic": "匹克2",//对方昵称
   "AddSource": "AddSource_Type_Unknow",//来源
   "AddWording": "你好"//申请附言
   }
   ]
   }
   */
   function onPendencyAddNotify(notify) {
      webim.Log.info("执行 未决添加 回调：" + JSON.stringify(notify));
      //收到加好友申请，弹出拉取好友申请列表
      getPendency(true);
      var typeCh = "[未决添加]";
      var pendencyList = notify.PendencyList;
      var content = "收到以下加好友申请：" + JSON.stringify(pendencyList);
      addFriendSystemMsg(notify.Type, typeCh, content);
   }

   //监听 未决删除 系统通知
   /*notify对数示例：
   {
   'Type':4,//通知类型
   'Accounts':['jim','bob']//用户ID列表
   }
   */
   function onPendencyDeleteNotify(notify) {
      webim.Log.info("执行 未决删除 回调：" + JSON.stringify(notify));
      var typeCh = "[未决删除]";
      var content = "以下好友未决已被删除：" + notify.Accounts;
      addFriendSystemMsg(notify.Type, typeCh, content);
   }

   //监听 好友黑名单添加 系统通知
   /*notify对数示例：
   {
   'Type':5,//通知类型
   'Accounts':['jim','bob']//用户ID列表
   }
   */
   function onBlackListAddNotify(notify) {
      webim.Log.info("执行 黑名单添加 回调：" + JSON.stringify(notify));
      var typeCh = "[黑名单添加]";
      var content = "新增以下黑名单：" + notify.Accounts;
      addFriendSystemMsg(notify.Type, typeCh, content);
   }

   //监听 好友黑名单删除 系统通知
   /*notify对数示例：
   {
   'Type':6,//通知类型
   'Accounts':['jim','bob']//用户ID列表
   }
   */
   function onBlackListDeleteNotify(notify) {
      webim.Log.info("执行 黑名单删除 回调：" + JSON.stringify(notify));
      var typeCh = "[黑名单删除]";
      var content = "减少以下黑名单：" + notify.Accounts;
      addFriendSystemMsg(notify.Type, typeCh, content);
   }
   //初始化我的好友系统消息表格
   function initGetMyFriendSystemMsgs(data) {
      $('#get_my_friend_system_msgs_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
               field: "Type",
               title: "类型",
               align: "center",
               valign: "middle",
               sortable: "false",
               visible: false
            },
            {
               field: "TypeCh",
               title: "类型",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "MsgContent",
               title: "内容",
               align: "center",
               valign: "middle",
               sortable: "true"
            }
         ],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //查看我的好友系统消息
   function getMyFriendSystemMsgs() {
      $('#get_my_friend_system_msgs_dialog').modal('show');
   }

   //增加一条好友系统消息
   function addFriendSystemMsg(type, typeCh, msgContent) {
      var data = [];
      data.push({
         "Type": type,
         "TypeCh": typeCh,
         "MsgContent": webim.Tool.formatText2Html(msgContent)
      });
      $('#get_my_friend_system_msgs_table').bootstrapTable('append', data);
   }
   //监听 申请加群 系统消息

   function onApplyJoinGroupRequestNotify(notify) {
      webim.Log.info("执行 加群申请 回调：" + JSON.stringify(notify));
      var data = [];
      var timestamp = notify.MsgTime;
      notify.MsgTimeStamp = timestamp;
      notify.MsgTime = webim.Tool.formatTimeStamp(notify.MsgTime);
      data.push(notify);
      $('#get_apply_join_group_pendency_table').bootstrapTable('append', data);
      $('#get_apply_join_group_pendency_dialog').modal('show');

      var reportTypeCh = "[申请加群]";
      var content = notify.Operator_Account + "申请加入你的群";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, timestamp);
   }

   //监听 申请加群被同意 系统消息

   function onApplyJoinGroupAcceptNotify(notify) {
      webim.Log.info("执行 申请加群被同意 回调：" + JSON.stringify(notify));
      //刷新我的群组列表
      //getJoinedGroupListHigh(getGroupsCallbackOK);

      var reportTypeCh = "[申请加群被同意]";
      var content = notify.Operator_Account + "同意你的加群申请，附言：" + notify.RemarkInfo;
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);

   }
   //监听 申请加群被拒绝 系统消息

   function onApplyJoinGroupRefuseNotify(notify) {
      webim.Log.info("执行 申请加群被拒绝 回调：" + JSON.stringify(notify));
      var reportTypeCh = "[申请加群被拒绝]";
      var content = notify.Operator_Account + "拒绝了你的加群申请，附言：" + notify.RemarkInfo;
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 被踢出群 系统消息

   function onKickedGroupNotify(notify) {
      webim.Log.info("执行 被踢出群  回调：" + JSON.stringify(notify));
      //刷新我的群组列表
      //getJoinedGroupListHigh(getGroupsCallbackOK);
      deleteSessDiv(webim.SESSION_TYPE.GROUP, notify.GroupId); //在最近的联系人列表删除可能存在的群会话
      var reportTypeCh = "[被踢出群]";
      var content = "你被管理员" + notify.Operator_Account + "踢出该群";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 解散群 系统消息

   function onDestoryGroupNotify(notify) {
      webim.Log.info("执行 解散群 回调：" + JSON.stringify(notify));
      //刷新我的群组列表
      //getJoinedGroupListHigh(getGroupsCallbackOK);
      deleteSessDiv(webim.SESSION_TYPE.GROUP, notify.GroupId); //在最近的联系人列表删除可能存在的群会话
      var reportTypeCh = "[群被解散]";
      var content = "群主" + notify.Operator_Account + "已解散该群";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 创建群 系统消息

   function onCreateGroupNotify(notify) {
      webim.Log.info("执行 创建群 回调：" + JSON.stringify(notify));
      var reportTypeCh = "[创建群]";
      var content = "你创建了该群";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 被邀请加群 系统消息

   function onInvitedJoinGroupNotify(notify) {
      webim.Log.info("执行 被邀请加群  回调: " + JSON.stringify(notify));
      //刷新我的群组列表
      //getJoinedGroupListHigh(getGroupsCallbackOK);
      var reportTypeCh = "[被邀请加群]";
      var content = "你被管理员" + notify.Operator_Account + "邀请加入该群";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }

   //监听 被邀请加群(用户需要同意) 系统消息

   function onInvitedJoinGroupNotifyRequest(notify) {
      var timestamp = notify.MsgTime;
      var data = [];
      notify.MsgTimeStamp = timestamp;
      notify.MsgTime = webim.Tool.formatTimeStamp(notify.MsgTime);
      data.push(notify);
      $('#get_apply_join_group_pendency_table').bootstrapTable('append', data);
      $('#get_apply_join_group_pendency_dialog').modal('show');
      addGroupSystemMsg(notify.ReportType, notify.GroupId, notify.GroupName, timestamp);
   }

   //监听 主动退群 系统消息

   function onQuitGroupNotify(notify) {
      webim.Log.info("执行 主动退群  回调： " + JSON.stringify(notify));
      deleteSessDiv(webim.SESSION_TYPE.GROUP, notify.GroupId); //在最近的联系人列表删除可能存在的群会话
      var reportTypeCh = "[主动退群]";
      var content = "你退出了该群";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 被设置为管理员 系统消息

   function onSetedGroupAdminNotify(notify) {
      webim.Log.info("执行 被设置为管理员  回调：" + JSON.stringify(notify));
      var reportTypeCh = "[被设置为管理员]";
      var content = "你被群主" + notify.Operator_Account + "设置为管理员";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 被取消管理员 系统消息

   function onCanceledGroupAdminNotify(notify) {
      webim.Log.info("执行 被取消管理员 回调：" + JSON.stringify(notify));
      var reportTypeCh = "[被取消管理员]";
      var content = "你被群主" + notify.Operator_Account + "取消了管理员资格";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 群被回收 系统消息

   function onRevokeGroupNotify(notify) {
      webim.Log.info("执行 群被回收 回调：" + JSON.stringify(notify));
      //刷新我的群组列表
      //getJoinedGroupListHigh(getGroupsCallbackOK);
      deleteSessDiv(webim.SESSION_TYPE.GROUP, notify.GroupId); //在最近的联系人列表删除可能存在的群会话
      var reportTypeCh = "[群被回收]";
      var content = "该群已被回收";
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }
   //监听 用户自定义 群系统消息

   function onCustomGroupNotify(notify) {
      webim.Log.info("执行 用户自定义系统消息 回调：" + JSON.stringify(notify));
      var reportTypeCh = "[用户自定义系统消息]";
      var content = notify.UserDefinedField; //群自定义消息数据
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }

   //监听 群资料变化 群提示消息

   function onGroupInfoChangeNotify(notify) {
      webim.Log.info("执行 群资料变化 回调： " + JSON.stringify(notify));
      var groupId = notify.GroupId;
      var newFaceUrl = notify.GroupFaceUrl; //新群组图标, 为空，则表示没有变化
      var newName = notify.GroupName; //新群名称, 为空，则表示没有变化
      var newOwner = notify.OwnerAccount; //新的群主id, 为空，则表示没有变化
      var newNotification = notify.GroupNotification; //新的群公告, 为空，则表示没有变化
      var newIntroduction = notify.GroupIntroduction; //新的群简介, 为空，则表示没有变化

      if (newName) {
         updateSessNameDiv(webim.SESSION_TYPE.GROUP, groupId, newName);
      }
      if (newFaceUrl) {
         updateSessImageDiv(webim.SESSION_TYPE.GROUP, groupId, newFaceUrl);
      }
   }

   function onCustomGroupNotify(notify) {
      webim.Log.info("执行 用户自定义系统消息 回调：" + JSON.stringify(notify));
      var reportTypeCh = "[用户自定义系统消息]";
      var content = notify.UserDefinedField; //群自定义消息数据
      addGroupSystemMsg(notify.ReportType, reportTypeCh, notify.GroupId, notify.GroupName, content, notify.MsgTime);
   }

   //已读消息同步
   //告诉你哪个类型的那个群组已读消息的情况

   function onReadedSyncGroupNotify(notify) {
      var seq = notify.LastReadMsgSeq;
      //更新当前的seq
      var currentUnRead = recentSessMap[webim.SESSION_TYPE.GROUP + "_" + notify.GroupId].MsgGroupReadedSeq;
      var unread = currentUnRead - seq;
      unread = unread > 0 ? unread : 0;
      recentSessMap[webim.SESSION_TYPE.GROUP + "_" + notify.GroupId].MsgGroupReadedSeq = seq;


      //更新未读数
      var sess = webim.MsgStore.sessByTypeId(webim.SESSION_TYPE.GROUP, notify.GroupId);
      sess.unread(unread);

      webim.Log.info("群消息同步的回调:已读消息情况 ## 未读数：GroupId:[" + notify.GroupId + "]:" + unread, currentUnRead, seq);
      if (unread > 0) {
         $(document.getElementById("badgeDiv_" + notify.GroupId)).text(unread).show();
      } else {
         $(document.getElementById("badgeDiv_" + notify.GroupId)).val("").hide();
      }
   }

   //初始化我的群组系统消息表格

   function initGetMyGroupSystemMsgs(data) {
      $('#get_my_group_system_msgs_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "ReportType",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "false",
            visible: false
         }, {
            field: "ReportTypeCh",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "GroupId",
            title: "群ID",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "GroupName",
            title: "群名称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MsgContent",
            title: "内容",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MsgTime",
            title: "时间",
            align: "center",
            valign: "middle",
            sortable: "true"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //查看我的群组系统消息
   var getMyGroupSystemMsgs = function() {
      $('#get_my_group_system_msgs_dialog').modal('show');
   };

   //增加一条群组系统消息

   function addGroupSystemMsg(type, typeCh, group_id, group_name, msg_content, msg_time) {
      var data = [];
      data.push({
         "ReportType": type,
         "ReportTypeCh": typeCh,
         "GroupId": webim.Tool.formatText2Html(group_id),
         "GroupName": webim.Tool.formatText2Html(group_name),
         "MsgContent": webim.Tool.formatText2Html(msg_content),
         "MsgTime": webim.Tool.formatTimeStamp(msg_time)
      });
      $('#get_my_group_system_msgs_table').bootstrapTable('append', data);
      //$('#get_my_group_system_msgs_dialog').modal('show');
   }
   //监听新消息事件
   var msgList = [];
   var dateStart = null;
   var dateEnd = null;
   //newMsgList 为新消息数组，结构为[Msg]
   function onMsgNotify(newMsgList) {
      //console.warn(newMsgList);
      var sess, newMsg;
      //获取所有聊天会话
      var sessMap = webim.MsgStore.sessMap();

      for (var j in newMsgList) { //遍历新消息
         newMsg = newMsgList[j];

         if (!selToID) { //没有聊天对象
            selToID = newMsg.getSession().id();
            selType = newMsg.getSession().type();
            selSess = newMsg.getSession();
            var headUrl;
            if (selType == webim.SESSION_TYPE.C2C) {
               headUrl = friendHeadUrl;
            } else {
               headUrl = groupHeadUrl;
            }
            addSess(selType, selToID, newMsg.getSession().name(), headUrl, 0, 'sesslist'); //新增一个对象
            setSelSessStyleOn(selToID);
         }
         if (newMsg.getSession().id() == selToID) { //为当前聊天对象的消息
            //在聊天窗体中新增一条消息
            //console.warn(newMsg);
            addMsg(newMsg);
         }
         msgList.push(newMsg.elems[0].content.text);
      }
      //消息已读上报，以及设置会话自动已读标记
      // webim.setAutoRead(selSess, true, true);

      for (var i in sessMap) {
         sess = sessMap[i];
         if (selToID != sess.id()) { //更新其他聊天对象的未读消息数
            if (!dateStart) {
               dateStart = new Date();
            }
            updateSessDiv(sess.type(), sess.id(), sess.name(), sess.unread());
            console.debug(sess.id(), sess.unread());
            dateEnd = new Date();
         }
      }
   }

   //监听直播聊天室新消息事件
   //newMsgList 为新消息数组，结构为[Msg]
   //监听大群新消息（普通，点赞，提示，红包）
   function onBigGroupMsgNotify(newMsgList) {
      var newMsg;
      for (var i = newMsgList.length - 1; i >= 0; i--) { //遍历消息，按照时间从后往前
         newMsg = newMsgList[i];
         webim.Log.warn('receive a new group(AVChatRoom) msg: ' + newMsg.getFromAccountNick());
         //显示收到的消息
         addMsg(newMsg);
      }
   }


   //消息已读通知
   function onMsgReadedNotify(notify) {
      var sessMap = webim.MsgStore.sessMap()[webim.SESSION_TYPE.C2C + notify.From_Account];
      if (sessMap) {
         var msgs = _.clone(sessMap.msgs());
         var rm_msgs = _.remove(msgs, function(m) {
            return m.time <= notify.LastReadTime
         });
         var unread = sessMap.unread() - rm_msgs.length;
         unread = unread > 0 ? unread : 0;
         //更新sess的未读数
         sessMap.unread(unread);
         // console.debug('更新C2C未读数:',notify.From_Account,unread);
         //更新页面的未读数角标

         if (unread > 0) {
            $("#badgeDiv_" + notify.From_Account).text(unread).show();
         } else {
            $("#badgeDiv_" + notify.From_Account).val("").hide();
         }
      }
   }
   //监听 资料变化（自己或好友） 系统通知
   /*notify对数示例：
    {
    "Type":1,//子通知类型
    "Profile_Account": "Jim",//用户帐号
    "ProfileList": [
    {
    "Tag": "Tag_Profile_IM_Nick",//昵称
    "ValueBytes": "吉姆"
    },
    {
    "Tag": "Tag_Profile_IM_Gender",//性别
    "ValueBytes": "Gender_Type_Male"
    },
    {
    "Tag": "Tag_Profile_IM_AllowType",//加好友认证方式
    "ValueBytes": "AllowType_Type_NeedConfirm"
    },
    {
    "Tag": "Tag_Profile_IM_Image",//用户头像
    "ValueBytes": "img/custome/image.png"
    }
    ]
    }
    */

   function onProfileModifyNotify(notify) {
      webim.Log.info("执行 资料修改 回调：" + JSON.stringify(notify));
      var typeCh = "[资料修改]";
      var profile, account, nick, sex, allowType, content;
      account = notify.Profile_Account;
      content = "帐号：" + account + ", ";
      for (var i in notify.ProfileList) {
         profile = notify.ProfileList[i];
         switch (profile.Tag) {
            case 'Tag_Profile_IM_Nick':
               nick = profile.ValueBytes;
               break;
            case 'Tag_Profile_IM_Gender':
               sex = profile.ValueBytes;
               break;
            case 'Tag_Profile_IM_AllowType':
               allowType = profile.ValueBytes;
               break;
            case 'Tag_Profile_IM_Image':
               image = profile.ValueBytes;
               break;
            default:
               webim.log.error('未知资料字段：' + JSON.stringify(profile));
               break;
         }
      }
      content += "最新资料：【昵称】：" + nick + ",【性别】：" + sex + ",【加好友方式】：" + allowType + ",【修改头像】：" + image;
      addProfileSystemMsg(notify.Type, typeCh, content);

      if (account != loginInfo.identifier) { //如果是好友资料更新
         //好友资料发生变化，需要重新加载好友列表或者单独更新account的资料信息
         //getAllFriend(getAllFriendsCallbackOK);
         if (account && nick) {
            updateSessNameDiv(webim.SESSION_TYPE.C2C, account, nick); //更新最近聊天会话中的好友昵称
         }

      }
   }


   //初始化我的资料系统消息表格

   function initGetMyProfileSystemMsgs(data) {
      $('#get_my_profile_system_msgs_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "Type",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "false",
            visible: false
         }, {
            field: "TypeCh",
            title: "类型",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "MsgContent",
            title: "内容",
            align: "center",
            valign: "middle",
            sortable: "true"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //查看我的资料系统消息

   function getMyProfileSystemMsgs() {
      $('#get_my_profile_system_msgs_dialog').modal('show');
   }

   //增加一条资料系统消息

   function addProfileSystemMsg(type, typeCh, msgContent) {
      var data = [];
      data.push({
         "Type": type,
         "TypeCh": typeCh,
         "MsgContent": webim.Tool.formatText2Html(msgContent)
      });
      $('#get_my_profile_system_msgs_table').bootstrapTable('append', data);
   }
   //发送消息(文本或者表情)

   function onSendMsg() {

      if (!selToID) {
         alert("你还没有选中好友或者群组，暂不能聊天");
         $("#send_msg_text").val('');
         return;
      }
      //获取消息内容
      var msgContent = document.getElementsByClassName("msgedit")[0].value;
      var msgLen = webim.Tool.getStrBytes(msgContent);

      if (msgContent.length < 1) {
         alert("发送的消息不能为空!");
         $("#send_msg_text").val('');
         return;
      }
      var maxLen, errInfo;
      if (selType == webim.SESSION_TYPE.C2C) {
         maxLen = webim.MSG_MAX_LENGTH.C2C;
         errInfo = "消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)";
      } else {
         maxLen = webim.MSG_MAX_LENGTH.GROUP;
         errInfo = "消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)";
      }
      if (msgLen > maxLen) {
         alert(errInfo);
         return;
      }
      //发消息处理
      handleMsgSend(msgContent);
   }


   function handleMsgSend(msgContent) {
      if (!selSess) {
         var selSess = new webim.Session(selType, selToID, selToID, friendHeadUrl, Math.round(new Date().getTime() / 1000));
      }
      var isSend = true; //是否为自己发送
      var seq = -1; //消息序列，-1表示sdk自动生成，用于去重
      var random = Math.round(Math.random() * 4294967296); //消息随机数，用于去重
      var msgTime = Math.round(new Date().getTime() / 1000); //消息时间戳
      var subType; //消息子类型
      if (selType == webim.SESSION_TYPE.C2C) {
         subType = webim.C2C_MSG_SUB_TYPE.COMMON;
      } else {
         //webim.GROUP_MSG_SUB_TYPE.COMMON-普通消息,
         //webim.GROUP_MSG_SUB_TYPE.LOVEMSG-点赞消息，优先级最低
         //webim.GROUP_MSG_SUB_TYPE.TIP-提示消息(不支持发送，用于区分群消息子类型)，
         //webim.GROUP_MSG_SUB_TYPE.REDPACKET-红包消息，优先级最高
         subType = webim.GROUP_MSG_SUB_TYPE.COMMON;
      }
      var msg = new webim.Msg(selSess, isSend, seq, random, msgTime, loginInfo.identifier, subType, loginInfo.identifierNick);

      var text_obj, face_obj, tmsg, emotionIndex, emotion, restMsgIndex;
      //解析文本和表情
      var expr = /\[[^[\]]{1,3}\]/mg;
      var emotions = msgContent.match(expr);
      if (!emotions || emotions.length < 1) {
         text_obj = new webim.Msg.Elem.Text(msgContent);
         msg.addText(text_obj);
      } else {
         for (var i = 0; i < emotions.length; i++) {
            tmsg = msgContent.substring(0, msgContent.indexOf(emotions[i]));
            if (tmsg) {
               text_obj = new webim.Msg.Elem.Text(tmsg);
               msg.addText(text_obj);
            }
            emotionIndex = webim.EmotionDataIndexs[emotions[i]];
            emotion = webim.Emotions[emotionIndex];

            if (emotion) {
               face_obj = new webim.Msg.Elem.Face(emotionIndex, emotions[i]);
               msg.addFace(face_obj);
            } else {
               text_obj = new webim.Msg.Elem.Text(emotions[i]);
               msg.addText(text_obj);
            }
            restMsgIndex = msgContent.indexOf(emotions[i]) + emotions[i].length;
            msgContent = msgContent.substring(restMsgIndex);
         }
         if (msgContent) {
            text_obj = new webim.Msg.Elem.Text(msgContent);
            msg.addText(text_obj);
         }
      }

      msg.PushInfo = {
         "PushFlag": 0,
         "Desc": '测试离线推送内容', //离线推送内容
         "Ext": '测试离线推送透传内容', //离线推送透传内容
         "AndroidInfo": {
            "Sound": "android.mp3" //离线推送声音文件路径。
         },
         "ApnsInfo": {
            "Sound": "apns.mp3", //离线推送声音文件路径。
            "BadgeMode": 1
         }
      };

      msg.PushInfoBoolean = true; //是否开启离线推送push同步
      msg.sending = 1;
      msg.originContent = msgContent;
      addMsg(msg);
      $("#send_msg_text").val('');
      turnoffFaces_box();

      webim.sendMsg(msg, function(resp) {
         //发送成功，把sending清理
         $("#id_" + msg.random).find(".spinner").remove();
         webim.Tool.setCookie("tmpmsg_" + selToID, '', 0);
      }, function(err) {
         //alert(err.ErrorInfo);
         //提示重发
         showReSend(msg);
      });
   }

   function showReSend(msg) {
      //resend a dom
      var resendBtn = $('<a href="javascript:;">重发</a>');
      //绑定重发事件
      resendBtn.click(function() {
         //删除当前的dom
         $("#id_" + msg.random).remove();
         //发消息处理
         handleMsgSend(msg.originContent);
      });
      $("#id_" + msg.random).find(".spinner").empty().append(resendBtn);
   }


   //发送文本框按下键盘事件

   function onTextareaKeyDown(event) {
      if (event && event.keyCode == 13) {
         onSendMsg();
         event.stopPropagation()
         event.preventDefault()
      }
   }
   //关闭聊天界面

   function onClose() {
      document.getElementById("webim_demo").style.display = "none";
      //离线
      webim.logout();
   }

   //打开表情窗体
   var showEmotionDialog = function() {
      if (emotionFlag) {
         $('#wl_faces_box').css({
            "display": "block"
         });
         return;
      }
      emotionFlag = true;

      for (var index in webim.Emotions) {
         var emotions = $('<img>').attr({
            "id": webim.Emotions[index][0],
            "src": webim.Emotions[index][1],
            "style": "cursor:pointer;"
         }).click(function() {
            selectEmotionImg(this);
         });
         $('<li>').append(emotions).appendTo($('#emotionUL'));
      }
      $('#wl_faces_box').css({
         "display": "block"
      });
   };

   //表情选择div的关闭方法
   var turnoffFaces_box = function() {
      $("#wl_faces_box").fadeOut("slow");
   };
   //选中表情
   var selectEmotionImg = function(selImg) {
      var txt = document.getElementsByClassName("msgedit")[0];
      txt.value = txt.value + selImg.id;
      txt.focus();
   }; //点击发送群自定义通知菜单事件
   function showSendCustomGroupNotifyDialog() {
      if (selType == webim.SESSION_TYPE.GROUP && selToID) {
         $("#sgsm_group_id").val(selToID);
      }
      $('#send_group_system_msg_dialog').modal('show');
   }

   //发送自定义群系统通知
   var sendCustomGroupNotify = function() {

      var groupId = $("#sgsm_group_id").val();
      var content = $("#sgsm_content").val();

      if (content.length < 1) {
         alert("发送的消息不能为空!");
         return;
      }
      if (webim.Tool.getStrBytes(content) > webim.MSG_MAX_LENGTH.GROUP) {
         alert("消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)");
         return;
      }
      if (groupId.length < 1) {
         alert("群ID不能为空!");
         return;
      }
      //详细参数，请参考链接：http://avc.qcloud.com/wiki2.0/im/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%9B%86%E6%88%90/%E7%BE%A4%E7%BB%84%E7%AE%A1%E7%90%86/%E5%9C%A8%E7%BE%A4%E7%BB%84%E4%B8%AD%E5%8F%91%E9%80%81%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5/%E5%9C%A8%E7%BE%A4%E7%BB%84%E4%B8%AD%E5%8F%91%E9%80%81%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5.html
      var options = {
         'GroupId': groupId,
         'Content': content
      };
      webim.sendCustomGroupNotify(
         options,
         function(resp) {
            $('#send_group_system_msg_dialog').modal('hide');
            alert('发送成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //弹出发自定义消息对话框

   function showEditCustomMsgDialog() {
      $('#ecm_form')[0].reset();
      $('#edit_custom_msg_dialog').modal('show');
   }
   //发送自定义消息

   function sendCustomMsg() {
      if (!selToID) {
         alert("您还没有好友或群组，暂不能聊天");
         return;
      }
      var data = $("#ecm_data").val();
      var desc = $("#ecm_desc").val();
      var ext = $("#ecm_ext").val();

      var msgLen = webim.Tool.getStrBytes(data);

      if (data.length < 1) {
         alert("发送的消息不能为空!");
         return;
      }
      var maxLen, errInfo;
      if (selType == webim.SESSION_TYPE.C2C) {
         maxLen = webim.MSG_MAX_LENGTH.C2C;
         errInfo = "消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)";
      } else {
         maxLen = webim.MSG_MAX_LENGTH.GROUP;
         errInfo = "消息长度超出限制(最多" + Math.round(maxLen / 3) + "汉字)";
      }
      if (msgLen > maxLen) {
         alert(errInfo);
         return;
      }

      if (!selSess) {
         selSess = new webim.Session(selType, selToID, selToID, friendHeadUrl, Math.round(new Date().getTime() / 1000));
      }
      var msg = new webim.Msg(selSess, true, -1, -1, -1, loginInfo.identifier, 0, loginInfo.identifierNick);
      var custom_obj = new webim.Msg.Elem.Custom(data, desc, ext);
      msg.addCustom(custom_obj);
      //调用发送消息接口
      msg.sending = 1;
      webim.sendMsg(msg, function(resp) {
         addMsg(msg);
         $("#id_" + msg.random).find(".spinner").remove();
         // if (selType == webim.SESSION_TYPE.C2C) {
         //     //私聊时，在聊天窗口手动添加一条发的消息，群聊时，长轮询接口会返回自己发的消息
         //     addMsg(msg);
         // }
         $('#edit_custom_msg_dialog').modal('hide');
      }, function(err) {
         alert(err.ErrorInfo);
      });
   }
   //切换播放audio对象
   function onChangePlayAudio(playAudio) {
      if (curPlayAudio) {
         if (curPlayAudio != playAudio) {
            curPlayAudio.currentTime = 0;
            curPlayAudio.pause();
            curPlayAudio = playAudio;
         }
      } else {
         curPlayAudio = playAudio;
      }
   }

   //弹出发文件对话框
   function selectFileClick() {
      //判断浏览器版本
      if (webim.BROWSER_INFO.type == 'ie' && parseInt(webim.BROWSER_INFO.ver) <= 9) {
         alert('上传文件暂不支持ie9(含)以下浏览器');
         //$('#updli_file_form')[0].reset();
         //$('#upload_file_low_ie_dialog').modal('show');
      } else {
         $('#upd_file_form')[0].reset();
         //var preDiv = document.getElementById('previewFileDiv');
         //preDiv.innerHTML = '';
         var progress = document.getElementById('upd_file_progress'); //上传文件进度条
         progress.value = 0;
         $('#upload_file_dialog').modal('show');
      }
   }

   //上传文件进度条回调函数
   //loadedSize-已上传字节数
   //totalSize-文件总字节数
   function onFileProgressCallBack(loadedSize, totalSize) {
      var progress = document.getElementById('upd_file_progress'); //上传文件进度条
      progress.value = (loadedSize / totalSize) * 100;
   }

   //上传文件
   function uploadFile() {
      var uploadFiles = document.getElementById('upd_file');
      var file = uploadFiles.files[0];
      //先检查图片类型和大小
      if (!checkFile(file)) {
         return;
      }
      var businessType; //业务类型，1-发群文件，2-向好友发文件
      if (selType == webim.SESSION_TYPE.C2C) { //向好友发文件
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.C2C_MSG;
      } else if (selType == webim.SESSION_TYPE.GROUP) { //发群文件
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.GROUP_MSG;
      }

      //封装上传文件请求
      var opt = {
         'file': file, //文件对象
         'onProgressCallBack': onFileProgressCallBack, //上传文件进度条回调函数
         //'abortButton': document.getElementById('upd_abort'), //停止上传文件按钮
         'To_Account': selToID, //接收者
         'businessType': businessType, //业务类型
         'fileType': webim.UPLOAD_RES_TYPE.FILE //表示上传文件
      };
      //上传文件
      webim.uploadFile(opt,
         function(resp) {
            //上传成功发送文件
            sendFile(resp, file.name);
            $('#upload_file_dialog').modal('hide');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   }

   //上传文件(用于低版本IE)
   function uploadFileLowIE() {
      var businessType; //业务类型，1-发群文件，2-向好友发文件
      if (selType == webim.SESSION_TYPE.C2C) { //向好友发文件
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.C2C_MSG;
      } else if (selType == webim.SESSION_TYPE.GROUP) { //发群文件
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.GROUP_MSG;
      }
      //封装上传文件请求
      var opt = {
         'formId': 'updli_file_form', //上传文件表单id
         'fileId': 'upload_low_ie_file', //file控件id
         'To_Account': selToID, //接收者
         'businessType': businessType, //文件的使用业务类型
         'fileType': webim.UPLOAD_RES_TYPE.FILE //表示上传文件
      };
      webim.submitUploadFileForm(opt,
         function(resp) {
            $('#upload_file_low_ie_dialog').modal('hide');
            //发送文件
            sendFile(resp);
         },
         function(err) {
            $('#upload_file_low_ie_dialog').modal('hide');
            alert(err.ErrorInfo);
         }
      );
   }

   //上传文件(通过base64编码)
   function uploadFileByBase64() {
      var businessType; //业务类型，1-发群文件，2-向好友发文件
      if (selType == webim.SESSION_TYPE.C2C) { //向好友发文件
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.C2C_MSG;
      } else if (selType == webim.SESSION_TYPE.GROUP) { //发群文件
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.GROUP_MSG;
      }
      //封装上传文件请求
      var opt = {
         'toAccount': selToID, //接收者
         'businessType': businessType, //文件的使用业务类型
         'fileType': webim.UPLOAD_RES_TYPE.FILE, //表示文件
         'fileMd5': '6f25dc54dc2cd47375e8b43045de642a', //文件md5
         'totalSize': 56805, //文件大小,Byte
         'base64Str': '' //文件base64编码
      };
      webim.uploadPicByBase64(opt,
         function(resp) {
            //alert('success');
            //发送文件
            console.debug(resp);
            sendFile(resp);
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   }
   //发送文件消息
   function sendFile(file, fileName) {
      if (!selToID) {
         alert("您还没有好友，暂不能聊天");
         return;
      }

      if (!selSess) {
         selSess = new webim.Session(selType, selToID, selToID, friendHeadUrl, Math.round(new Date().getTime() / 1000));
      }
      var msg = new webim.Msg(selSess, true, -1, -1, -1, loginInfo.identifier, 0, loginInfo.identifierNick);
      var uuid = file.File_UUID; //文件UUID
      var fileSize = file.File_Size; //文件大小
      var senderId = loginInfo.identifier;
      var downloadFlag = file.Download_Flag;
      if (!fileName) {
         var random = Math.round(Math.random() * 4294967296);
         fileName = random.toString();
      }
      var fileObj = new webim.Msg.Elem.File(uuid, fileName, fileSize, senderId, selToID, downloadFlag, selType);
      msg.addFile(fileObj);
      //调用发送文件消息接口
      webim.sendMsg(msg, function(resp) {
         if (selType == webim.SESSION_TYPE.C2C) { //私聊时，在聊天窗口手动添加一条发的消息，群聊时，长轮询接口会返回自己发的消息
            addMsg(msg);
         }
      }, function(err) {
         alert(err.ErrorInfo);
      });
   }



   //检查文件类型和大小
   function checkFile(file) {
      //var legalExts = 'jpg|jpeg|png|bmp|gif|webp|txt|doc|docx|xls|ppt|zip|rar|gz';
      //var ext = obj.value.substr(obj.value.lastIndexOf(".") + 1).toLowerCase();//获得文件后缀名
      //var pos = legalExts.indexOf(ext);
      //if (pos < 0) {
      //    alert("您选中的文件类型非法，请重新选择");
      //    return false;
      //}
      fileSize = Math.round(file.size / 1024 * 100) / 100; //单位为KB
      if (fileSize > 20 * 1024) {
         alert("您选择的文件大小超过限制(最大为20M)，请重新选择");
         return false;
      }
      return true;
   }

   //弹出发图对话框

   function selectPicClick() {
      //判断浏览器版本
      if (webim.BROWSER_INFO.type == 'ie' && parseInt(webim.BROWSER_INFO.ver) <= 9) {
         //if(1==1){
         $('#updli_form')[0].reset();
         $('#upload_pic_low_ie_dialog').modal('show');
      } else {
         $('#upd_form')[0].reset();
         var preDiv = document.getElementById('previewPicDiv');
         preDiv.innerHTML = '';
         var progress = document.getElementById('upd_progress'); //上传图片进度条
         progress.value = 0;
         $('#upload_pic_dialog').modal('show');
      }
   }
   //选择图片触发事件

   function fileOnChange(uploadFile) {

      if (!window.File || !window.FileList || !window.FileReader) {
         alert("您的浏览器不支持File Api");
         return;
      }

      var file = uploadFile.files[0];
      var fileSize = file.size;

      //先检查图片类型和大小
      if (!checkPic(uploadFile, fileSize)) {
         return;
      }

      //预览图片
      var reader = new FileReader();
      var preDiv = document.getElementById('previewPicDiv');
      reader.onload = (function(file) {
         return function(e) {
            preDiv.innerHTML = '';
            var span = document.createElement('span');
            span.innerHTML = '<img class="img-responsive" src="' + this.result + '" alt="' + file.name + '" />';
            //span.innerHTML = '<img class="img-thumbnail" src="' + this.result + '" alt="' + file.name + '" />';
            preDiv.insertBefore(span, null);
         };
      })(file);
      //预览图片
      reader.readAsDataURL(file);
   }

   //上传图片进度条回调函数
   //loadedSize-已上传字节数
   //totalSize-图片总字节数

   function onProgressCallBack(loadedSize, totalSize) {
      var progress = document.getElementById('upd_progress'); //上传图片进度条
      progress.value = (loadedSize / totalSize) * 100;
   }

   //上传图片

   function uploadPic() {
      var uploadFiles = document.getElementById('upd_pic');
      var file = uploadFiles.files[0];
      var businessType; //业务类型，1-发群图片，2-向好友发图片
      if (selType == webim.SESSION_TYPE.C2C) { //向好友发图片
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.C2C_MSG;
      } else if (selType == webim.SESSION_TYPE.GROUP) { //发群图片
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.GROUP_MSG;
      }
      //封装上传图片请求
      var opt = {
         'file': file, //图片对象
         'onProgressCallBack': onProgressCallBack, //上传图片进度条回调函数
         //'abortButton': document.getElementById('upd_abort'), //停止上传图片按钮
         'To_Account': selToID, //接收者
         'businessType': businessType //业务类型
      };
      //上传图片
      webim.uploadPic(opt,
         function(resp) {
            //上传成功发送图片
            sendPic(resp, file.name);
            $('#upload_pic_dialog').modal('hide');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   }

   //上传图片(用于低版本IE)

   function uploadPicLowIE() {
      var businessType; //业务类型，1-发群图片，2-向好友发图片
      if (selType == webim.SESSION_TYPE.C2C) { //向好友发图片
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.C2C_MSG;
      } else if (selType == webim.SESSION_TYPE.GROUP) { //发群图片
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.GROUP_MSG;
      }
      //封装上传图片请求
      var opt = {
         'formId': 'updli_form', //上传图片表单id
         'fileId': 'updli_file', //file控件id
         'To_Account': selToID, //接收者
         'businessType': businessType //图片的使用业务类型
      };
      webim.submitUploadFileForm(opt,
         function(resp) {
            $('#upload_pic_low_ie_dialog').modal('hide');
            //发送图片
            sendPic(resp);
         },
         function(err) {
            $('#upload_pic_low_ie_dialog').modal('hide');
            alert(err.ErrorInfo);
         }
      );
   }

   //上传图片(通过base64编码)

   function uploadPicByBase64() {
      var businessType; //业务类型，1-发群图片，2-向好友发图片
      if (selType == webim.SESSION_TYPE.C2C) { //向好友发图片
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.C2C_MSG;
      } else if (selType == webim.SESSION_TYPE.GROUP) { //发群图片
         businessType = webim.UPLOAD_PIC_BUSSINESS_TYPE.GROUP_MSG;
      }
      //封装上传图片请求
      var opt = {
         'toAccount': selToID, //接收者
         'businessType': businessType, //图片的使用业务类型
         'fileMd5': '6f25dc54dc2cd47375e8b43045de642a', //图片md5
         'totalSize': 56805, //图片大小,Byte
         'base64Str': '' //图片base64编码
      };
      webim.uploadPicByBase64(opt,
         function(resp) {
            //alert('success');
            //发送图片
            sendPic(resp);
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   }

   //发送图片消息

   function sendPic(images, imgName) {
      console.debug('sendPic', imgName);
      if (!selToID) {
         alert("您还没有好友，暂不能聊天");
         return;
      }

      if (!selSess) {
         var selSess = new webim.Session(selType, selToID, selToID, friendHeadUrl, Math.round(new Date().getTime() / 1000));
      }
      var msg = new webim.Msg(selSess, true, -1, -1, -1, loginInfo.identifier, 0, loginInfo.identifierNick);

      console.debug(imgName.split(".")[1]);
      var images_obj = new webim.Msg.Elem.Images(images.File_UUID, imgName.split(".")[1]);
      for (var i in images.URL_INFO) {
         var img = images.URL_INFO[i];
         var newImg;
         var type;
         switch (img.PIC_TYPE) {
            case 1: //原图
               type = 1; //原图
               break;
            case 2: //小图（缩略图）
               type = 3; //小图
               break;
            case 4: //大图
               type = 2; //大图
               break;
         }
         newImg = new webim.Msg.Elem.Images.Image(type, img.PIC_Size, img.PIC_Width, img.PIC_Height, img.DownUrl);
         images_obj.addImage(newImg);
      }
      msg.addImage(images_obj);
      //if(imgName){
      //    var data=imgName;//通过自定义消息中的data字段保存图片名称
      //    var custom_obj = new webim.Msg.Elem.Custom(data, '', '');
      //    msg.addCustom(custom_obj);
      //}
      //调用发送图片消息接口
      webim.sendMsg(msg, function(resp) {
         if (selType == webim.SESSION_TYPE.C2C) { //私聊时，在聊天窗口手动添加一条发的消息，群聊时，长轮询接口会返回自己发的消息
            addMsg(msg);
         }
      }, function(err) {
         alert(err.ErrorInfo);
      });
   }
   //检查文件类型和大小

   function checkPic(obj, fileSize) {
      var picExts = 'jpg|jpeg|png|bmp|gif|webp';
      var photoExt = obj.value.substr(obj.value.lastIndexOf(".") + 1).toLowerCase(); //获得文件后缀名
      var pos = picExts.indexOf(photoExt);
      if (pos < 0) {
         alert("您选中的文件不是图片，请重新选择");
         return false;
      }
      fileSize = Math.round(fileSize / 1024 * 100) / 100; //单位为KB
      if (fileSize > 30 * 1024) {
         alert("您选择的图片大小超过限制(最大为30M)，请重新选择");
         return false;
      }
      return true;
   }

   //单击图片事件

   function imageClick(imgObj) {
      var imgUrls = imgObj.src;
      var imgUrlArr = imgUrls.split("#"); //字符分割
      var smallImgUrl = imgUrlArr[0]; //小图
      var bigImgUrl = imgUrlArr[1]; //大图
      var oriImgUrl = imgUrlArr[2]; //原图
      var bigPicDiv = document.getElementById('bigPicDiv');
      bigPicDiv.innerHTML = '';
      var span = document.createElement('span');
      span.innerHTML = '<img class="img-thumbnail" src="' + bigImgUrl + '" />';
      bigPicDiv.insertBefore(span, null);
      $('#click_pic_dialog').modal('show');
   }
   //搜索用户菜单点击事件

   function searchProfileByUserIdClick() {
      $('#sp_form')[0].reset();
      initSearchProfileTable([]);
      $('#search_profile_table').bootstrapTable('load', []);
      $('#search_profile_dialog').modal('show');

   }
   //设置个人资料菜单点击事件

   function setProfilePortraitClick() {

      //重置表单
      $('#spp_form')[0].reset();

      var tag_list = [
         "Tag_Profile_IM_Nick",
         "Tag_Profile_IM_Gender",
         "Tag_Profile_IM_AllowType",
         "Tag_Profile_IM_Image"
      ];
      var options = {
         'To_Account': [loginInfo.identifier],
         'TagList': tag_list
      };

      webim.getProfilePortrait(
         options,
         function(resp) {
            if (resp.UserProfileItem && resp.UserProfileItem.length > 0) {
               for (var i in resp.UserProfileItem) {
                  var nick, gender, allowType, image;
                  for (var j in resp.UserProfileItem[i].ProfileItem) {
                     switch (resp.UserProfileItem[i].ProfileItem[j].Tag) {
                        case 'Tag_Profile_IM_Nick':
                           nick = resp.UserProfileItem[i].ProfileItem[j].Value;
                           break;
                        case 'Tag_Profile_IM_Gender':
                           gender = resp.UserProfileItem[i].ProfileItem[j].Value;
                           break;
                        case 'Tag_Profile_IM_AllowType':
                           allowType = resp.UserProfileItem[i].ProfileItem[j].Value;
                           break;
                        case 'Tag_Profile_IM_Image':
                           image = resp.UserProfileItem[i].ProfileItem[j].Value;
                           break;
                     }
                  }
                  $("#spp_image").val(image);
                  //
                  $("#spp_nick").val(nick);
                  //$("input[type=radio][name='spp_gender_radio'][value=" + gender + "]").attr("checked", "checked");//此方法，在IE浏览器下，第一次查看个人资料时，选中没有效果
                  var spp_gender_radios = document.spp_form.spp_gender_radio;
                  for (var i = 0; i < spp_gender_radios.length; i++) {
                     if (spp_gender_radios[i].value == gender) {
                        spp_gender_radios[i].checked = true;
                        break;
                     }
                  }
                  //$("input[type=radio][name='spp_allow_type_radio'][value=" + allowType + "]").attr("checked", "checked");
                  var spp_allow_type_radio = document.spp_form.spp_allow_type_radio;
                  for (var i = 0; i < spp_allow_type_radio.length; i++) {
                     if (spp_allow_type_radio[i].value == allowType) {
                        spp_allow_type_radio[i].checked = true;
                        break;
                     }
                  }

               }
            }
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
      $('#set_profile_portrait_dialog').modal('show');
   }
   //定义搜索用户表格每行按钮

   function spOperateFormatter(value, row, index) {
      return [
         '<a class="plus" href="javascript:void(0)" title="添加好友">',
         '<i class="glyphicon glyphicon-plus"></i>',
         '</a>'

      ].join('');
   }
   //搜索用户表格每行按钮单击事件
   window.spOperateEvents = {
      'click .plus': function(e, value, row, index) {

         $('#af_to_account').val(row.To_Account);

         //重新获取对方的加好友方式
         searchProfileAllowTypeByUserId(row.To_Account, function(allowType) {

            $('#af_allow_type').val(allowType);
            webim.Log.info(allowType);
            if (allowType == null) {
               alert('获取对方加好友设置失败');
               return;
            }
            if (allowType == '拒绝任何人') {
               alert('对方拒绝任何人加好友，无法加对方为好友');
               return;
            }

            if (allowType == '允许任何人') {
               applyAddFriend();
            } else {
               $("#af_add_wording").val('你好，我想和你成为朋友~~');
               $('#add_friend_dialog').modal('show');
            }
         }, function(errmsg) {
            alert(errmsg);
         });

      }
   };
   //初始化搜索用户表格

   function initSearchProfileTable(data) {
      $('#search_profile_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
            field: "To_Account",
            title: "账号",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Nick",
            title: "昵称",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "Gender",
            title: "性别",
            align: "center",
            valign: "middle",
            sortable: "true"
         }, {
            field: "AllowType",
            title: "加好友设置",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "Image",
            title: "头像地址",
            align: "center",
            valign: "middle",
            sortable: "true",
            visible: false
         }, {
            field: "spOperate",
            title: "操作",
            align: "center",
            valign: "middle",
            formatter: "spOperateFormatter",
            events: "spOperateEvents"
         }],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }
   //搜索用户
   var searchProfileByUserId = function() {

      if ($("#sp_to_account").val().length == 0) {
         alert('请输入用户ID');
         return;
      }

      if (webim.Tool.trimStr($("#sp_to_account").val()).length == 0) {
         alert('您输入的用户ID全是空格,请重新输入');
         return;
      }

      var tag_list = [
         "Tag_Profile_IM_Nick", //昵称
         "Tag_Profile_IM_Gender", //性别
         "Tag_Profile_IM_AllowType", //加好友方式
         "Tag_Profile_IM_Image" //头像
      ];
      var options = {
         'To_Account': [$("#sp_to_account").val()],
         'TagList': tag_list
      };

      webim.getProfilePortrait(
         options,
         function(resp) {
            var data = [];
            if (resp.UserProfileItem && resp.UserProfileItem.length > 0) {
               for (var i in resp.UserProfileItem) {
                  var to_account = resp.UserProfileItem[i].To_Account;
                  var nick = null,
                     gender = null,
                     allowType = null,
                     imageUrl = null;
                  for (var j in resp.UserProfileItem[i].ProfileItem) {
                     switch (resp.UserProfileItem[i].ProfileItem[j].Tag) {
                        case 'Tag_Profile_IM_Nick':
                           nick = resp.UserProfileItem[i].ProfileItem[j].Value;
                           break;
                        case 'Tag_Profile_IM_Gender':
                           switch (resp.UserProfileItem[i].ProfileItem[j].Value) {
                              case 'Gender_Type_Male':
                                 gender = '男';
                                 break;
                              case 'Gender_Type_Female':
                                 gender = '女';
                                 break;
                              case 'Gender_Type_Unknown':
                                 gender = '未知';
                                 break;
                           }
                           break;
                        case 'Tag_Profile_IM_AllowType':
                           switch (resp.UserProfileItem[i].ProfileItem[j].Value) {
                              case 'AllowType_Type_AllowAny':
                                 allowType = '允许任何人';
                                 break;
                              case 'AllowType_Type_NeedConfirm':
                                 allowType = '需要确认';
                                 break;
                              case 'AllowType_Type_DenyAny':
                                 allowType = '拒绝任何人';
                                 break;
                              default:
                                 allowType = '需要确认';
                                 break;
                           }
                           break;
                        case 'Tag_Profile_IM_Image':
                           imageUrl = resp.UserProfileItem[i].ProfileItem[j].Value;
                           break;
                     }
                  }
                  data.push({
                     'To_Account': webim.Tool.formatText2Html(to_account),
                     'Nick': webim.Tool.formatText2Html(nick),
                     'Gender': gender,
                     'AllowType': allowType,
                     'Image': imageUrl
                  });
               }
            }
            $('#search_profile_table').bootstrapTable('load', data);
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //搜索用户的加好友设置项
   var searchProfileAllowTypeByUserId = function(to_account, cbok, cberr) {

      var allowType = '需要确认';
      if (to_account.length == 0) {
         if (cberr) {
            cberr('对方帐号为空');
            return;
         }
      }
      var tag_list = [
         "Tag_Profile_IM_AllowType"
      ];
      var options = {
         'To_Account': [to_account],
         'TagList': tag_list
      };

      webim.getProfilePortrait(
         options,
         function(resp) {
            if (resp.UserProfileItem && resp.UserProfileItem.length > 0) {
               for (var i in resp.UserProfileItem) {
                  for (var j in resp.UserProfileItem[i].ProfileItem) {
                     switch (resp.UserProfileItem[i].ProfileItem[j].Tag) {
                        case 'Tag_Profile_IM_AllowType':
                           switch (resp.UserProfileItem[i].ProfileItem[j].Value) {
                              case 'AllowType_Type_AllowAny':
                                 allowType = '允许任何人';
                                 break;
                              case 'AllowType_Type_NeedConfirm':
                                 allowType = '需要确认';
                                 break;
                              case 'AllowType_Type_DenyAny':
                                 allowType = '拒绝任何人';
                                 break;
                              default:
                                 allowType = '需要确认';
                                 break;
                           }
                           break;
                     }
                  }
               }
            }
            if (cbok) {
               cbok(allowType);
            }
         },
         function(errmsg) {
            if (cberr) {
               cberr(errmsg);
            }
         }
      );

   };

   //设置个人资料
   var setProfilePortrait = function() {

      var image = $("#spp_image").val();

      if ($("#spp_nick").val().length == 0) {
         alert('请输入昵称');
         return;
      }
      if (webim.Tool.trimStr($("#spp_nick").val()).length == 0) {
         alert('您输入的昵称全是空格,请重新输入');
         return;
      }
      var gender = $('input[name="spp_gender_radio"]:checked').val();
      if (!gender) {
         alert('请选择性别');
         return;
      }
      var profile_item = [{
         "Tag": "Tag_Profile_IM_Nick",
         "Value": $("#spp_nick").val()
      }, {
         "Tag": "Tag_Profile_IM_Gender",
         "Value": $('input[name="spp_gender_radio"]:checked').val()
      }, {
         "Tag": "Tag_Profile_IM_AllowType",
         "Value": $('input[name="spp_allow_type_radio"]:checked').val()
      }];
      if (image) { //如果设置了头像URL
         profile_item.push({
            "Tag": "Tag_Profile_IM_Image",
            "Value": image
         });
      }
      var options = {
         'ProfileItem': profile_item
      };

      webim.setProfilePortrait(
         options,
         function(resp) {
            $('#set_profile_portrait_dialog').modal('hide');
            loginInfo.identifierNick = $("#spp_nick").val(); //更新昵称
            document.getElementById("t_my_name").innerHTML = webim.Tool.formatText2Html(loginInfo.identifierNick);
            alert('设置个人资料成功');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };
   //初始化我的最近会话表格
   function initGetRecentContactListTable(data) {
      $('#get_recent_contact_list_table').bootstrapTable({
         method: 'get',
         cache: false,
         height: 500,
         striped: true,
         pagination: true,
         pageSize: pageSize,
         pageNumber: 1,
         pageList: [10, 20, 50, 100],
         search: true,
         showColumns: true,
         clickToSelect: true,
         columns: [{
               field: "SessionType",
               title: "会话类型(英文)",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "SessionTypeZh",
               title: "会话类型",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "SessionId",
               title: "会话ID",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "SessionNick",
               title: "会话昵称",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "SessionImage",
               title: "会话头像",
               align: "center",
               valign: "middle",
               sortable: "true",
               visible: false
            },
            {
               field: "C2cAccount",
               title: "发送者ID",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "C2cNick",
               title: "发送者昵称",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "UnreadMsgCount",
               title: "未读数",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "MsgSeq",
               title: "Seq",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "MsgRandom",
               title: "Random",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "MsgTimeStamp",
               title: "时间",
               align: "center",
               valign: "middle",
               sortable: "true"
            },
            {
               field: "MsgShow",
               title: "内容",
               align: "center",
               valign: "middle",
               sortable: "true"
            }
         ],
         data: data,
         formatNoMatches: function() {
            return '无符合条件的记录';
         }
      });
   }

   //我的最近联系人
   var getRecentContactList = function() {
      initGetRecentContactListTable([]);
      var options = {
         'Count': reqRecentSessCount //最近的会话数
      };
      webim.getRecentContactList(
         options,
         function(resp) {
            var data = [];
            var tempSess, tempSessMap = {}; //临时会话变量
            if (resp.SessionItem && resp.SessionItem.length > 0) {

               for (var i in resp.SessionItem) {
                  var item = resp.SessionItem[i];
                  var type = item.Type; //接口返回的会话类型
                  var sessType, typeZh, sessionId, sessionNick = '',
                     sessionImage = '',
                     senderId = '',
                     senderNick = '';
                  if (type == webim.RECENT_CONTACT_TYPE.C2C) { //私聊
                     typeZh = '私聊';
                     sessType = webim.SESSION_TYPE.C2C; //设置会话类型
                     sessionId = item.To_Account; //会话id，私聊时为好友ID或者系统账号（值为@TIM#SYSTEM，业务可以自己决定是否需要展示），注意：从To_Account获取,

                     if (sessionId == '@TIM#SYSTEM') { //先过滤系统消息，，
                        webim.Log.warn('过滤好友系统消息,sessionId=' + sessionId);
                        continue;
                     }
                     var key = sessType + "_" + sessionId;
                     var c2cInfo = infoMap[key];
                     if (c2cInfo && c2cInfo.name) { //从infoMap获取c2c昵称
                        sessionNick = c2cInfo.name; //会话昵称，私聊时为好友昵称，接口暂不支持返回，需要业务自己获取（前提是用户设置过自己的昵称，通过拉取好友资料接口（支持批量拉取）得到）
                     } else { //没有找到或者没有设置过
                        sessionNick = sessionId; //会话昵称，如果昵称为空，默认将其设成会话id
                     }
                     if (c2cInfo && c2cInfo.image) { //从infoMap获取c2c头像
                        sessionImage = c2cInfo.image; //会话头像，私聊时为好友头像，接口暂不支持返回，需要业务自己获取（前提是用户设置过自己的昵称，通过拉取好友资料接口（支持批量拉取）得到）
                     } else { //没有找到或者没有设置过
                        sessionImage = friendHeadUrl; //会话头像，如果为空，默认将其设置demo自带的头像
                     }
                     senderId = senderNick = ''; //私聊时，这些字段用不到，直接设置为空

                  } else if (type == webim.RECENT_CONTACT_TYPE.GROUP) { //群聊
                     typeZh = '群聊';
                     sessType = webim.SESSION_TYPE.GROUP; //设置会话类型
                     sessionId = item.ToAccount; //会话id，群聊时为群ID，注意：从ToAccount获取
                     sessionNick = item.GroupNick; //会话昵称，群聊时，为群名称，接口一定会返回

                     if (item.GroupImage) { //优先考虑接口返回的群头像
                        sessionImage = item.GroupImage; //会话头像，群聊时，群头像，如果业务设置过群头像（设置群头像请参考wiki文档-设置群资料接口），接口会返回
                     } else { //接口没有返回或者没有设置过群头像，再从infoMap获取群头像
                        var key = sessType + "_" + sessionId;
                        var groupInfo = infoMap[key];
                        if (groupInfo && groupInfo.image) { //
                           sessionImage = groupInfo.image
                        } else { //不存在或者没有设置过，则使用默认头像
                           sessionImage = groupHeadUrl; //会话头像，如果没有设置过群头像，默认将其设置demo自带的头像
                        }
                     }
                     senderId = item.MsgGroupFrom_Account; //群消息的发送者id

                     if (!senderId) { //发送者id为空
                        webim.Log.warn('群消息发送者id为空,senderId=' + senderId + ",groupid=" + sessionId);
                        continue;
                     }
                     if (senderId == '@TIM#SYSTEM') { //先过滤群系统消息，因为接口暂时区分不了是进群还是退群等提示消息，
                        webim.Log.warn('过滤群系统消息,senderId=' + senderId + ",groupid=" + sessionId);
                        continue;
                     }

                     senderNick = item.MsgGroupFromCardName; //优先考虑群成员名片
                     if (!senderNick) { //如果没有设置群成员名片
                        senderNick = item.MsgGroupFromNickName; //再考虑接口是否返回了群成员昵称
                        if (!senderNick) { //如果接口没有返回昵称或者没有设置群昵称，从infoMap获取昵称
                           var key = webim.SESSION_TYPE.C2C + "_" + senderId;
                           var c2cInfo = infoMap[key];
                           if (c2cInfo && c2cInfo.name) {
                              senderNick = c2cInfo.name; //发送者群昵称
                           } else {
                              sessionNick = senderId; //如果昵称为空，默认将其设成发送者id
                           }
                        }
                     }

                  } else {
                     typeZh = '未知类型';
                     sessionId = item.ToAccount; //
                  }

                  if (!sessionId) { //会话id为空
                     webim.Log.warn('会话id为空,sessionId=' + sessionId);
                     continue;
                  }

                  if (sessionId == '@TLS#NOT_FOUND') { //会话id不存在，可能是已经被删除了
                     webim.Log.warn('会话id不存在,sessionId=' + sessionId);
                     continue;
                  }

                  if (sessionNick.length > maxNameLen) { //帐号或昵称过长，截取一部分，出于demo需要，业务可以自己决定
                     sessionNick = sessionNick.substr(0, maxNameLen) + "...";
                  }

                  tempSess = tempSessMap[sessType + "_" + sessionId];
                  if (!tempSess) { //先判断是否存在（用于去重），不存在增加一个
                     tempSessMap[sessType + "_" + sessionId] = true;
                     data.push({
                        SessionType: sessType, //会话类型
                        SessionTypeZh: typeZh, //会话类型中文
                        SessionId: webim.Tool.formatText2Html(sessionId), //会话id
                        SessionNick: webim.Tool.formatText2Html(sessionNick), //会话昵称
                        SessionImage: sessionImage, //会话头像
                        C2cAccount: webim.Tool.formatText2Html(senderId), //发送者id
                        C2cNick: webim.Tool.formatText2Html(senderNick), //发送者昵称
                        UnreadMsgCount: item.UnreadMsgCount, //未读消息数
                        MsgSeq: item.MsgSeq, //消息seq
                        MsgRandom: item.MsgRandom, //消息随机数
                        MsgTimeStamp: webim.Tool.formatTimeStamp(item.MsgTimeStamp), //消息时间戳
                        MsgShow: item.MsgShow //消息内容
                     });
                  }
               }
            }
            $('#get_recent_contact_list_table').bootstrapTable('load', data);
            $('#get_recent_contact_list_dialog').modal('show');
         },
         function(err) {
            alert(err.ErrorInfo);
         }
      );
   };

   //初始化聊天界面左侧最近会话列表
   var initRecentContactList = function(cbOK, cbErr) {

      var options = {
         'Count': reqRecentSessCount //要拉取的最近会话条数
      };
      webim.getRecentContactList(
         options,
         function(resp) {
            console.log(resp)
            var tempSess; //临时会话变量
            var firstSessType; //保存第一个会话类型
            var firstSessId; //保存第一个会话id


            //清空聊天对象列表
            var sessList = document.getElementsByClassName("sesslist")[0];
            sessList.innerHTML = "";
            if (resp.SessionItem && resp.SessionItem.length > 0) { //如果存在最近会话记录

               for (var i in resp.SessionItem) {
                  var item = resp.SessionItem[i];
                  var type = item.Type; //接口返回的会话类型
                  var sessType, typeZh, sessionId, sessionNick = '',
                     sessionImage = '',
                     senderId = '',
                     senderNick = '';
                  if (type == webim.RECENT_CONTACT_TYPE.C2C) { //私聊
                     typeZh = '私聊';
                     sessType = webim.SESSION_TYPE.C2C; //设置会话类型
                     sessionId = item.To_Account; //会话id，私聊时为好友ID或者系统账号（值为@TIM#SYSTEM，业务可以自己决定是否需要展示），注意：从To_Account获取,

                     if (sessionId == '@TIM#SYSTEM') { //先过滤系统消息，，
                        webim.Log.warn('过滤好友系统消息,sessionId=' + sessionId);
                        continue;
                     }
                     var key = sessType + "_" + sessionId;
                     var c2cInfo = infoMap[key];
                     if (c2cInfo && c2cInfo.name) { //从infoMap获取c2c昵称
                        sessionNick = c2cInfo.name; //会话昵称，私聊时为好友昵称，接口暂不支持返回，需要业务自己获取（前提是用户设置过自己的昵称，通过拉取好友资料接口（支持批量拉取）得到）
                     } else { //没有找到或者没有设置过
                        sessionNick = sessionId; //会话昵称，如果昵称为空，默认将其设成会话id
                     }
                     if (c2cInfo && c2cInfo.image) { //从infoMap获取c2c头像
                        sessionImage = c2cInfo.image; //会话头像，私聊时为好友头像，接口暂不支持返回，需要业务自己获取（前提是用户设置过自己的昵称，通过拉取好友资料接口（支持批量拉取）得到）
                     } else { //没有找到或者没有设置过
                        sessionImage = friendHeadUrl; //会话头像，如果为空，默认将其设置demo自带的头像
                     }
                     senderId = senderNick = ''; //私聊时，这些字段用不到，直接设置为空
                  } else if (type == webim.RECENT_CONTACT_TYPE.GROUP) { //群聊
                     typeZh = '群聊';
                     sessType = webim.SESSION_TYPE.GROUP; //设置会话类型
                     sessionId = item.ToAccount; //会话id，群聊时为群ID，注意：从ToAccount获取
                     sessionNick = item.GroupNick; //会话昵称，群聊时，为群名称，接口一定会返回

                     if (item.GroupImage) { //优先考虑接口返回的群头像
                        sessionImage = item.GroupImage; //会话头像，群聊时，群头像，如果业务设置过群头像（设置群头像请参考wiki文档-设置群资料接口），接口会返回
                     } else { //接口没有返回或者没有设置过群头像，再从infoMap获取群头像
                        var key = sessType + "_" + sessionId;
                        var groupInfo = infoMap[key];
                        if (groupInfo && groupInfo.image) { //
                           sessionImage = groupInfo.image
                        } else { //不存在或者没有设置过，则使用默认头像
                           sessionImage = groupHeadUrl; //会话头像，如果没有设置过群头像，默认将其设置demo自带的头像
                        }
                     }
                     senderId = item.MsgGroupFrom_Account; //群消息的发送者id

                     if (!senderId) { //发送者id为空
                        webim.Log.warn('群消息发送者id为空,senderId=' + senderId + ",groupid=" + sessionId);
                        continue;
                     }
                     if (senderId == '@TIM#SYSTEM') { //先过滤群系统消息，因为接口暂时区分不了是进群还是退群等提示消息，
                        webim.Log.warn('过滤群系统消息,senderId=' + senderId + ",groupid=" + sessionId);
                        continue;
                     }

                     senderNick = item.MsgGroupFromCardName; //优先考虑群成员名片
                     if (!senderNick) { //如果没有设置群成员名片
                        senderNick = item.MsgGroupFromNickName; //再考虑接口是否返回了群成员昵称
                        if (!senderNick && !sessionNick) { //如果接口没有返回昵称或者没有设置群昵称，从infoMap获取昵称
                           var key = webim.SESSION_TYPE.C2C + "_" + senderId;
                           var c2cInfo = infoMap[key];
                           if (c2cInfo && c2cInfo.name) {
                              senderNick = c2cInfo.name; //发送者群昵称
                           } else {
                              sessionNick = senderId; //如果昵称为空，默认将其设成发送者id
                           }
                        }
                     }

                  } else {
                     typeZh = '未知类型';
                     sessionId = item.ToAccount; //
                  }
                  if (!sessionId) { //会话id为空
                     webim.Log.warn('会话id为空,sessionId=' + sessionId);
                     continue;
                  }

                  if (sessionId == '@TLS#NOT_FOUND') { //会话id不存在，可能是已经被删除了
                     webim.Log.warn('会话id不存在,sessionId=' + sessionId);
                     continue;
                  }

                  if (sessionNick.length > maxNameLen) { //帐号或昵称过长，截取一部分，出于demo需要，业务可以自己决定
                     sessionNick = sessionNick.substr(0, maxNameLen) + "...";
                  }

                  tempSess = recentSessMap[sessType + "_" + sessionId];
                  if (!tempSess) { //先判断是否存在（用于去重），不存在增加一个

                     if (!firstSessId) {
                        firstSessType = sessType; //记录第一个会话类型
                        firstSessId = sessionId; //记录第一个会话id
                     }
                     recentSessMap[sessType + "_" + sessionId] = {
                        SessionType: sessType, //会话类型
                        SessionId: sessionId, //会话对象id，好友id或者群id
                        SessionNick: sessionNick, //会话昵称，好友昵称或群名称
                        SessionImage: sessionImage, //会话头像，好友头像或者群头像
                        C2cAccount: senderId, //发送者id，群聊时，才有用
                        C2cNick: senderNick, //发送者昵称，群聊时，才有用
                        UnreadMsgCount: item.UnreadMsgCount, //未读消息数,私聊时需要通过webim.syncMsgs(initUnreadMsgCount)获取,参考后面的demo，群聊时不需要。
                        MsgSeq: item.MsgSeq, //消息seq
                        MsgRandom: item.MsgRandom, //消息随机数
                        MsgTimeStamp: webim.Tool.formatTimeStamp(item.MsgTimeStamp), //消息时间戳
                        MsgGroupReadedSeq: item.MsgGroupReadedSeq || 0,
                        MsgShow: item.MsgShow //消息内容,文本消息为原内容，表情消息为[表情],其他类型消息以此类推
                     };

                     //在左侧最近会话列表框中增加一个会话div
                     addSess(sessType, webim.Tool.formatText2Html(sessionId), webim.Tool.formatText2Html(sessionNick), sessionImage, item.UnreadMsgCount, 'sesslist');
                  }

               }
               //清空聊天界面
               document.getElementsByClassName("msgflow")[0].innerHTML = "";

               tempSess = recentSessMap[firstSessType + "_" + firstSessId]; //选中第一个会话
               selType = tempSess.SessionType; //初始化当前聊天类型

               selToID = tempSess.SessionId; //初始化当前聊天对象id

               selSess = webim.MsgStore.sessByTypeId(selType, selToID); //初始化当前会话对象

               setSelSessStyleOn(selToID); //设置当前聊天对象选中样式

               console.debug('herer')
               webim.syncMsgs(initUnreadMsgCount); //初始化最近会话的消息未读数

               if (cbOK) //回调
                  cbOK();

            }

         },
         cbErr
      );
   };

   //初始化最近会话的消息未读数
   function initUnreadMsgCount() {
      var sess;
      var sessMap = webim.MsgStore.sessMap();
      console.error(sessMap)
      for (var i in sessMap) {
         sess = sessMap[i];
         // if (selToID && selToID != sess.id()) { //更新其他聊天对象的未读消息数
         console.error('sess.unread()', sess.unread())
         updateSessDiv(sess.type(), sess.id(), sess.name(), sess.unread());
         // }
      }
   }

   //更新最近会话的未读消息数

   function updateSessDiv(sess_type, to_id, name, unread_msg_count) {
      var badgeDiv = document.getElementById("badgeDiv_" + to_id);
      if (badgeDiv && unread_msg_count > 0) {
         if (unread_msg_count >= 100) {
            unread_msg_count = '99+';
         }
         badgeDiv.innerHTML = "<span>" + unread_msg_count + "</span>";
         badgeDiv.style.display = "block";
      } else if (badgeDiv == null) { //没有找到对应的聊天id
         var headUrl;
         if (sess_type == webim.SESSION_TYPE.C2C) {
            headUrl = friendHeadUrl;
         } else {
            headUrl = groupHeadUrl;
         }
         addSess(sess_type, to_id, name, headUrl, unread_msg_count, 'sesslist');
      }
   }

   //新增一条最近会话

   function addSess(sess_type, to_id, name, face_url, unread_msg_count, sesslist, addPositonType) {
      var sessDivId = "sessDiv_" + to_id;
      var sessDiv = document.getElementById(sessDivId);
      if (sessDiv) { //先判断是否存在会话DIV，已经存在，则不需要增加
         return;
      }
      var sessList = document.getElementsByClassName(sesslist)[0];
      sessDiv = document.createElement("div");
      sessDiv.id = sessDivId;
      //如果当前选中的用户是最后一个用户
      sessDiv.className = "sessinfo";
      //添加单击用户头像事件
      sessDiv.onclick = function() {
         if (sessDiv.className == "sessinfo-sel") return;
         onSelSess(sess_type, to_id);
      };
      var faceImg = document.createElement("img");
      faceImg.id = "faceImg_" + to_id;
      faceImg.className = "face";
      faceImg.src = face_url;

      if (name.length > maxNameLen) { //名称过长，截取一部分
         name = name.substr(0, maxNameLen) + "...";
      }

      var delchat = document.createElement("div");
      delchat.className = 'delChat';
      delchat.innerHTML = '删除会话';
      delchat.onclick = function(e) {
         var selSess = webim.MsgStore.sessByTypeId(sess_type, to_id)
         if (sess_type == 'C2C') {
            sess_type = 1;
            webim.setAutoRead(selSess, true, false)
         } else {
            sess_type = 2;
            webim.groupMsgReaded({
               "GroupId": to_id,
               "MsgReadedSeq": selSess._impl.curMaxMsgSeq
            })
         }
         delChat(sess_type, to_id);
         e.preventDefault()
         e.stopPropagation()
         return false;
      }

      var nameDiv = document.createElement("div");
      nameDiv.id = "nameDiv_" + to_id;
      nameDiv.className = "name";
      nameDiv.innerHTML = name;
      var badgeDiv = document.createElement("div");
      badgeDiv.id = "badgeDiv_" + to_id;
      badgeDiv.className = "badge";
      if (unread_msg_count > 0) {
         if (unread_msg_count >= 100) {
            unread_msg_count = '99+';
         }
         badgeDiv.innerHTML = "<span>" + unread_msg_count + "</span>";
         badgeDiv.style.display = "block";
      }
      sessDiv.appendChild(faceImg);
      sessDiv.appendChild(nameDiv);
      sessDiv.appendChild(badgeDiv);
      sessDiv.appendChild(delchat);
      if (!addPositonType || addPositonType == 'TAIL') {
         sessList.appendChild(sessDiv); //默认插入尾部
      } else if (addPositonType == 'HEAD') {
         sessList.insertBefore(sessDiv); //插入头部
      } else {
         console.log(webim.Log.error('未知addPositonType' + addPositonType));
      }
   }

   //删除会话

   function delChat(sess_type, to_id) {

      var data = {
         'To_Account': to_id,
         'chatType': sess_type
      }
      webim.deleteChat(
         data,
         function(resp) {
            $("#sessDiv_" + to_id).remove();
         }
      );
   }

   //切换好友或群组聊天对象

   function onSelSess(sess_type, to_id) {
      // console.log(recentSessMap[sess_type + '_' + to_id])
      document.getElementById("p_friend_face").src = recentSessMap[sess_type + '_' + to_id].SessionImage;
      document.getElementById("p_friend_name").innerHTML = recentSessMap[sess_type + '_' + to_id].SessionNick;
      sess_type == webim.SESSION_TYPE.GROUP ? document.getElementsByClassName("chatpart-body-r")[0].style.display = 'flex' : document.getElementsByClassName("chatpart-body-r")[0].style.display = 'none';


      if (selToID != null) {

         //将之前选中用户的样式置为未选中样式
         setSelSessStyleOff(selToID);

         //设置之前会话的已读消息标记
         webim.setAutoRead(selSess, false, false);

         //保存当前的消息输入框内容到草稿
         //获取消息内容
         var msgtosend = document.getElementsByClassName("msgedit")[0].value;
         var msgLen = webim.Tool.getStrBytes(msgtosend);
         if (msgLen > 0) {
            webim.Tool.setCookie("tmpmsg_" + selToID, msgtosend, 3600);
         }

         //清空聊天界面
         document.getElementsByClassName("msgflow")[0].innerHTML = "";

         selToID = to_id;
         //设置当前选中用户的样式为选中样式
         setSelSessStyleOn(to_id);

         var tmgmsgtosend = webim.Tool.getCookie("tmpmsg_" + selToID);
         if (tmgmsgtosend) {
            $("#send_msg_text").val(tmgmsgtosend);
         } else {
            $("#send_msg_text").val('');
         }

         bindScrollHistoryEvent.reset();


         var sessMap = webim.MsgStore.sessMap(); //获取到之前已经保存的消息
         var sessCS = webim.SESSION_TYPE.GROUP + selToID;
         if (sessMap && sessMap[sessCS]) { //判断之前是否保存过消息
            selType = webim.SESSION_TYPE.GROUP
            bindScrollHistoryEvent.init();

            function compare(property) {
               return function(a, b) {
                  var value1 = a[property];
                  var value2 = b[property];
                  return value1 - value2;
               }
            }
            var sessMapOld = sessMap[sessCS]._impl.msgs.sort(compare('time'));

            for (var i = 0; i < sessMapOld.length; i++) {
               addMsg(sessMapOld[i]); //显示已经保存的消息
            }
         } else {
            if (sess_type == webim.SESSION_TYPE.GROUP) {
               if (selType == webim.SESSION_TYPE.C2C) {
                  selType = webim.SESSION_TYPE.GROUP;
               }
               selSess = null;
               webim.MsgStore.delSessByTypeId(selType, selToID);

               getLastGroupHistoryMsgs(function(msgList) {
                  getHistoryMsgCallback(msgList);
                  bindScrollHistoryEvent.init();
               }, function(err) {
                  alert(err.ErrorInfo);
               });

            } else {
               if (selType == webim.SESSION_TYPE.GROUP) {
                  selType = webim.SESSION_TYPE.C2C;
               }
               //如果是管理员账号，则为全员推送，没有历史消息
               if (selToID == AdminAcount) {
                  var sess = webim.MsgStore.sessByTypeId(selType, selToID);
                  if (sess && sess.msgs() && sess.msgs().length > 0) {
                     getHistoryMsgCallback(sess.msgs());
                  } else {
                     getLastC2CHistoryMsgs(function(msgList) {
                        getHistoryMsgCallback(msgList);
                        bindScrollHistoryEvent.init();
                     }, function(err) {
                        alert(err.ErrorInfo);
                     });
                  }
                  return;
               }

               //拉取漫游消息
               getLastC2CHistoryMsgs(function(msgList) {
                  getHistoryMsgCallback(msgList);
                  //绑定滚动操作
                  bindScrollHistoryEvent.init();
               }, function(err) {
                  alert(err.ErrorInfo);
               });
            }
         }
      }
   }

   //删除会话

   function deleteSessDiv(sess_type, to_id) {
      var sessDiv = document.getElementById("sessDiv_" + to_id);
      sessDiv && sessDiv.parentNode.removeChild(sessDiv);
   }


   //更新最近会话的名字

   function updateSessNameDiv(sess_type, to_id, newName) {

      var nameDivId = "nameDiv_" + to_id;
      var nameDiv = document.getElementById(nameDivId);
      if (nameDiv) {
         if (newName.length > maxNameLen) { //帐号或昵称过长，截取一部分
            newName = newName.substr(0, maxNameLen) + "...";
         }
         nameDiv.innerHTML = webim.Tool.formatText2Html(newName);
      }
   }

   //更新最近会话的头像

   function updateSessImageDiv(sess_type, to_id, newImageUrl) {
      if (!newImageUrl) {
         return;
      }
      var faceImageId = "faceImg_" + to_id;
      var faceImage = document.getElementById(faceImageId);
      if (faceImage) {
         faceImage.innerHTML = webim.Tool.formatText2Html(newImageUrl);
      }
   }

   function setSelSessStyleOn(newSelToID) {

      var selSessDiv = document.getElementById("sessDiv_" + newSelToID);
      if (selSessDiv) {
         selSessDiv.className = "sessinfo-sel"; //设置当前选中用户的样式为选中样式
      } else {
         webim.Log.warn("不存在selSessDiv: selSessDivId=" + "sessDiv_" + newSelToID);
      }

      var selBadgeDiv = document.getElementById("badgeDiv_" + newSelToID);
      if (selBadgeDiv) {
         selBadgeDiv.style.display = "none";
      } else {
         webim.Log.warn("不存在selBadgeDiv: selBadgeDivId=" + "badgeDiv_" + selToID);
      }
   }

   function setSelSessStyleOff(preSelToId) {
      var preSessDiv = document.getElementById("sessDiv_" + preSelToId);
      if (preSessDiv) {
         preSessDiv.className = "sessinfo"; //将之前选中用户的样式置为未选中样式
      } else {
         webim.Log.warn("不存在preSessDiv: selSessDivId=" + "sessDiv_" + preSelToId);
      }
   }
</script>