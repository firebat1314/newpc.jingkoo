<script src="http://www.jq22.com/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="/js/lib/layer/layer.js"></script>

	<!--
	<table  class="fist" style="left:50%;margin-left:-600px;top: 230px;" width="1200" border="0" cellspacing="0" cellpadding="0" class="table_111" cellspacing="1">
		<tr>
			<th width="86" class="fist_td table-origen"><span>球镜</span><span>柱镜</span></th>
			
			<foreach name="zhujing" item="vo" key="key">
			    <th class="f5"  width="10%">{$key}</th>
			</foreach>
		</tr>
	</table>
	-->
<style type="text/css">
	/*批量下单*/
	.hs_bg{background:#f5f5f5;}
	.table_111{border:1px solid #dcdcdc; border-collapse:collapse;}
	.table_111 td{border:1px solid #dcdcdc;}
	.table_111 .bs_bg{background:#fff;}
	.table_111 .bs_bg:hover{background:#ebebeb !important;}
	.top{padding:20px 0;position: fixed;top: 0;background-color: #fff;z-index: 7;
	width: 1250px;left:50%;margin-left:-625px}
	.top_l{float:left;}
	.top_l_img{float:left;margin-right:20px;}
	.top_l_wzq{float:left;}
	.wzq_p1{font-size:24px;color:#4c4c4c;}
	.gongsmingc{float:left;display:block;padding:2px 5px;background:#fdb0bc;color:#fff;margin-top:2px;}
	.gongsmingc a{color:#fff; text-decoration:none;}
	.wzq_p2{color:#4c4c4c;font-weight:bold;clear:both;padding-top:10px;}
	.wzq_p2 i{color:#ff6a00;}
	.wzq_p2 b{color:#ff6a00;font-size:16px;}
	.xial_1{width:174px;height:20px;line-height:20px;font-size:12px;color:#454545;font-weight:bold;border-radius:5px;}
	.top_r{float:right;}
	.gsc{display:block;width:77px;height:27px;line-height:27px;padding-left:38px;background:url(images/top_r_gwc.png) no-repeat left center;color:#4c4c4c;text-decoration:none;}
	.gsc span{display:block;width:25px;height:25px;float:right;background:#ff4039;border-radius:13px;text-align:center;color:#fff;font-size:14px;font-weight:bold;}
	.top_r_p{height:30px;line-height:30px;margin-top:6px;}
	.top_r_se1{border:1px solid #a8a8a8;border-radius:5px;width:68px;height:30px;margin:0;padding:0 0 0 15px;position:absolute;left:0;top:0;}
	.top_r_in1{width:35px;position:absolute;left:13px;top:5px;border:0;}
	.bottom{overflow:hidden;margin-top:30px;width: 1250px;margin:  20px auto;}
	.bottom_l{float:left;width:1250px;}
	.bottom_ta1{border:1px solid #dcdcdc; border-collapse:collapse; color:#1b1b1b;font-size:16px;font-weight:bold;}
	.bottom_ta1 td{height:48px;line-height:48px;border-bottom:1px solid #dcdcdc}
	.bottom_ta1 i{color:#ff6a00;}
	.bottom_ta1 b{color:#ff6a00;}
	.bottom_r{float:left;width: 155px;height: 48px;position: relative;}
	.bototm_an1{width:155px;height:49.8px;background:#ff6a00;color:#fff;font-size:18px;font-weight:bold;border:0px solid #fff;cursor:pointer;border-radius:0px;font-family:"微软雅黑";margin-left:37px;}
	.br_7{border-radius: 7px;}
	.table_wrapper{margin-top: 174px;position: relative;}
	.num{width: 80px;}
	.fist{position: fixed;top: 174px;z-index: 3;display: none;}
	.fist td{border-left:1px solid #dcdcdc;border-top:1px solid #dcdcdc;border-bottom:1px solid #dcdcdc;}
	.fist td:hover{background:#ebebeb !important;}
	.text_inp{text-align:center}
</style>


<script type="text/javascript">

$(document).ready(function() {
    $('#table_111 tr td').mouseover(function(){
		//$(this).siblings().eq(0).css('background','#fedede');
		$(this).parent().find("td").eq(0).css('background','#ebebeb');
		//$(this).parent().siblings().eq(0).children().eq($(this).index()).css('background','#fedede');
		$(this).parent().parent().children().eq(0).children().eq($(this).index()).css('background','#ebebeb');
		$(".fist_td").eq($(this).index()).css('background','#ebebeb');
	});
	$('#table_111 tr td').mouseout(function(){
		/*
		console.log($(this).siblings().eq(0).css('background'));
		$(this).siblings().eq(0).css('background','#f5f5f5');
		$(this).parent().siblings().eq(0).children().eq($(this).index()).css('background','#f5f5f5');
		*/
		$(this).parent().find("td").eq(0).css('background','#f5f5f5');
		$(this).parent().parent().children().eq(0).children().eq($(this).index()).css('background','#f5f5f5');
		$(".fist_td").eq($(this).index()).css('background','#f5f5f5');
	});
});
var num_s=1;
var count=0;
var old_num=0;
var shop_price={$goods.shop_price};
var count_price=0;

var is_zhouwei ="{$goods.zhouwei}";
//
if("{$goods.is_promote}"){
	var shop_price={$goods.shop_price};
}else{
	//var shop_price={$goods.rank_price};
}
//alert(shop_price);
</script>
<div class="bulk-order-main">
    <div class="bulk-order-head">
        <div class="order-head-img">
            <img src="{$imgurl}{$goods.goods_thumb}" alt="">    
        </div>
        <h2>{$goods.goods_name}</h2>
	<if condition="$goods.promote">
                <if condition="$goods.market_price"><p>建议零售价格：<span>{$goods.market_price}</span></p></if>
                <p>批发价：<span style="font-size: 16px;">{$goods.promote}</span></p>
	<else />
	        <if condition="$goods.market_price"><p>建议零售价格：<span>{$goods.market_price}</span></p></if>
                <p>批发价：<span style="font-size: 16px;">{$goods.shop_price_formated}（原批发价：{$goods.old_shop_price}，镜库补贴：{$goods.subsidy_price}）</span></p>
	</if>
	</p>
        <div class="bulk-order-car">购物车<span>９</span>件</div>
	<table style="float:right;/*position: absolute;*/right:0;bottom:0;">
		<tr>
			<foreachs name="specification" item="spec" key="key" keys="keys">
				<td class="attr_val" data-ids="{$key}" style="padding-left:10px;    min-width: 50px;">{$spec.name}：</td>
				<td>
					<select class="br_7 spec_{$key}" name="spec_{$key}" id="{$keys}" data-id="{$key}">
					<foreach name="spec[values]" item="value">
						<option label="{$key}" value="{$value.id}">{$value.label}</option>
					</foreach>
					</select>
				</td>
			</foreachs>
		</tr>
	</table>
    </div>
    <div class="bulk-order-table">
        <table class="bulk-table table_111" width="100%" border="0" cellpadding="0" cellspacing="1">
            <tbody>
                <tr>
                    <th class="f5 table-origen" width="10%"><span>球镜</span><span>柱镜</span></th>
		    <foreach name="zhujing" item="vo" key="key">
                    <th class="f5"  width="10%">{$key}</th>
		    </foreach>
                </tr>
		<foreachs name="qzjing" item="zhus" key="key" keys="keys">
			<tr class="td_inp">
			    <td class="f5 hs_bg"  width="10%" align="center" data-val="{$key}">{$key}</td>
			    <foreachs name="zhus" item="zhu" key="k" keys="ks">
			    <td width="10%" align="center" class="bs_bg" data-id="tr{$keys}_{$ks}" data-zhu="{$zhu}" style="<if condition="$zhu eq null">background:#ccc;</if>"  <if condition="$zhu eq null">name="desa"<else /> name="tr{$keys}_{$ks}"</if>>&nbsp;</td>
			    </foreachs>
			</tr>
		</foreachs>
            </tbody>
        </table>
    </div>
    <div class="bulk-order-total">
        <p>小计： <span class="count_num">0</span>件/<span>￥<font class="count_pic">0</font> </span></p>
        <button class="add_to_cart" data-id="{$goods.goods_id}">加入购物车</button>
	<input type="hidden" class="shop_price" name="shop_price" value="">
    </div>
    <div class="bulk-order-ano-table">
        <table width="100%">
                <tr>
                    <th width="135">数量</th>
                    <th width="250">球镜</th>
                    <th width="250">柱镜</th>
		    <if condition="$goods.zhouwei eq 1">
                    <th width="250">轴位</th>
		    </if>
			<foreach name="specification" item="spec">
			<td align="center">{$spec.name}</td>
			</foreach>
                    <th width="250">价格</th>
                    <th width="135">操作</th>
                </tr>
            <tbody id="order">
            </tbody>
        </table>
    </div>
</div>
<script>
(function(){
	var domSel = $('.sel'),
		domNum = $('.num'),
		cell = $('#table_111 td'),
		row  = $('#table_111 tr'),
		_tmp = {},
		order = $('#order'),
		params = null;
	tpl = '<tr id="tr$ids" class="attr_lists">' +
		'<td align="center" id="$ids" class="nums">$num$</td>' +
		'<td align="center" class="qiujing">$ball$</td>' +
		'<td align="center" class="zhujing">$pillars$</td>';
	if(is_zhouwei == 1){
		tpl+='<td align="center"><input type="text" class="zhouwei" style="    width: 31px;"></td>';
	}
	row.each(function(i){
		this.setAttribute('index', i);
		$(this).find('td').each(function(i){
			this.setAttribute('index', i);
		});
	});

	var selTd = function(start, end , tdis){
		var minX = start.x, minY = start.y, maxX = end.x, maxY = end.y;
		if(start.x < end.x){
			minX = start.x;
			maxX = end.x;
		}else if(start.x > end.x){
			minX = end.x;
			maxX = start.x;
		}
		if(start.y < end.y){
			minY = start.y;
			maxY = end.y;
		}else if(start.y > end.y){
			minY = end.y;
			maxY = start.y;
		}
		if(parseInt(num_s) == 0 ||  isNaN(parseInt(num_s))){
			return;
		}
		var tr_html='';
		var tr_val='';
		$(".attr_val").each(function (){
			tr_val=$(".spec_"+$(this).attr("data-ids")).find("option:selected").text();
			tr_val_id=$(".spec_"+$(this).attr("data-ids")).find("option:selected").val();
			tr_html+='<td align="center" class="str_attr"> <input type="hidden" value="'+tr_val_id+'">'+tr_val+'</td>';
		});
		tr_html+='<td align="center" class="picc">$pic$</td>';
		delTd();
		var firstCell = row.first().find('td'), html = [];
		for(var j=minY; j<=maxY; j++){
			
			var tr = row.eq(j), ball = tr.find('td').first().attr('data-val') || '0.00';
			for(var i=minX; i<=maxX; i++){
				var pillars = firstCell.eq(i).attr('data-val') || '0.00';
				_tmp[j+'-'+i] = $('td', tr).eq(i);
				var id_dea=$('td', tr).eq(i).attr('name');
				if(id_dea == 'desa'){
					return;
				}
				//$('td', tr).eq(i).css('background-color', '#aaa').html(domNum.val());
				$('td', tr).eq(i).css('background-color', '#ffecb6').html(num_s);
				tdis=$('td', tr).eq(i).attr('data-id');
				var list_picc=shop_price * num_s;
				html.push(
					tpl.replace('$ball$', ball)
						.replace('$ids', tdis)
						.replace('$ids', tdis)
						.replace('$pillars$', pillars)
						.replace('$num$', num_s)+tr_html.replace('$pic$', list_picc.toFixed(2))+"<td align='center'><a href='javascript:;' class='del_td' data-val='"+tdis+"'>删除</a></td></tr>"
				);
			}
		}
		//alert(html.length);
		//alert(count);
		//html.push(order.html());
		order.html(html.join(''));
		$(".sel").attr("checked",false);
		$('#table_111').off('mousedown', downEvent);
		$(".top_r_p").remove();
		$(".num").val(0);
		//count=html.length*num_s;
		///count_price+=shop_price * count;
		//$(".count_num").text( html.length*num_s);
		//$(".count_pic").text(count_price);
		update_cart_num();
	}
	var delTd = function(){
		for(var key in _tmp){
			var id_dea=_tmp[key].attr('name');
			if(id_dea == 'desa'){
				_tmp[key].css('background-color', '#ccc').html('');
			}else{
				_tmp[key].css('background-color', '').html('');
			}
		}
		_tmp = {};
		order.html('');
	}
	var downEvent = function(e){
		var _this = this;
		delTd();
		if(e.target.className == 'bs_bg'){
			params = {
				x: e.target.getAttribute('index') * 1,
				y: e.target.parentNode.getAttribute('index') * 1
			}

			cell.on('mouseenter', enterEvent);
			$(document).on('mousemove', moveEvent);
			$(document).on('mouseup', endEvent);
		}
	},
	moveEvent = function(e){
		e.preventDefault();
	},
	enterEvent = function(e){
		e.preventDefault();
		if(this.className != 'bs_bg'){
			return;
		}
		
		var index = {
				x: e.target.getAttribute('index') * 1,
				y: e.target.parentNode.getAttribute('index') * 1
			}
		var tdis=$(this).attr("data-id");
		selTd(params, index , tdis);
		//document.write(tdis);
	},
	endEvent = function(e){
		$(cell).off('mouseenter', enterEvent);
		$(document).off('mousemove', moveEvent);
		$(document).off('mouseup', endEvent);
		ajax_change_num_pic();
		update_cart_num();
	}
	domSel.on('change', function(){
		if(this.checked){
			$('#table_111').on('mousedown', downEvent);
		}else{
			$('#table_111').off('mousedown', downEvent);
		}
	})
})();
function ajax_change_num_pic(){
	//alert(123);
}
function addToCartResponse(result){
	if (result.error > 0){
		// 如果需要缺货登记，跳转
		if (result.error == 2){
			layer.alert('对不起，该商品库存不足');
		}
		//没选规格，弹出属性选择框
		else if (result.error == 6){
			openSpeDiv(result.message, result.goods_id, result.parent);
		}
		else{
			layer.alert(result.message);
		}
	}
	else{
		var cartInfo = document.getElementById('ECS_CARTINFO');
		var cart_url = 'flow.php?step=cart';
		if (cartInfo){
			cartInfo.innerHTML = result.content;
		}

		if (result.carttype == '1'){
			location.href = 'flow.php?step=checkout';
			return ;
		}

		if (result.one_step_buy == '1'){
			location.href = cart_url;
		}
		else{
			switch(result.confirm_type){
			case '1' :
				if (confirm(result.message)) location.href = cart_url;
				break;
			case '2' :
				if (!confirm(result.message)) location.href = cart_url;
				break;
			case '3' :
				layer.alert('商品信息成功加入购物车！');
				setTimeout('location.href="batch.php?id='+result.idx+'"', 2000);
				//location.href = 'goods.php?id='+result.idx;
				break;
			default :
				break;
			}
		}
	}
}

function update_cart_num(){
	var int_counts=0;
	var members=0;
	var picc=0;
	$(".attr_lists").each(function (){
		members=$(this).find(".nums").text();
		if(isNaN(members) ||  isNaN(parseInt(members))){
			members=0;
		}
		picc+=parseFloat(shop_price)*parseInt(members);
		

		//console.log(picc);
		int_counts=parseInt(int_counts)+parseInt(members);
	});
	count=int_counts;
	$(".count_num").text(int_counts);
	$(".count_pic").text(picc.toFixed(2));
}
</script>


<script type="text/javascript">
<!--
	$(function (){
		$("#nums").change(function (){
			$("input[name=box]").val($(this).val());
		});
		$(".num").change(function (){
			var index=$(this).val();
			if(parseInt(index) == 0 ||  isNaN(parseInt(index))){
				return;
			}
			num_s=index;
		});
		$(".td_inp td").live("click",function (){
			if($(this).attr("name") == 'desa' || !$(this).hasClass("bs_bg")){
				return;
			}
			
			var wd=$(this).width();
			var hr=$(this).height();
			$(this).css("width",wd);
			$(this).css("height",hr);
			var numss = "<input type='text' class='text_inp' style='width:"+(wd-4)+"px;height:"+(hr-3)+"px' value="+$(this).text()+">";
			$(this).html(numss);
			$(this).find("input").focus();
		});
		
		$(".text_inp").live("blur",function (){
			var  nums = $(this).val();
			if(isNaN(parseInt(nums))){
				nums = '';
			}
			var qiu = $(this).parent().parent().find("td").eq(0).text();
			var zhu = $(this).parent().attr("data-zhu");
			var goodsId = $('.add_to_cart').attr("data-id");
			var arr_spec = new Array();//属性
			
			
			/*$.post("batch.php",{step:"changeprice",id:goodsId,qiu:qiu,zhu:zhu}, function(data){
				$("input[name=shop_price]").val(data.data.price);
			}, 'json');*/

			var spec = new Array();//属性
			$(".attr_val").each(function (){
				tr_val_id = $(".spec_" + $(this).attr("data-ids")).find("option:selected").val();
				spec.push(tr_val_id);
				console.log(tr_val_id);
			});

			var arr,reg=new RegExp("(^| )token=([^;]*)(;|$)");
			arr = document.cookie.match(reg);
			var token = arr[2];
			$.ajax({
				url : "{:U('batch_changeprice')}",
				type : "POST",
				dataType : "json",
				async:false,
				data : {'id': goodsId,'qiu':qiu,'zhu':zhu, spc : spec, token : token},	
				success : function(data){
					$("input[name=shop_price]").val(data.data.price);
				}
			});

			var pic_count;
			var price = $("input[name=shop_price]").val();

			var data_id = $(this).parent().attr("data-id");
			if($("#tr" + data_id).length == 0){
				var html =  '';
				if(nums != ''){
					html = '<tr id="tr' + data_id + '" class="attr_lists"><td align="center" id="' + data_id + '" class="nums">' + nums + '</td>';
					html += '<td align="center" class="qiujing">' + $(this).parent().parent().find("td").eq(0).text() + '</td>';
					
					html += '<td align="center" class="zhujing">' + $(this).parent().attr("data-zhu") + '</td>';
					if(is_zhouwei == 1){
						html += '<td align="center"><input type="text" class="zhouwei" style="    width: 31px;"></td>';
					}
					$(".attr_val").each(function (){
						tr_val = $(".spec_" + $(this).attr("data-ids")).find("option:selected").text();
						tr_val_id = $(".spec_" + $(this).attr("data-ids")).find("option:selected").val();
						html += '<td align="center" class="str_attr"><input type="hidden" value="' + tr_val_id + '">' + tr_val + '</td>';
					});
					pic_count = nums * price;
					html += '<td align="center" class="">'+pic_count.toFixed(2)+'</td>';
					html += '<td align="center"><a href="javascript:;" class="del_td" data-val="' + data_id + '">删除</a></td></tr>';
				}
				$("#order").append(html);
			}
			var tr_id = $(this).parent().attr("data-id");
			$("#"+tr_id).text(nums);//toFixed(2)
			pic_count = parseFloat(shop_price) * parseInt(nums);
			$("#"+tr_id).parent().find(".picc").text(pic_count.toFixed(2));
			$(this).parent().css('background',nums == '' ? "":'#ffecb6');
			$(this).parent().text(nums);
			if(nums == '' || ~~nums <= 0){
				$("#"+tr_id).parent(".attr_lists").remove();
			}
			update_cart_num();
		});
		//加入购物车
		$(".add_to_cart").live("click",function (){
			if(count == 0 || $(".attr_lists").length == 0){
				layer.msg("请选择下单商品");
				return;
			}
			var is_true=false;
			var i=1;
			var munber= new Array();//数量
			var zhujing= new Array();//柱镜
			var qiujing= new Array();//球镜
			var arr_spec = new Array();//属性
			var zhouwei = new Array();//属性
			$(".attr_lists").each(function (){
				munber[i]	=	$(this).find(".nums").text();
				if (munber[i] == 0 || isNaN(parseInt(munber[i]))){
					is_true = true;
					return false;
				}
				zhujing[i]	=	$(this).find(".zhujing").text();
				qiujing[i]	=	$(this).find(".qiujing").text();
				zhouwei[i]	=	$(this).find(".zhouwei").val();
				var spec = new Array();//属性
				$(this).find(".str_attr").each(function (){
					spec.push($(this).find("input").val());
				})
				arr_spec[i]=spec;
				i++;
			});
			if(is_true){
				layer.msg('数量参数错误！');
				return false;
			}
			//属性构建完成
			var goods        = new Object();
			goods.quick    = 1;
			goods.goods_id = $(this).attr("data-id");
			
			goods.member	= munber;//数量
			goods.spc		= arr_spec;//属性
			goods.qiujing	= qiujing;//球镜
			goods.zhujing	= zhujing;//柱镜
			goods.zhouwei	= zhouwei;//轴位
			goods.parent	= 0;
			goods.carttype	= 0;
			console.log(goods);
			console.log(document.cookie);
			var arr,reg=new RegExp("(^| )token=([^;]*)(;|$)");
			arr = document.cookie.match(reg);
			var token = arr[2];
			var layer_index=layer.msg('加载中', {icon: 16});
			$.post("{:U('add_to_cart_spec_jp')}",{goods_id:goods.goods_id , goods:JSON.stringify(goods), t:Math.random(), token : token}, function(data){
				layer.close(layer_index);
				addToCartResponse(data);
			}, 'json');
		});
		$(".text_inp").live("keydown",function (){
			var k_code=event.keyCode;
			if(k_code == 38 || k_code == 40 ||　k_code == 39 || k_code == 37){
				var w_index=$(this).parent().index();//横向
				var h_index=$(this).parent().parent().index();//纵向
				switch(k_code){
					case 38:
						h_index+=1;
					break;
					case 40:
						h_index+=3;
					break;
					case 39:
						h_index+=2;
						w_index+=1;
					break;
					case 37:
						h_index+=2;
						w_index-=1;
					break;
				}
				if(w_index == 0){
					w_index-=1;
				}
				$("tr").eq(h_index).find("td").eq(w_index).trigger("click");
				return false;
			}
		});
		$(".del_td").live("click",function (){
			var ids=$(this).attr("data-val");
			$("td:[name="+ids+']').text('').css('background','');
			$(this).parent().parent().remove();
			update_cart_num();
		});
		$(window).scroll(function (){
			var index=$(document).scrollTop();
			if(index > 1){
				$(".fist").show();
			}else{
				$(".fist").hide();
			}
			//$(".gwc_sum").text(index);
		});
	});
//-->
</script>